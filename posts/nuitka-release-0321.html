<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
    <link rel="icon" href="../_static/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="../_static/favicon.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../_static/favicon.ico" sizes="32x32" type="image/x-icon">
    <link rel="icon" href="../_static/apple-touch-icon-iphone.png" sizes="57x57" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad.png" sizes="72x72" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-iphone4.png" sizes="114x114" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad3.png" sizes="144x144" type="image/png">
    <link rel="apple-touch-icon" href="../_static/apple-touch-icon-180x180.png" sizes="180x180" type="image/png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nuitka Release 0.3.21</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.59c74d8c95b765a7fd995ac71d459ebe.min.css" type="text/css" />
    <link rel="canonical" href="https://nuitka.net/posts/nuitka-release-0321.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/design-tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />   
<link
  rel="alternate"
  type="application/atom+xml"
  href="../blog/atom.xml"
  title="Nuitka Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Nuitka the Python Compiler
            <img src="../_static/Nuitka-Logo-Symbol.svg" class="logo" alt="Logo"/>
          </a><!-- Empty override file take the place of searchbox.html, which generates search box. -->
<intl>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <nav class="w3-dropdown-hover">
        <button class="w3-button">intl</button>
        <ul class="w3-dropdown-content w3-bar-block w3-card-4">
            <li>
                <a href="https://nuitka.net/">Home</a>
            </li>
            <li>
                <a href="https://nuitka.net/zh_CN/">zh_CN</a>
            </li>
        </ul>
        <div >
    </nav>
<intl>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/user-manual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Commercial Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/commercial.html">Nuitka Commercial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html">Nuitka Release 0.6.20 (Draft)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#nuitka-release-0-6-19">Nuitka Release 0.6.19</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#nuitka-release-0-6-18">Nuitka Release 0.6.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/Changelog.html#older-releases">Older Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/roadmap.html">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/developer-manual.html">Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/api-doc.html">API doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc/factory.html">Factory Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Media</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/Presentations.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/Streaming.html">Streaming</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/Credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/impressum.html">Impressum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Under construction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../doc/welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/pyside2.html">Nuitka PySide2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/donations.html">Donations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/gsoc2019.html">Google Summer of Code 2019</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nuitka the Python Compiler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!-- Empty override file take the place of sphinx_rtd_theme/breadcrumbs.html, which generates the top nav breadcrumbs. -->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
              <section id="nuitka-release-0-3-21">
<h1>Nuitka Release 0.3.21<a class="headerlink" href="#nuitka-release-0-3-21" title="Permalink to this headline"></a></h1>
<p>This is to inform you about the new stable release of <a class="reference external" href="https://nuitka.net">Nuitka</a>. It is the extremely compatible Python compiler,
<a class="reference external" href="/doc/download.html">“download now”</a>.</p>
<p>This releases contains some really major enhancements, all heading
towards enabling value propagation inside Nuitka. Assignments of all
forms are now all simple and explicit, and as a result, now it will be
easy to start tracking them.</p>
<p>Contractions have become functions internally, with statements use
temporary variables, complex unpacking statement were reduced to more
simple ones, etc.</p>
<p>Also there are the usual few small bug fixes, and a bunch of
organisational improvements, that make the release complete.</p>
<section id="bug-fixes">
<h2>Bug fixes<a class="headerlink" href="#bug-fixes" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>The built-in <code class="docutils literal notranslate"><span class="pre">next</span></code> could causes a program crash when iterating
past the end of an iterator. Fixed in 0.3.20.1 already.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">set</span></code> constants could cause a compiler error, as that type was
not considered in the “mutable” check yet. Fixed in 0.3.20.2 already.</p></li>
<li><p>Performance regression. Optimize expression for exception types
caught as well again, this was lost in last release.</p></li>
<li><p>Functions that contain <code class="docutils literal notranslate"><span class="pre">exec</span></code>, are supposed to have a writable
locals. But when removing that <code class="docutils literal notranslate"><span class="pre">exec</span></code> statement as part of
optimization, this property of the function could get lost.</p></li>
<li><p>The so called “overflow functions” are once again correctly handled.
These once were left behind in some refactoring and had not been
repaired until now. An overflow function is a nested function with an
<code class="docutils literal notranslate"><span class="pre">exec</span></code> or a star import.</p></li>
<li><p>The syntax error for <code class="docutils literal notranslate"><span class="pre">return</span></code> outside of a function, was not given,
instead the code returned at run time. Fixed to raise a
<code class="docutils literal notranslate"><span class="pre">SyntaxError</span></code> at compile time.</p></li>
</ul>
</section>
<section id="optimization">
<h2>Optimization<a class="headerlink" href="#optimization" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Avoid <code class="docutils literal notranslate"><span class="pre">tuple</span></code> objects to be created when catching multiple
exception types, instead call exception match check function multiple
times.</p></li>
<li><p>Removal of dead code following <code class="docutils literal notranslate"><span class="pre">break</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, <code class="docutils literal notranslate"><span class="pre">return</span></code>,
and <code class="docutils literal notranslate"><span class="pre">raise</span></code>. Code that follows these statements, or conditional
statements, where all branches end with it.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These may not actually occur often in actual code, but future
optimization may produce them more frequently, and their removal
may in turn make other possible optimization.</p>
</div>
</li>
<li><p>Detect module variables as “read only” after all writes have been
detected to not be executed as removed. Previously the “read only
indicator” was determined only once and then stayed the same.</p></li>
<li><p>Expanded conditional statement optimization to detect cases, where
condition is a compile time constant, not just a constant value.</p></li>
<li><p>Optimize away assignments from a variable to the same variable, they
have no effect. The potential side effect of accessing the variable
is left intact though, so exceptions will be raised still.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>An exception is where <code class="docutils literal notranslate"><span class="pre">len</span> <span class="pre">=</span> <span class="pre">len</span></code> actually does have an impact,
because that variable becomes assignable. The “compile itself”
test of Nuitka found that to happen with <code class="docutils literal notranslate"><span class="pre">long</span></code> from the
<code class="docutils literal notranslate"><span class="pre">nuitka.__past__</span></code> module.</p>
</div>
</li>
<li><p>Created Python3 variant of quick <code class="docutils literal notranslate"><span class="pre">unicode</span></code> string access, there was
no such thing in the CPython C/API, but we make the distinction in
the source code, so it makes sense to have it.</p></li>
<li><p>Created an optimized implementation for the built-in <code class="docutils literal notranslate"><span class="pre">iter</span></code> with 2
parameters as well. This allows for slightly more efficient code to
be created with regards to reference handling, rather than using the
CPython C/API.</p></li>
<li><p>For all types of variable assigned in the generated code, there are
now methods that accept already taken references or not, and the code
generator picks the optimal variant. This avoids the drop of
references, that e.g. the local variable will insist to take.</p></li>
<li><p>Don’t use a “context” object for generator functions (and generator
expressions) that don’t need one. And even if it does to store e.g.
the given parameter values, avoid to have a “common context” if there
is no closure taken. This avoids useless <code class="docutils literal notranslate"><span class="pre">malloc</span></code> calls and speeds
up repeated generator object creation.</p></li>
</ul>
</section>
<section id="organisational">
<h2>Organisational<a class="headerlink" href="#organisational" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Changed the Scons build file database to reside in the build
directory as opposed to the current directory, not polluting it
anymore. Thanks for the patch go to Michael H Kent, very much
appreciated.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">--experimental</span></code> option is no longer available outside of
checkouts of git, and even there not on stable branches (<code class="docutils literal notranslate"><span class="pre">master</span></code>,
<code class="docutils literal notranslate"><span class="pre">hotfix/...</span></code>). It only pollutes <code class="docutils literal notranslate"><span class="pre">--help</span></code> output as stable
releases have no experimental code options, not even development
version will make a difference.</p></li>
<li><p>The binary “bin/Nuitka.py” has been removed from the git repository.
It was deprecated a while ago, not part of the distribution and
served no good use, as it was a symbolic link only anyway.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">--python-version</span></code> option is applied at Nuitka start time to
re-launch Nuitka with the given Python version, to make sure that the
Python run time used for computations and link time Python versions
are the same. The allowed values are now checked (2.6, 2.7 and 3.2)
and the user gets a nice error with wrong values.</p></li>
<li><p>Added <code class="docutils literal notranslate"><span class="pre">--keep-pythonpath</span></code> alias for <code class="docutils literal notranslate"><span class="pre">--execute-with-pythonpath</span></code>
option, probably easier to remember.</p></li>
<li><p>Support <code class="docutils literal notranslate"><span class="pre">--debug</span></code> with clang, so it can also be used to check the
generated code for all warnings, and perform assertions. Didn’t
report anything new.</p></li>
<li><p>The contents environment variable <code class="docutils literal notranslate"><span class="pre">CXX</span></code> determines the default C++
compiler when set, so that checking with <code class="docutils literal notranslate"><span class="pre">CXX=g++-4.7</span> <span class="pre">nuitka-python</span>
<span class="pre">...</span></code> has become supported.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">check-with-pylint</span></code> script now has a real command line option
to control the display of <code class="docutils literal notranslate"><span class="pre">TODO</span></code> items.</p></li>
</ul>
</section>
<section id="cleanups">
<h2>Cleanups<a class="headerlink" href="#cleanups" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Changed complex assignments, i.e. assignments with multiple targets
to such using a temporary variable and multiple simple assignments
instead.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_tmp</span> <span class="o">=</span> <span class="n">c</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">_tmp</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">_tmp</span>
</pre></div>
</div>
<p>In CPython, when one assignment raises an exception, the whole thing
is aborted, so the complexity of having multiple targets is no more
needed, now that we have temporary variables in a block.</p>
<p>All that was really needed, was to evaluate the complete source
expression only once, but that made code generation contain ugly
loops that are no more needed.</p>
</li>
<li><p>Changed unpacking assignments to use temporary variables. Code like
this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</pre></div>
</div>
<p>Is handled more like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_tmp_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="n">_tmp1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_tmp_iter</span><span class="p">)</span>
<span class="n">_tmp2</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_tmp_iter</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">(</span><span class="n">_tmp_iter</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;too many values to unpack&quot;</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">_tmp1</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">_tmp2</span>
</pre></div>
</div>
<p>In reality, not really <code class="docutils literal notranslate"><span class="pre">next</span></code> is used, as it wouldn’t raise the
correct exception for unpacking, and the <code class="docutils literal notranslate"><span class="pre">finished</span></code> check is more
condensed into it.</p>
<p>Generally this cleanup allowed that the <code class="docutils literal notranslate"><span class="pre">AssignTargetTuple</span></code> and
associated code generation was removed, and in the future value
propagation may optimize these <code class="docutils literal notranslate"><span class="pre">next</span></code> and <code class="docutils literal notranslate"><span class="pre">iter</span></code> calls away where
possible. At this time, this is not done yet.</p>
</li>
<li><p>Exception handlers assign caught exception value through assignment
statement.</p>
<p>Previously the code generated for assigning from the caught exception
was not considered part of the handler. It now is the first statement
of an exception handler or not present, this way it may be optimized
as well.</p>
</li>
<li><p>Exception handlers now explicitly catch more than one type.</p>
<p>Catching multiple types worked by merits of the created tuple object
working with the Python C/API function called, but that was not
explicit at all. Now every handler has a tuple of exceptions it
catches, which may only be one, or if None, it’s all.</p>
</li>
<li><p>Contractions are now functions as well.</p>
<p>Contractions (list, dict, and set) are now re-formulated as function
bodies that contain for loops and conditional statements. This
allowed to remove a lot of special code that dealt with them and will
make these easier to understand for optimization and value
propagation.</p>
</li>
<li><p>Global is handled during tree building.</p>
<p>Previously the global statement was its own node, which got removed
during the optimization phase in a dedicated early optimization that
applied its effect, and then removed the node.</p>
<p>It was determined, that there is no reason to not immediately apply
the effect of the global variable and take closure variables and add
them to the provider of that <code class="docutils literal notranslate"><span class="pre">global</span></code> statement, allowing to remove
the node class.</p>
</li>
<li><p>Read only module variable detection integrated to constraint
collection.</p>
<p>The detection of read only module variables was so far done as a
separate step, which is no more necessary as the constraint
collection tracks the usages of module variables anyway, so this
separate and slow step could be removed.</p>
</li>
</ul>
</section>
<section id="new-tests">
<h2>New Tests<a class="headerlink" href="#new-tests" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Added test to cover order of calls for complex assignments that
unpack, to see that they make a fresh iterator for each part of a
complex assignment.</p></li>
<li><p>Added test that unpacks in an exception catch. It worked, due to the
generic handling of assignment targets by Nuitka, and I didn’t even
know it can be done, example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">&quot;Unpacking caught exception and unpacked&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
</pre></div>
</div>
<p>Will assign <code class="docutils literal notranslate"><span class="pre">a=1</span></code> and <code class="docutils literal notranslate"><span class="pre">b=2</span></code>.</p>
</li>
<li><p>Added test to cover return statements on module level and class
level, they both must give syntax errors.</p></li>
<li><p>Cover exceptions from accessing unassigned global names.</p></li>
<li><p>Added syntax test to show that star imports do not allow other names
to be imported at the same time as well.</p></li>
<li><p>Python3 is now also running the compile itself test successfully.</p></li>
</ul>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline"></a></h2>
<p>The progress made towards value propagation and type inference is <em>very</em>
significant, and makes those appears as if they are achievable.</p>
</section>
</section>

<div class="section">
    

<div class="section">
  <span style="float: left">
     
    <a href="nuitka-release-0320.html">
      <i class="fa fa-arrow-circle-left"></i> Nuitka Release 0.3.20
    </a>
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
     
    <a href="nuitka-release-0322.html">
      Nuitka Release 0.3.22 <i
        class="fa fa-arrow-circle-right"
      ></i
      >
    </a>
    
  </span>
</div>
  
</div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kay Hayen and Nuitka Contributors.</p>
  </div>

  

<div class='share-button-container'>
    <div class="socialbutton-wrapper">
        <a href="https://twitter.com/share?url=https://nuitka.net/posts/nuitka-release-0321.html&hashtags=nuitka" target="_blank">
            <div class="socialbutton twitter" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="_static/icon-twitter.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="https://www.facebook.com/sharer.php?u=https://nuitka.net/posts/nuitka-release-0321.html&hashtag=%23nuitka"  target="_blank">
            <div class="socialbutton facebook" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="_static/icon-facebook.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="http://www.reddit.com/submit?url=https://nuitka.net/posts/nuitka-release-0321.html" target="_blank">
            <div class="socialbutton reddit">
                <p class="icon">
                    <img src="_static/icon-reddit.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>
    </div>
</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>