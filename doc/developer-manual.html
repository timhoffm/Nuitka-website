<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="Developer Manual of Nuitka with instructions geared to changing it" name="description" />
<meta content="python,compiler,nuitka,developer" name="keywords" />
    <link rel="icon" href="../_static/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="../_static/favicon.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../_static/favicon.ico" sizes="32x32" type="image/x-icon">
    <link rel="icon" href="../_static/apple-touch-icon-iphone.png" sizes="57x57" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad.png" sizes="72x72" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-iphone4.png" sizes="114x114" type="image/png">
    <link rel="icon" href="../_static/apple-touch-icon-ipad3.png" sizes="144x144" type="image/png">
    <link rel="apple-touch-icon" href="../_static/apple-touch-icon-180x180.png" sizes="180x180" type="image/png">

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nuitka Developer Manual</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/design-style.59c74d8c95b765a7fd995ac71d459ebe.min.css" type="text/css" />
    <link rel="canonical" href="https://nuitka.net/doc/developer-manual.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
        <script src="../_static/design-tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API documentation" href="api-doc.html" />
    <link rel="prev" title="Nuitka Roadmap" href="roadmap.html" />   
<link
  rel="alternate"
  type="application/atom+xml"
  href="../blog/atom.xml"
  title="Nuitka Blog"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Nuitka the Python Compiler
            <img src="../_static/Nuitka-Logo-Symbol.svg" class="logo" alt="Logo"/>
          </a><!-- Empty override file take the place of searchbox.html, which generates search box. -->
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="download.html">Download</a></li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/support.html">Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Commercial Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="commercial.html">Nuitka Commercial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Release Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Changelog.html">Nuitka Release 0.6.20 (Draft)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Changelog.html#nuitka-release-0-6-19">Nuitka Release 0.6.19</a></li>
<li class="toctree-l1"><a class="reference internal" href="Changelog.html#nuitka-release-0-6-18">Nuitka Release 0.6.18</a></li>
<li class="toctree-l1"><a class="reference internal" href="Changelog.html#older-releases">Older Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">More documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Developer Manual</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#milestones">Milestones</a></li>
<li class="toctree-l2"><a class="reference internal" href="#version-numbers">Version Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#current-state">Current State</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-the-development-environment-for-nuitka">Setting up the Development Environment for Nuitka</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#visual-studio-code">Visual Studio Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#eclipse-pycharm">Eclipse / PyCharm</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#commit-and-code-hygiene">Commit and Code Hygiene</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coding-rules-python">Coding Rules Python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tool-to-format">Tool to format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#identifiers">Identifiers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-package-names">Module/Package Names</a></li>
<li class="toctree-l3"><a class="reference internal" href="#names-for-context-manages-start-with-with">Names for context manages start with <code class="docutils literal notranslate"><span class="pre">with</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#prefer-list-contractions-over-built-ins">Prefer list contractions over built-ins</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#coding-rules-c">Coding Rules C</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-git-flow-model">The “git flow” model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nuitka-git-github-workflow">Nuitka “git/github” Workflow</a></li>
<li class="toctree-l2"><a class="reference internal" href="#api-documentation-and-guidelines">API Documentation and Guidelines</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#use-of-standard-python-doc-strings">Use of Standard Python <code class="docutils literal notranslate"><span class="pre">__doc__</span></code> Strings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#special-doxygen-anatomy-of-doc">Special <code class="docutils literal notranslate"><span class="pre">doxygen</span></code> Anatomy of <code class="docutils literal notranslate"><span class="pre">__doc__</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#checking-the-source">Checking the Source</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-the-tests">Running the Tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#running-all-tests">Running all Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#basic-tests">Basic Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#syntax-tests">Syntax Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#program-tests">Program Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generated-tests">Generated Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compile-nuitka-with-nuitka">Compile Nuitka with Nuitka</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#internal-plugin-api">Internal/Plugin API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#working-with-the-cpython-suites">Working with the CPython suites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-descriptions">Design Descriptions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#nuitka-logo">Nuitka Logo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#choice-of-the-target-language">Choice of the Target Language</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-of-scons-internally">Use of Scons internally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#locating-modules-and-packages">Locating Modules and Packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hooking-for-module-import-process">Hooking for module <code class="docutils literal notranslate"><span class="pre">import</span></code> process</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supporting-class-of-python3">Supporting <code class="docutils literal notranslate"><span class="pre">__class__</span></code> of Python3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#frame-stack">Frame Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameter-parsing">Parameter Parsing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input">Input</a></li>
<li class="toctree-l4"><a class="reference internal" href="#keyword-dictionary">Keyword dictionary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#argument-tuple">Argument tuple</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ssa-form-for-nuitka">SSA form for Nuitka</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loop-ssa">Loop SSA</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python-slots-in-optimization">Python Slots in Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-slot-idea">Basic Slot Idea</a></li>
<li class="toctree-l4"><a class="reference internal" href="#representation-in-nuitka">Representation in Nuitka</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-c-side">The C side</a></li>
<li class="toctree-l3"><a class="reference internal" href="#built-in-call-optimization">Built-in call optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-generation-towards-c">Code Generation towards C</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exceptions">Exceptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statement-temporary-variables">Statement Temporary Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-variables-storage">Local Variables Storage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exit-targets">Exit Targets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#frames">Frames</a></li>
<li class="toctree-l4"><a class="reference internal" href="#abortive-statements">Abortive Statements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#constant-preparation">Constant Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#language-conversions-to-make-things-simpler">Language Conversions to make things simpler</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-assert-statement">The <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-comparison-chain-expressions">The “comparison chain” expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-execfile-built-in">The <code class="docutils literal notranslate"><span class="pre">execfile</span></code> built-in</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generator-expressions-with-yield">Generator expressions with <code class="docutils literal notranslate"><span class="pre">yield</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#function-decorators">Function Decorators</a></li>
<li class="toctree-l4"><a class="reference internal" href="#functions-nested-arguments">Functions nested arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-place-assignments">In-place Assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-assignments">Complex Assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unpacking-assignments">Unpacking Assignments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#with-statements">With Statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#for-loops">For Loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="#while-loops">While Loops</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exception-handlers">Exception Handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#statement-try-except-with-else">Statement <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> with <code class="docutils literal notranslate"><span class="pre">else</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-creation-python2">Class Creation (Python2)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#class-creation-python3">Class Creation (Python3)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#generator-expressions">Generator Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#list-contractions">List Contractions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#set-contractions">Set Contractions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dictionary-contractions">Dictionary Contractions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#boolean-expressions-and-and-or">Boolean expressions <code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">or</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-calls">Simple Calls</a></li>
<li class="toctree-l4"><a class="reference internal" href="#complex-calls">Complex Calls</a></li>
<li class="toctree-l4"><a class="reference internal" href="#match-statements">Match Statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#print-statements">Print Statements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reformulations-during-optimization">Reformulations during Optimization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#builtin-zip-for-python2">Builtin <code class="docutils literal notranslate"><span class="pre">zip</span></code> for Python2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#builtin-map-for-python2">Builtin <code class="docutils literal notranslate"><span class="pre">map</span></code> for Python2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#builtin-min">Builtin <code class="docutils literal notranslate"><span class="pre">min</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#builtin-max">Builtin <code class="docutils literal notranslate"><span class="pre">max</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#call-to-dir-without-arguments">Call to <code class="docutils literal notranslate"><span class="pre">dir</span></code> without arguments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#calls-to-functions-with-known-signatures">Calls to functions with known signatures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#nodes-that-serve-special-purposes">Nodes that serve special purposes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#try-statements">Try statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="#releases">Releases</a></li>
<li class="toctree-l4"><a class="reference internal" href="#side-effects">Side Effects</a></li>
<li class="toctree-l4"><a class="reference internal" href="#caught-exception-type-value-references">Caught Exception Type/Value References</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hard-module-imports">Hard Module Imports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#locals-dict-update-statement">Locals Dict Update Statement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#optimizing-attribute-lookups-into-method-calls-for-built-ins-types">Optimizing Attribute Lookups into Method Calls for Built-ins types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#plan-to-add-ctypes-support">Plan to add “ctypes” support</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#goals-allowances-to-the-task">Goals/Allowances to the task</a></li>
<li class="toctree-l3"><a class="reference internal" href="#type-inference-the-discussion">Type Inference - The Discussion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#applying-this-to-ctypes">Applying this to “ctypes”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#excursion-to-functions">Excursion to Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#excursion-to-loops">Excursion to Loops</a></li>
<li class="toctree-l3"><a class="reference internal" href="#excursion-to-conditions">Excursion to Conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#excursion-to-return-statements">Excursion to <code class="docutils literal notranslate"><span class="pre">return</span></code> statements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#excursion-to-yield-expressions">Excursion to <code class="docutils literal notranslate"><span class="pre">yield</span></code> expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mixed-types">Mixed Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#back-to-ctypes">Back to “ctypes”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#now-to-the-interface">Now to the interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#discussing-with-examples">Discussing with examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code-generation-impact">Code Generation Impact</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initial-implementation">Initial Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#goal-1-reached">Goal 1 (Reached)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goal-2-reached">Goal 2 (Reached)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goal-3">Goal 3</a></li>
<li class="toctree-l4"><a class="reference internal" href="#goal-4">Goal 4</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#limitations-for-now">Limitations for now</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-make-features-experimental">How to make Features Experimental</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#command-line">Command Line</a></li>
<li class="toctree-l3"><a class="reference internal" href="#in-c-code">In C code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#in-python">In Python</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-to-use-it">When to use it</a></li>
<li class="toctree-l3"><a class="reference internal" href="#when-to-remove-it">When to remove it</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#adding-dependencies-to-nuitka">Adding dependencies to Nuitka</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-runtime-dependency">Adding a Runtime Dependency</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-development-dependency">Adding a Development Dependency</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#idea-bin">Idea Bin</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prongs-of-action">Prongs of Action</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#builtin-optimization">Builtin optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#class-creation-overhead-reduction">Class Creation Overhead Reduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#memory-usage-at-compile-time">Memory Usage at Compile Time</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coverage-testing">Coverage Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#python3-performance">Python3 Performance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#caching-of-python-level-compilation">Caching of Python level compilation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#updates-for-this-manual">Updates for this Manual</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api-doc.html">API doc</a></li>
<li class="toctree-l1"><a class="reference internal" href="factory.html">Factory Instructions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Media</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pages/Presentations.html">Presentations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/Streaming.html">Streaming</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/impressum.html">Impressum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Under construction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/pyside2.html">Nuitka PySide2 support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/donations.html">Donations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pages/gsoc2019.html">Google Summer of Code 2019</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Nuitka the Python Compiler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <!-- Empty override file take the place of sphinx_rtd_theme/breadcrumbs.html, which generates the top nav breadcrumbs. -->
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
              <section id="nuitka-developer-manual">
<h1>Nuitka Developer Manual<a class="headerlink" href="#nuitka-developer-manual" title="Permalink to this headline"></a></h1>
<p>The purpose of this Developer Manual is to present the current design of
Nuitka, the project rules, and the motivations for choices made. It is
intended to be a guide to the source code, and to give explanations that
don’t fit into the source code in comments form.</p>
<p>It should be used as a reference for the process of planning and
documenting decisions we made. Therefore we are e.g. presenting here the
type inference plans before implementing them. And we update them as we
proceed.</p>
<p>It grows out of discussions and presentations made at conferences as
well as private conversations or issue tracker.</p>
<section id="milestones">
<h2>Milestones<a class="headerlink" href="#milestones" title="Permalink to this headline"></a></h2>
<ol class="arabic">
<li><p>Feature parity with CPython, understand all the language construct
and behave absolutely compatible.</p>
<p>Feature parity has been reached for CPython 2.6 and 2.7. We do not
target any older CPython release. For CPython 3.3 up to 3.8 it also
has been reached. We do not target the older and practically unused
CPython 3.0 to 3.2 releases.</p>
<p>This milestone was reached. Dropping support for Python 2.6 and 3.3
is an option, should this prove to be any benefit. Currently it is
not, as it extends the test coverage only.</p>
</li>
<li><p>Create the most efficient native code from this. This means to be
fast with the basic Python object handling.</p>
<p>This milestone was reached, although of course, micro optimizations
to this are happening all the time.</p>
</li>
<li><p>Then do constant propagation, determine as many values and useful
constraints as possible at compile time and create more efficient
code.</p>
<p>This milestone is considered almost reached. We continue to discover
new things, but the infrastructure is there, and these are easy to
add.</p>
</li>
<li><p>Type inference, detect and special case the handling of strings,
integers, lists in the program.</p>
<p>This milestone is considered in progress.</p>
</li>
<li><p>Add interfacing to C code, so Nuitka can turn a <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> binding
into an efficient binding as written with C.</p>
<p>This milestone is planned only.</p>
</li>
<li><p>Add hints module with a useful Python implementation that the
compiler can use to learn about types from the programmer.</p>
<p>This milestone is planned only.</p>
</li>
</ol>
</section>
<section id="version-numbers">
<h2>Version Numbers<a class="headerlink" href="#version-numbers" title="Permalink to this headline"></a></h2>
<p>For Nuitka we use a defensive version numbering system to indicate that
it is not yet ready for everything. We have defined milestones and the
version numbers should express which of these, we consider done.</p>
<ul>
<li><p>So far:</p>
<p>Before milestone 1, we used <code class="docutils literal notranslate"><span class="pre">0.1.x</span></code> version numbers. After reaching
it, we used <code class="docutils literal notranslate"><span class="pre">0.2.x</span></code> version numbers.</p>
<p>Before milestone 2 and 3, we used <code class="docutils literal notranslate"><span class="pre">0.3.x</span></code> version numbers. After
almost reaching 3, and beginning with 4, we use “0.4.x” version
numbers. Due to an interface change, <code class="docutils literal notranslate"><span class="pre">0.5.x</span></code> version numbers are
being used.</p>
<p>Due to reaching type inference in code generation, even if only
starting, the <code class="docutils literal notranslate"><span class="pre">0.6.x</span></code> version numbers were started to be used. This
stage should allow quick progress in performance for individual
releases.</p>
</li>
<li><p>Future:</p>
<p>With <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> bindings in a usable state it will be <code class="docutils literal notranslate"><span class="pre">0.7.x</span></code>.</p>
</li>
<li><p>Final:</p>
<p>We will then round it up and call it Nuitka <code class="docutils literal notranslate"><span class="pre">1.0</span></code> when this works
as expected for a bunch of people. The plan is to reach this goal
during 2021. This is based on positive assumptions that may not hold
up though.</p>
</li>
</ul>
<p>Of course, all of this may be subject to change.</p>
</section>
<section id="current-state">
<h2>Current State<a class="headerlink" href="#current-state" title="Permalink to this headline"></a></h2>
<p>Nuitka top level works like this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.tree.Building</span></code> outputs node tree</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.optimization</span></code> enhances it as best as it can</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.finalization</span></code> prepares the tree for code generation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.codegen.CodeGeneration</span></code> orchestrates the creation of code
snippets</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.codegen.*Codes</span></code> knows how specific code kinds are created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka.MainControl</span></code> keeps it all together</p></li>
</ul>
<p>This design is intended to last.</p>
<p>Regarding types, the state is:</p>
<ul class="simple">
<li><p>Types are always <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>, and only a few C types, e.g.
<code class="docutils literal notranslate"><span class="pre">nuitka_bool</span></code> and <code class="docutils literal notranslate"><span class="pre">nuitka_void</span></code> and more are coming. Even for
objects, often it’s know that things are e.g. really a
<code class="docutils literal notranslate"><span class="pre">PyTupleObject</span> <span class="pre">**</span></code>, but no C type is available for that yet.</p></li>
<li><p>There are a some specific use of types beyond “compile time
constant”, that are encoded in type and value shapes, which can be
used to predict some operations, conditions, etc. if they raise, and
result types they give.</p></li>
<li><p>In code generation, the supported C types are used, and sometimes we
have specialized code generation, e.g. a binary operation that takes
an <code class="docutils literal notranslate"><span class="pre">int</span></code> and a <code class="docutils literal notranslate"><span class="pre">float</span></code> and produces a <code class="docutils literal notranslate"><span class="pre">float</span></code> value. There will
be fallbacks to less specific types.</p></li>
</ul>
<p>The expansion with more C types is currently in progress, and there will
also be alternative C types, where e.g. <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span> <span class="pre">long</span></code>
are in an enum that indicates which value is valid, and where special
code will be available that can avoid creating the <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">**</span></code>
unless the later overflows.</p>
</section>
<section id="setting-up-the-development-environment-for-nuitka">
<h2>Setting up the Development Environment for Nuitka<a class="headerlink" href="#setting-up-the-development-environment-for-nuitka" title="Permalink to this headline"></a></h2>
<p>Currently there are very different kinds of files that we need support
for. This is best addressed with an IDE. We cover here how to setup the
most common one.</p>
<section id="visual-studio-code">
<h3>Visual Studio Code<a class="headerlink" href="#visual-studio-code" title="Permalink to this headline"></a></h3>
<p>Download Visual Studio Code from here:
<a class="reference external" href="https://code.visualstudio.com/download">https://code.visualstudio.com/download</a></p>
<p>At this time, this is the recommended IDE for Linux and Windows. This is
going to cover the plugins to install. Configuration is part of the
<code class="docutils literal notranslate"><span class="pre">.vscode</span></code> in your Nuitka checkout. If you are not familiar with
Eclipse, this is Free Software IDE,designed to be universally extended,
and it truly is. There are plugins available for nearly everything.</p>
<p>The extensions to be installed are part of the Visual Code
recommendations in <code class="docutils literal notranslate"><span class="pre">.vscode/extensions.json</span></code> and you will be prompted
about that and ought to install these.</p>
</section>
<section id="eclipse-pycharm">
<h3>Eclipse / PyCharm<a class="headerlink" href="#eclipse-pycharm" title="Permalink to this headline"></a></h3>
<p>Don’t use these anymore, we consider Visual Studio Code to be far
superior for delivering a nice out of the box environment.</p>
</section>
</section>
<section id="commit-and-code-hygiene">
<h2>Commit and Code Hygiene<a class="headerlink" href="#commit-and-code-hygiene" title="Permalink to this headline"></a></h2>
<p>In Nuitka we have tools to auto format code, you can execute them
manually, but it’s probably best to execute them at commit time, to make
sure when we share code, it’s already well format, and to avoid noise
doing cleanups.</p>
<p>The kinds of changes also often cause unnecessary merge conflicts, while
the auto format is designed to format code also in a way that it avoids
merge conflicts in the normal case, e.g. by doing imports one item per
line.</p>
<p>In order to set up hooks, you need to execute these commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Where python is the one you use with Nuitka, this then gets all</span>
<span class="c1"># development requirements, can be full PATH.</span>
python -m pip install -r requirements-devel.txt
python ./misc/install-git-hooks.py
</pre></div>
</div>
<p>These commands will make sure that the <code class="docutils literal notranslate"><span class="pre">autoformat-nuitka-source</span></code> is
run on every staged file content at the time you do the commit. For C
files, it may complain unavailability of <code class="docutils literal notranslate"><span class="pre">clang-format</span></code>, follow it’s
advice. You may call the above tool at all times, without arguments to
format call Nuitka source code.</p>
<p>Should you encounter problems with applying the changes to the checked
out file, you can always execute it with <code class="docutils literal notranslate"><span class="pre">COMMIT_UNCHECKED=1</span></code>
environment set.</p>
</section>
<section id="coding-rules-python">
<h2>Coding Rules Python<a class="headerlink" href="#coding-rules-python" title="Permalink to this headline"></a></h2>
<p>These rules should generally be adhered when working on Nuitka code.
It’s not library code and it’s optimized for readability, and avoids all
performance optimization for itself.</p>
<section id="tool-to-format">
<h3>Tool to format<a class="headerlink" href="#tool-to-format" title="Permalink to this headline"></a></h3>
<p>There is a tool <code class="docutils literal notranslate"><span class="pre">bin/autoformat-nuitka-source</span></code> which is to apply
automatic formatting to code as much as possible. It uses <code class="docutils literal notranslate"><span class="pre">black</span></code>
(internally) for consistent code formatting. The imports are sorted with
<code class="docutils literal notranslate"><span class="pre">isort</span></code> for proper order.</p>
<p>The tool (mostly <code class="docutils literal notranslate"><span class="pre">black</span></code> and <code class="docutils literal notranslate"><span class="pre">isort</span></code>) encodes all formatting rules,
and makes the decisions for us. The idea being that we can focus on
actual code and do not have to care as much about other things. It also
deals with Windows new lines, trailing space, etc. and even sorts PyLint
disable statements.</p>
</section>
<section id="identifiers">
<h3>Identifiers<a class="headerlink" href="#identifiers" title="Permalink to this headline"></a></h3>
<p>Classes are camel case with leading upper case. Functions and methods
are with leading verb in lower case, but also camel case. Variables and
arguments are lower case with <code class="docutils literal notranslate"><span class="pre">_</span></code> as a separator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeClass</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">doSomething</span><span class="p">(</span><span class="n">some_parameter</span><span class="p">):</span>
        <span class="n">some_var</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Base classes that are abstract have their name end with <code class="docutils literal notranslate"><span class="pre">Base</span></code>, so
that a meta class can use that convention, and readers immediately know,
that it will not be instantiated like that.</p>
<p>Function calls use keyword argument preferably. These are slower in
CPython, but more readable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">getSequenceCreationCode</span><span class="p">(</span>
    <span class="n">sequence_kind</span><span class="o">=</span><span class="n">sequence_kind</span><span class="p">,</span> <span class="n">element_identifiers</span><span class="o">=</span><span class="n">identifiers</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span>
<span class="p">)</span>
</pre></div>
</div>
<p>When the names don’t add much value, sequential calls can be done:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span><span class="o">.</span><span class="n">setLoopContinueTarget</span><span class="p">(</span><span class="n">handler_start_target</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">setLoopContinueTarget</span></code> will be so well known that the reader is
expected to know the argument names and their meaning, but it would be
still better to add them. But in this instance, the variable name
already indicates that it is.</p>
</section>
<section id="module-package-names">
<h3>Module/Package Names<a class="headerlink" href="#module-package-names" title="Permalink to this headline"></a></h3>
<p>Normal modules are named in camel case with leading upper case, because
of their role as singleton classes. The difference between a module and
a class is small enough and in the source code they are also used
similarly.</p>
<p>For the packages, no real code is allowed in their <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and
they must be lower case, like e.g. <code class="docutils literal notranslate"><span class="pre">nuitka</span></code> or <code class="docutils literal notranslate"><span class="pre">codegen</span></code>. This is to
distinguish them from the modules.</p>
<p>Packages shall only be used to group things. In <code class="docutils literal notranslate"><span class="pre">nuitka.codegen</span></code> the
code generation packages are located, while the main interface is
<code class="docutils literal notranslate"><span class="pre">nuitka.codegen.CodeGeneration</span></code> and may then use most of the entries
as local imports.</p>
<p>There is no code in packages themselves. For programs, we use
<code class="docutils literal notranslate"><span class="pre">__main__</span></code> package to carry the actual code.</p>
<p>Names of modules should be plurals if they contain classes. Example is
that a <code class="docutils literal notranslate"><span class="pre">Nodes</span></code> module that contains a <code class="docutils literal notranslate"><span class="pre">Node</span></code> class.</p>
</section>
<section id="names-for-context-manages-start-with-with">
<h3>Names for context manages start with <code class="docutils literal notranslate"><span class="pre">with</span></code><a class="headerlink" href="#names-for-context-manages-start-with-with" title="Permalink to this headline"></a></h3>
<p>In order to easily recognize that something is to be used as a context
manager, we follow a pattern of naming them <code class="docutils literal notranslate"><span class="pre">withSomething</span></code>, to make
that easily recognized.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">withEnvironmentPathAdded</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">prefix</span><span class="p">,</span> <span class="s2">&quot;bin&quot;</span><span class="p">)):</span>
    <span class="k">with</span> <span class="n">withDirectoryChange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qt_datadir</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>This makes these easy to recognize even in their definition.</p>
</section>
<section id="prefer-list-contractions-over-built-ins">
<h3>Prefer list contractions over built-ins<a class="headerlink" href="#prefer-list-contractions-over-built-ins" title="Permalink to this headline"></a></h3>
<p>This concerns <code class="docutils literal notranslate"><span class="pre">map</span></code>, <code class="docutils literal notranslate"><span class="pre">filter</span></code>, and <code class="docutils literal notranslate"><span class="pre">apply</span></code>. Usage of these
built-ins is highly discouraged within Nuitka source code. Using them is
considered worth a warning by “PyLint” e.g. “Used built-in function
‘map’”. We should use list contractions instead, because they are more
readable.</p>
<p>List contractions are a generalization for all of them. We love
readability and with Nuitka as a compiler, there won’t be any
performance difference at all.</p>
<p>There are cases where a list contraction is faster because you can avoid
to make a function call. And there may be cases, where map is faster, if
a function must be called. These calls can be very expensive in CPython,
and if you introduce a function, just for <code class="docutils literal notranslate"><span class="pre">map</span></code>, then it might be
slower.</p>
<p>But of course, Nuitka is the project to free us from what is faster and
to allow us to use what is more readable, so whatever is faster, we
don’t care. We make all options equally fast and let people choose.</p>
<p>For Nuitka the choice is list contractions as these are more easily
changed and readable.</p>
<p>Look at this code examples from Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">A</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">getX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>

    <span class="n">x</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">getX</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">getX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">2</span>


<span class="n">A</span><span class="p">()</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># True</span>
<span class="n">B</span><span class="p">()</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># True (!)</span>
</pre></div>
</div>
<p>This pretty much is what makes properties bad. One would hope <code class="docutils literal notranslate"><span class="pre">B().x</span></code>
to be <code class="docutils literal notranslate"><span class="pre">2</span></code>, but instead it’s not changed. Because of the way properties
take the functions and not members, and because they then are not part
of the class, they cannot be overloaded without re-declaring them.</p>
<p>Overloading is then not at all obvious anymore. Now imagine having a
setter and only overloading the getter. How to update the property
easily?</p>
<p>So, that’s not likable about them. And then we are also for clarity in
these internal APIs too. Properties try and hide the fact that code
needs to run and may do things. So let’s not use them.</p>
<p>For an external API you may exactly want to hide things, but internally
that has no use, and in Nuitka, every API is internal API. One exception
may be the <code class="docutils literal notranslate"><span class="pre">hints</span></code> module, which will gladly use such tricks for an
easier write syntax.</p>
</section>
</section>
<section id="coding-rules-c">
<h2>Coding Rules C<a class="headerlink" href="#coding-rules-c" title="Permalink to this headline"></a></h2>
<p>For the static C parts, e.g. compiled types, helper codes, the
<code class="docutils literal notranslate"><span class="pre">clang-format</span></code> from LLVM project is used, the tool
<code class="docutils literal notranslate"><span class="pre">autoformat-nuitka-source</span></code> does this for us.</p>
<p>We always have blocks for conditional statements to avoid typical
mistakes made by adding a statement to a branch, forgetting to make it a
block.</p>
</section>
<section id="the-git-flow-model">
<h2>The “git flow” model<a class="headerlink" href="#the-git-flow-model" title="Permalink to this headline"></a></h2>
<ul>
<li><p>The flow is used for releases and occasionally subsequent hot fixes.</p>
<p>A few feature branches were used so far. It allows for quick delivery
of fixes to both the stable and the development version, supported by
a git plug-in, that can be installed via “apt-get install git-flow”.</p>
</li>
<li><p>Stable (<code class="docutils literal notranslate"><span class="pre">main</span></code> branch)</p>
<p>The stable version, is expected to pass all the tests at all times
and is fully supported. As soon as bugs are discovered, they are
fixed as hot fixes, and then merged to develop by the “git flow”
automatically.</p>
</li>
<li><p>Development (<code class="docutils literal notranslate"><span class="pre">develop</span></code> branch)</p>
<p>The future release, supposedly in almost ready for release state at
nearly all times, but this is as strict. It is not officially
supported, and may have problems and at times inconsistencies.
Normally this branch is supposed to not be rebased. For severe
problems it may be done though.</p>
</li>
<li><p>Factory (default feature branch)</p>
<p>Code under construction. We publish commits there, that may not hold
up in testing, and before it enters develop branch. Factory may have
severe regressions frequently, and commits become <strong>rebased all the
time</strong>, so do not base your patches on it, please prefer the
<code class="docutils literal notranslate"><span class="pre">develop</span></code> branch for that, unless of course, it’s about factory
code itself.</p>
</li>
<li><p>Personal branches (jorj, orsiris, others as well)</p>
<p>We are currently not using this, but it’s an option.</p>
</li>
<li><p>Feature Branches</p>
<p>We are not currently using these. They could be used for long lived
changes that extend for multiple release cycles and are not ready
yet. Currently we perform all changes in steps that can be included
in releases or delay making those changes.</p>
</li>
</ul>
</section>
<section id="nuitka-git-github-workflow">
<h2>Nuitka “git/github” Workflow<a class="headerlink" href="#nuitka-git-github-workflow" title="Permalink to this headline"></a></h2>
<ul>
<li><p>Forking and cloning</p>
<p>You need to have git installed and GitHub account. Goto Nuitka
repository &lt;<a class="reference external" href="https://github.com/Nuitka/Nuitka">https://github.com/Nuitka/Nuitka</a>&gt; and fork the
repository.</p>
<p>To clone it to your local machine execute the following your git
bash:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git clone https://github.com/your-user-name/Nuitka.git
<span class="nb">cd</span> Nuitka
git remote add upstream https://github.com/Nuitka/Nuitka.git
</pre></div>
</div>
</li>
<li><p>Create a Branch</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git checkout develop
git pull --rebase upstream
git checkout -b feature_branch
</pre></div>
</div>
<p>If you are having merge conflicts while doing the previous step, then
check out (DON’T FORGET TO SAVE YOUR CHANGES FIRST IF ANY):
&lt;<a class="reference external" href="https://stackoverflow.com/questions/1125968/how-do-i-force-git-pull-to-overwrite-local-files">https://stackoverflow.com/questions/1125968/how-do-i-force-git-pull-to-overwrite-local-files</a>&gt;</p>
</li>
<li><p>In case you have an existing branch rebase it to develop</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git fetch upstream
git rebase upstream/develop
</pre></div>
</div>
<p>Fix the merge conflicts if any, stash them and continue:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git rebase --continue
</pre></div>
</div>
<p>If anything goes wrong while rebasing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git rebase --abort
</pre></div>
</div>
</li>
<li><p>Making changes</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git commit -a -m <span class="s2">&quot;Commit Message&quot;</span>
git push -u origin <span class="c1"># once, later always:</span>
git push
</pre></div>
</div>
</li>
</ul>
</section>
<section id="api-documentation-and-guidelines">
<h2>API Documentation and Guidelines<a class="headerlink" href="#api-documentation-and-guidelines" title="Permalink to this headline"></a></h2>
<p>There is API documentation generated with <code class="docutils literal notranslate"><span class="pre">doxygen</span></code>, available at
<a class="reference external" href="https://nuitka.net/apidoc">this location</a> .</p>
<p>To ensure meaningful <code class="docutils literal notranslate"><span class="pre">doxygen</span></code> output, the following guidelines must
be observed when creating or updating Python source:</p>
<section id="use-of-standard-python-doc-strings">
<h3>Use of Standard Python <code class="docutils literal notranslate"><span class="pre">__doc__</span></code> Strings<a class="headerlink" href="#use-of-standard-python-doc-strings" title="Permalink to this headline"></a></h3>
<p>Every class and every method should be documented via the standard
Python delimiters (<code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span> <span class="pre">...</span> <span class="pre">&quot;&quot;&quot;</span></code>) in the usual way.</p>
</section>
<section id="special-doxygen-anatomy-of-doc">
<h3>Special <code class="docutils literal notranslate"><span class="pre">doxygen</span></code> Anatomy of <code class="docutils literal notranslate"><span class="pre">__doc__</span></code><a class="headerlink" href="#special-doxygen-anatomy-of-doc" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are replacing Doxygen with sphinx, this is all obsolete</p>
</div>
<ul>
<li><p>Immediately after the leading <code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span></code>, and after 1 space on the same
line, enter a brief description or title of the class or method. This
must be 1 line and be followed by at least 1 empty line.</p></li>
<li><p>Depending on the item, choose from the following “sections” to
describe what the item is and does.</p>
<p>Each section name is coded on its own line, aligned with the leading
<code class="docutils literal notranslate"><span class="pre">&quot;&quot;&quot;</span></code> and followed by a colon “:”. Anything following the section,
must start on a new line and be indented by 4 spaces relative to the
section. Except for the first section (<code class="docutils literal notranslate"><span class="pre">Notes:</span></code>) after the title,
sections need not be preceded by empty lines – but it is good
practice to still do that.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Notes:</span></code> detailed description of the item, any length.</p>
<p>May contain line breaks with each new line starting aligned with
previous one. The text will automatically be joined across line
breaks and be reformatted in the browser.</p>
<p>If you describe details for a class, you can do so <strong>without</strong>
using this section header and all formatting will still work fine.
If you however omit the <code class="docutils literal notranslate"><span class="pre">Notes:</span></code> for methods, then the text will
be interpreted <strong>as code</strong>, be shown in an ugly monospaced font,
and no automatic line breaks will occur in the browser.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Args:</span></code> positional arguments.</p>
<p>Each argument then follows, starting on a new line and indented by
4 spaces. The argument name must be followed by a colon <code class="docutils literal notranslate"><span class="pre">:</span></code> or
double hash <code class="docutils literal notranslate"><span class="pre">--</span></code>, followed by a description of arbitrary length.</p>
<p>The description can be separated by line breaks.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Kwargs:</span></code> keyword arguments. Same rules as for args.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Returns:</span></code> description of what will be returned if applicable
(any length).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Yields:</span></code> synonymous for <code class="docutils literal notranslate"><span class="pre">Returns:</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Raises:</span></code> name any exceptions that may be raised.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Examples:</span></code> specify any example code.</p></li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">kw1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kw2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is an example method.</span>

<span class="sd">    Notes:</span>
<span class="sd">        It does one or the other indispensable things based on some parameters</span>
<span class="sd">        and proudly returns a dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        p1: parameter one</span>
<span class="sd">        p2: parameter two</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        kw1: keyword one</span>
<span class="sd">        kw2: keyword two</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary calculated from the input.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError, IndexError</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; foo(1, 2, kw1=3, kw2=4)</span>
<span class="sd">        {&#39;a&#39;: 4, &#39;b&#39;: 6}</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="checking-the-source">
<h2>Checking the Source<a class="headerlink" href="#checking-the-source" title="Permalink to this headline"></a></h2>
<p>The static checking for errors is currently done with <code class="docutils literal notranslate"><span class="pre">PyLint</span></code>. In the
future, Nuitka itself will gain the ability to present its findings in a
similar way, but this is not a priority, and we are not there yet.</p>
<p>So, we currently use <code class="docutils literal notranslate"><span class="pre">PyLint</span></code> with options defined in a script.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./bin/check-nuitka-with-pylint
</pre></div>
</div>
<p>The above command is expected to give no warnings. It is also run on our
CI and we will not merge branches that do not pass.</p>
</section>
<section id="running-the-tests">
<h2>Running the Tests<a class="headerlink" href="#running-the-tests" title="Permalink to this headline"></a></h2>
<p>This section describes how to run Nuitka tests.</p>
<section id="running-all-tests">
<h3>Running all Tests<a class="headerlink" href="#running-all-tests" title="Permalink to this headline"></a></h3>
<p>The top level access to the tests is as simple as this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/run-tests
</pre></div>
</div>
<p>For fine grained control, it has the following options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">basic</span><span class="o">-</span><span class="n">tests</span>    <span class="n">The</span> <span class="n">basic</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">Nuitka</span> <span class="ow">is</span>
                      <span class="n">healthy</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">syntax</span><span class="o">-</span><span class="n">tests</span>   <span class="n">The</span> <span class="n">syntax</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">Nuitka</span>
                      <span class="n">handles</span> <span class="n">Syntax</span> <span class="n">errors</span> <span class="n">fine</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">program</span><span class="o">-</span><span class="n">tests</span>  <span class="n">The</span> <span class="n">programs</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">Nuitka</span>
                      <span class="n">handles</span> <span class="n">programs</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="kn">import</span> <span class="nn">recursions</span><span class="o">,</span> <span class="nn">etc.</span> <span class="n">fine</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">package</span><span class="o">-</span><span class="n">tests</span>  <span class="n">The</span> <span class="n">packages</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">Nuitka</span>
                      <span class="n">handles</span> <span class="n">packages</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="kn">import</span> <span class="nn">recursions</span><span class="o">,</span> <span class="nn">etc.</span> <span class="n">fine</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">optimizations</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">optimization</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span>
                      <span class="n">Nuitka</span> <span class="n">does</span> <span class="n">optimize</span> <span class="n">certain</span> <span class="n">constructs</span> <span class="n">fully</span> <span class="n">away</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">standalone</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standalone</span> <span class="n">tests</span><span class="p">,</span> <span class="n">execute</span> <span class="n">these</span> <span class="n">to</span> <span class="n">check</span> <span class="k">if</span> <span class="n">Nuitka</span>
                      <span class="n">standalone</span> <span class="n">mode</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="ow">not</span> <span class="n">referring</span> <span class="n">to</span> <span class="n">outside</span><span class="p">,</span>
                      <span class="n">important</span> <span class="mi">3</span><span class="n">rd</span> <span class="n">library</span> <span class="n">packages</span> <span class="n">like</span> <span class="n">PyQt</span> <span class="n">fine</span><span class="o">.</span> <span class="n">Default</span>
                      <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">reflection</span><span class="o">-</span><span class="n">test</span>
                      <span class="n">The</span> <span class="n">reflection</span> <span class="n">test</span> <span class="n">compiles</span> <span class="n">Nuitka</span> <span class="k">with</span> <span class="n">Nuitka</span><span class="p">,</span> <span class="ow">and</span>
                      <span class="n">then</span> <span class="n">Nuitka</span> <span class="k">with</span> <span class="n">the</span> <span class="nb">compile</span> <span class="n">Nuitka</span> <span class="ow">and</span> <span class="n">compares</span> <span class="n">the</span>
                      <span class="n">outputs</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython26</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython2</span><span class="mf">.6</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.7</span> <span class="n">this</span>
                      <span class="n">covers</span> <span class="n">exception</span> <span class="n">behavior</span> <span class="n">quite</span> <span class="n">well</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython27</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython2</span><span class="mf">.7</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.6</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython32</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.2</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.6</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython33</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.3</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython34</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.4</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython35</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.5</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython36</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.6</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython37</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.7</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython38</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.8</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython39</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.9</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">cpython310</span><span class="o">-</span><span class="n">tests</span>
                      <span class="n">The</span> <span class="n">standard</span> <span class="n">CPython3</span><span class="mf">.10</span> <span class="n">test</span> <span class="n">suite</span><span class="o">.</span> <span class="n">Execute</span> <span class="n">this</span> <span class="k">for</span>
                      <span class="nb">all</span> <span class="n">corner</span> <span class="n">cases</span> <span class="n">to</span> <span class="n">be</span> <span class="n">covered</span><span class="o">.</span> <span class="n">With</span> <span class="n">Python</span> <span class="mf">2.</span><span class="n">x</span> <span class="n">these</span>
                      <span class="n">are</span> <span class="ow">not</span> <span class="n">run</span><span class="o">.</span> <span class="n">Default</span> <span class="ow">is</span> <span class="kc">True</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python2</span><span class="mf">.6</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">2.6</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python2</span><span class="mf">.7</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">2.7</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.3</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.3</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.4</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.4</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.5</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.5</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.6</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.6</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.7</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.7</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.8</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.8</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.9</span>        <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.9</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">python3</span><span class="mf">.10</span>       <span class="n">Do</span> <span class="ow">not</span> <span class="n">use</span> <span class="n">Python</span> <span class="mf">3.10</span> <span class="n">even</span> <span class="k">if</span> <span class="n">available</span> <span class="n">on</span> <span class="n">the</span> <span class="n">system</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
<span class="o">--</span><span class="n">coverage</span>            <span class="n">Make</span> <span class="n">a</span> <span class="n">coverage</span> <span class="n">analysis</span><span class="p">,</span> <span class="n">that</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">really</span> <span class="n">check</span><span class="o">.</span>
                      <span class="n">Default</span> <span class="ow">is</span> <span class="kc">False</span><span class="o">.</span>
</pre></div>
</div>
<p>You will only run the CPython test suites, if you have the submodules of
the Nuitka git repository checked out. Otherwise, these will be skipped
with a warning that they are not available.</p>
<p>The policy is generally, that <code class="docutils literal notranslate"><span class="pre">./test/run-tests</span></code> running and passing
all the tests on Linux and Windows shall be considered sufficient for a
release, but of course, depending on changes going on, that might have
to be expanded.</p>
</section>
<section id="basic-tests">
<h3>Basic Tests<a class="headerlink" href="#basic-tests" title="Permalink to this headline"></a></h3>
<p>You can run the “basic” tests like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/basics/run_all.py search
</pre></div>
</div>
<p>These tests normally give sufficient coverage to assume that a change is
correct, if these “basic” tests pass. The most important constructs and
built-ins are exercised.</p>
<p>To control the Python version used for testing, you can set the
<code class="docutils literal notranslate"><span class="pre">PYTHON</span></code> environment variable to e.g. <code class="docutils literal notranslate"><span class="pre">python3.5</span></code> (can also be full
path), or simply execute the <code class="docutils literal notranslate"><span class="pre">run_all.py</span></code> script directly with the
intended version, as it is portable across all supported Python
versions, and defaults testing with the Python version is run with.</p>
</section>
<section id="syntax-tests">
<h3>Syntax Tests<a class="headerlink" href="#syntax-tests" title="Permalink to this headline"></a></h3>
<p>Then there are “syntax” tests, i.e. language constructs that need to
give a syntax error.</p>
<p>It sometimes so happens that Nuitka must do this itself, because the
<code class="docutils literal notranslate"><span class="pre">ast.parse</span></code> doesn’t see the problem and raises no <code class="docutils literal notranslate"><span class="pre">SyntaxError</span></code> of
its own. These cases are then covered by tests to make sure they work as
expected.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">global</span></code> statement on a function argument is an example of
this. These tests make sure that the errors of Nuitka and CPython are
totally the same for this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/syntax/run_all.py search
</pre></div>
</div>
</section>
<section id="program-tests">
<h3>Program Tests<a class="headerlink" href="#program-tests" title="Permalink to this headline"></a></h3>
<p>Then there are small “programs” tests, that e.g. exercise many kinds of
import tricks and are designed to reveal problems with inter-module
behavior. These can be run like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/programs/run_all.py search
</pre></div>
</div>
</section>
<section id="generated-tests">
<h3>Generated Tests<a class="headerlink" href="#generated-tests" title="Permalink to this headline"></a></h3>
<p>There are tests, which are generated from Jinja2 templates. They aim at
e.g. combining at types with operations, in-place or not, or large
constants. These can be run like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/generated/run_all.py search
</pre></div>
</div>
</section>
<section id="compile-nuitka-with-nuitka">
<h3>Compile Nuitka with Nuitka<a class="headerlink" href="#compile-nuitka-with-nuitka" title="Permalink to this headline"></a></h3>
<p>And there is the “compile itself” or “reflected” test. This test makes
Nuitka compile itself and compare the resulting C++ when running
compiled to non-compiled, which helps to find in-determinism.</p>
<p>The test compiles every module of Nuitka into an extension module and
all of Nuitka into a single binary.</p>
<p>That test case also gives good coverage of the <code class="docutils literal notranslate"><span class="pre">import</span></code> mechanisms,
because Nuitka uses a lot of packages and imports between them.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./tests/reflected/compile_itself.py
</pre></div>
</div>
</section>
</section>
<section id="internal-plugin-api">
<h2>Internal/Plugin API<a class="headerlink" href="#internal-plugin-api" title="Permalink to this headline"></a></h2>
<p>The documentation from the source code for both the Python and the C
parts are published as <a class="reference external" href="https://nuitka.net/apidoc">Nuitka API</a> and
arguably in a relatively bad shape as we started generating those with
Doxygen only relatively late.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>doxygen ./doc/Doxyfile
xdg-open html
</pre></div>
</div>
<p>Improvements have already been implemented for plugins: The plugin base
class defined in <code class="docutils literal notranslate"><span class="pre">PluginBase.py</span></code> (which is used as a template for all
plugins) is fully documented in Doxygen now. The same is true for the
recently added standard plugins <code class="docutils literal notranslate"><span class="pre">NumpyPlugin.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">TkinterPlugin.py</span></code>. These will be uploaded very soon.</p>
<p>Going forward, this will also happen for the remaining standard plugins.</p>
<p>Please find <a class="reference external" href="https://github.com/Nuitka/Nuitka/blob/develop/UserPlugin-Creation.rst">here</a>
a detailed description of how to write your own plugin.</p>
<p>To learn about plugin option specification consult <a class="reference external" href="https://github.com/Nuitka/Nuitka/blob/develop/Using-Plugin-Options.rst">this document</a>.</p>
</section>
<section id="working-with-the-cpython-suites">
<h2>Working with the CPython suites<a class="headerlink" href="#working-with-the-cpython-suites" title="Permalink to this headline"></a></h2>
<p>The CPython test suites are different branches of the same submodule.
When you update your git checkout, they will frequently become detached.
In this case, simply execute this command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git submodule foreach <span class="s1">&#39;git fetch &amp;&amp; git checkout $(basename $(pwd)) &amp;&amp; \</span>
<span class="s1">git reset --hard origin/$(basename $(pwd))&#39;</span>
</pre></div>
</div>
<p>When adding a test suite, for a new version, proceed like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Switch to a new branch.</span>
git checkout CPython39
git branch CPython310
git checkout CPython310

<span class="c1"># Delete all but root commit</span>
git rebase -i root
rm -rf <span class="nb">test</span>
cp ~/repos/Nuitka-references/final/Python-3.10.0/Lib/test <span class="nb">test</span>
git add <span class="nb">test</span>

<span class="c1"># Update commit message to mention proper Python version.</span>
git commit --amend

<span class="c1"># Push to github, setting upstream for branch.</span>
git push -u

<span class="c1"># Cherry pick the removal commits from previous branches.</span>
git log origin/CPython39 --reverse --oneline <span class="p">|</span> grep <span class="s1">&#39; Removed&#39;</span> <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs git cherry-pick
<span class="c1"># While being prompted for merge conflicts with the deleted files:</span>
git status <span class="p">|</span> sed -n <span class="s1">&#39;s/deleted by them://p&#39;</span> <span class="p">|</span> xargs git rm --ignore-unmatch x <span class="p">;</span> git cherry-pick --continue

<span class="c1"># Push to github, this is useful.</span>
git push

<span class="c1"># Cherry pick the first commit of &#39;run_all.py&#39;, the copy it from the last state, and amend the commits.</span>
git log --reverse origin/CPython39 --oneline -- run_all.py <span class="p">|</span> head -1 <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs git cherry-pick
git checkout origin/CPython39 -- run_all.py
chmod +x run_all.py
sed -i -e <span class="s1">&#39;s#python3.9#python3.10#&#39;</span> run_all.py
git commit --amend --no-edit run_all.py

<span class="c1"># Same for &#39;update_doctest_generated.py&#39;</span>
git log --reverse origin/CPython39 --oneline -- update_doctest_generated.py <span class="p">|</span> head -1 <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs git cherry-pick
git checkout origin/CPython39 -- update_doctest_generated.py
chmod +x update_doctest_generated.py
sed -i -e <span class="s1">&#39;s#python3.9#python3.10#&#39;</span> update_doctest_generated.py
git commit --amend --no-edit update_doctest_generated.py

<span class="c1"># Same for .gitignore</span>
git log --reverse origin/CPython39 --oneline -- .gitignore <span class="p">|</span> head -1 <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs git cherry-pick
git checkout origin/CPython39 -- .gitignore
git commit --amend --no-edit .gitignore

<span class="c1"># Now cherry-pick all commits of test support, these disable network, audio, GUI, random filenames and more</span>
<span class="c1"># and are crucial for deterministic outputs and non-reliance on outside stuff.</span>
git log --reverse origin/CPython39 --oneline -- test/support/__init__.py <span class="p">|</span> tail -n +2 <span class="p">|</span> cut -d<span class="s1">&#39; &#39;</span> -f1 <span class="p">|</span> xargs git cherry-pick

git push
</pre></div>
</div>
</section>
<section id="design-descriptions">
<h2>Design Descriptions<a class="headerlink" href="#design-descriptions" title="Permalink to this headline"></a></h2>
<p>These should be a lot more and contain graphics from presentations
given. It will be filled in, but not now.</p>
<section id="nuitka-logo">
<h3>Nuitka Logo<a class="headerlink" href="#nuitka-logo" title="Permalink to this headline"></a></h3>
<p>The logo was submitted by “dr. Equivalent”. It’s source is contained in
<code class="docutils literal notranslate"><span class="pre">doc/Logo</span></code> where 3 variants of the logo in SVG are placed.</p>
<ul class="simple">
<li><p>Symbol only (symbol)</p></li>
</ul>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">image</span><span class="p">::</span> doc/images/Nuitka-Logo-Symbol.png
   <span class="nc">:alt:</span> Nuitka Logo
</pre></div>
</div>
<ul class="simple">
<li><p>Text next to symbol (horizontal)</p></li>
</ul>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">image</span><span class="p">::</span> doc/images/Nuitka-Logo-Horizontal.png
   <span class="nc">:alt:</span> Nuitka Logo
</pre></div>
</div>
<ul class="simple">
<li><p>Text beneath symbol (vertical)</p></li>
</ul>
<div class="highlight-rest notranslate"><div class="highlight"><pre><span></span><span class="p">..</span> <span class="ow">image</span><span class="p">::</span> doc/images/Nuitka-Logo-Vertical.png
   <span class="nc">:alt:</span> Nuitka Logo
</pre></div>
</div>
<p>From these logos, PNG images, and “favicons”, and are derived.</p>
<p>The exact ImageMagick commands are in
<code class="docutils literal notranslate"><span class="pre">nuitka/tools/release/Documentation</span></code>, but are not executed each time,
the commands are also replicated here:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>convert -background none doc/Logo/Nuitka-Logo-Symbol.svg doc/images/Nuitka-Logo-Symbol.png
convert -background none doc/Logo/Nuitka-Logo-Vertical.svg doc/images/Nuitka-Logo-Vertical.png
convert -background none doc/Logo/Nuitka-Logo-Horizontal.svg doc/images/Nuitka-Logo-Horizontal.png

optipng -o2 doc/images/Nuitka-Logo-Symbol.png
optipng -o2 doc/images/Nuitka-Logo-Vertical.png
optipng -o2 doc/images/Nuitka-Logo-Horizontal.png
</pre></div>
</div>
</section>
<section id="choice-of-the-target-language">
<h3>Choice of the Target Language<a class="headerlink" href="#choice-of-the-target-language" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Choosing the target language was important decision. factors were:</p>
<ul>
<li><p>The portability of Nuitka is decided here</p></li>
<li><p>How difficult is it to generate the code?</p></li>
<li><p>Does the Python C-API have bindings?</p></li>
<li><p>Is that language known?</p></li>
<li><p>Does the language aid to find bugs?</p></li>
</ul>
</li>
</ul>
<p>The <em>decision for C11</em> is ultimately one for portability, general
knowledge of the language and for control over created code, e.g. being
able to edit and try that quickly.</p>
<p>The current status is to use pure C11. All code compiles as C11, and
also in terms of workaround to missing compiler support as C++03. This
is mostly needed, because MSVC does not support C. Naturally we are not
using any C++ features, just the allowances of C++ features that made it
into C11, which is e.g. allowing late definitions of variables.</p>
</section>
<section id="use-of-scons-internally">
<h3>Use of Scons internally<a class="headerlink" href="#use-of-scons-internally" title="Permalink to this headline"></a></h3>
<p>Nuitka does not involve Scons in its user interface at all; Scons is
purely used internally. Nuitka itself, being pure Python, will run
without any build process just fine.</p>
<p>Nuitka simply prepares <code class="docutils literal notranslate"><span class="pre">&lt;program&gt;.build</span></code> folders with lots of files
and tasks scons to execute the final build, after which Nuitka again
will take control and do more work as necessary.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When we speak of “standalone” mode, this is handled outside of Scons,
and after it, creating the “.dist” folder. This is done in
<code class="docutils literal notranslate"><span class="pre">nuitka.MainControl</span></code> module.</p>
</div>
<p>For interfacing to Scons, there is the module
<code class="docutils literal notranslate"><span class="pre">nuitka.build.SconsInterface</span></code> that will support calling <code class="docutils literal notranslate"><span class="pre">scons</span></code> -
potentially from one of two inline copies (one for before / one for
Python 3.5 or later). These are mainly used on Windows or when using
source releases - and passing arguments to it. These arguments are
passed as <code class="docutils literal notranslate"><span class="pre">key=value</span></code>, and decoded in the scons file of Nuitka.</p>
<p>The scons file is named <code class="docutils literal notranslate"><span class="pre">SingleExe.scons</span></code> for lack of better name.
It’s really wrong now, but we have yet to find a better name. It once
expressed the intention to be used to create executables, but the same
works for modules too, as in terms of building, and to Scons, things
really are the same.</p>
<p>The scons file supports operation in multiple modes for many things, and
modules is just one of them. It runs outside of Nuitka process scope,
even with a different Python version potentially, so all the information
must be passed on the command line.</p>
<p>What follows is the (lengthy) list of arguments that the scons file
processes:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">source_dir</span></code></p>
<p>Where is the generated C source code. Scons will just compile
everything it finds there. No list of files is passed, but instead
this directory is being scanned.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">nuitka_src</span></code></p>
<p>Where do the include files and static C parts of Nuitka live. These
provide e.g. the implementation of compiled function, generators, and
other helper codes, this will point to where <code class="docutils literal notranslate"><span class="pre">nuitka.build</span></code> package
lives normally.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">module_mode</span></code></p>
<p>Build a module instead of a program.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">result_base</span></code></p>
<p>This is not a full name, merely the basename for the result to be
produced, but with path included, and the suffix comes from module or
executable mode.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">debug_mode</span></code></p>
<p>Enable debug mode, which is a mode, where Nuitka tries to help
identify errors in itself, and will generate less optimal code. This
also asks for warnings, and makes the build fail if there are any.
Scons will pass different compiler options in this case.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_debug</span></code></p>
<p>Compile and link against Python debug mode, which does assertions and
extra checks, to identify errors, mostly related to reference
counting. May make the build fail, if no debug build library of
CPython is available. On Windows it is possible to install it for
CPython3.5 or higher.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">full_compat_mode</span></code></p>
<p>Full compatibility, even where it’s stupid, i.e. do not provide
information, even if available, in order to assert maximum
compatibility. Intended to control the level of compatibility to
absurd.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">experimental_mode</span></code></p>
<p>Do things that are not yet accepted to be safe.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">lto_mode</span></code></p>
<p>Make use of link time optimization of gcc compiler if available and
known good with the compiler in question. So far, this was not found
to make major differences.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">disable_console</span></code></p>
<p>Windows subsystem mode: Disable console for windows builds.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">unstripped_mode</span></code></p>
<p>Unstripped mode: Do not remove debug symbols.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">clang_mode</span></code></p>
<p>Clang compiler mode, default on macOS X and FreeBSD, optional on
Linux.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">mingw_mode</span></code></p>
<p>MinGW compiler mode, optional and useful on Windows only.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">standalone_mode</span></code></p>
<p>Building a standalone distribution for the binary.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">show_scons</span></code></p>
<p>Show scons mode, output information about Scons operation. This will
e.g. also output the actual compiler used, output from compilation
process, and generally debug information relating to be build
process.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_prefix</span></code></p>
<p>Home of Python to be compiled against, used to locate headers and
libraries.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">target_arch</span></code></p>
<p>Target architecture to build. Only meaningful on Windows.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">python_version</span></code></p>
<p>The major version of Python built against.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">abiflags</span></code></p>
<p>The flags needed for the Python ABI chosen. Might be necessary to
find the folders for Python installations on some systems.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">icon_path</span></code></p>
<p>The icon to use for Windows programs if given.</p>
</li>
</ul>
</section>
<section id="locating-modules-and-packages">
<h3>Locating Modules and Packages<a class="headerlink" href="#locating-modules-and-packages" title="Permalink to this headline"></a></h3>
<p>The search for modules used is driven by <code class="docutils literal notranslate"><span class="pre">nuitka.importing.Importing</span></code>
module.</p>
<ul>
<li><p>Quoting the <code class="docutils literal notranslate"><span class="pre">nuitka.importing.Importing</span></code> documentation:</p>
<p>Locating modules and package source on disk.</p>
<p>The actual import of a module would already execute code that changes
things. Imagine a module that does <code class="docutils literal notranslate"><span class="pre">os.system()</span></code>, it would be done
during compilation. People often connect to databases, and these kind
of things, at import time.</p>
<p>Therefore CPython exhibits the interfaces in an <code class="docutils literal notranslate"><span class="pre">imp</span></code> module in
standard library, which one can use those to know ahead of time, what
file import would load. For us unfortunately there is nothing in
CPython that is easily accessible and gives us this functionality for
packages and search paths exactly like CPython does, so we implement
here a multi step search process that is compatible.</p>
<p>This approach is much safer of course and there is no loss. To
determine if it’s from the standard library, one can abuse the
attribute <code class="docutils literal notranslate"><span class="pre">__file__</span></code> of the <code class="docutils literal notranslate"><span class="pre">os</span></code> module like it’s done in
<code class="docutils literal notranslate"><span class="pre">isStandardLibraryPath</span></code> of this module.</p>
<p>End quoting the <code class="docutils literal notranslate"><span class="pre">nuitka.importing.Importing</span></code> documentation.</p>
</li>
<li><p>Role</p>
<p>This module serves the recursion into modules and analysis if a
module is a known one. It will give warnings for modules attempted to
be located, but not found. These warnings are controlled by a while
list inside the module.</p>
</li>
</ul>
<p>The decision making and caching are located in the <code class="docutils literal notranslate"><span class="pre">nuitka.tree</span></code>
package, in modules <code class="docutils literal notranslate"><span class="pre">nuitka.tree.Recursion</span></code> and
<code class="docutils literal notranslate"><span class="pre">nuitka.tree.ImportCache</span></code>. Each module is only considered once (then
cached), and we need to obey lots of user choices, e.g. to compile a
standard library or not.</p>
</section>
<section id="hooking-for-module-import-process">
<h3>Hooking for module <code class="docutils literal notranslate"><span class="pre">import</span></code> process<a class="headerlink" href="#hooking-for-module-import-process" title="Permalink to this headline"></a></h3>
<p>Currently, in generated code, for every <code class="docutils literal notranslate"><span class="pre">import</span></code> a normal
<code class="docutils literal notranslate"><span class="pre">__import__()</span></code> built-in call is executed. The
<code class="docutils literal notranslate"><span class="pre">nuitka/build/static_src/MetaPathBasedLoader.c</span></code> file provides the
implementation of a <code class="docutils literal notranslate"><span class="pre">sys.meta_path</span></code> hook.</p>
<p>This meta path based importer allows us to have the Nuitka provided
module imported even when imported by non-compiled code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Of course, it would make sense to compile time detect which module it
is that is being imported and then to make it directly. At this time,
we don’t have this inter-module optimization yet, mid-term it should
become easy to add.</p>
</div>
</section>
<section id="supporting-class-of-python3">
<h3>Supporting <code class="docutils literal notranslate"><span class="pre">__class__</span></code> of Python3<a class="headerlink" href="#supporting-class-of-python3" title="Permalink to this headline"></a></h3>
<p>In Python3 the handling of <code class="docutils literal notranslate"><span class="pre">__class__</span></code> and <code class="docutils literal notranslate"><span class="pre">super</span></code> is different from
Python2. It used to be a normal variable, and now the following things
have changed.</p>
<ul>
<li><p>The use of the <code class="docutils literal notranslate"><span class="pre">super</span></code> variable name triggers the addition of a
closure variable <code class="docutils literal notranslate"><span class="pre">__class__</span></code>, as can be witnessed by the following
code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">X</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">f2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">locals</span><span class="p">())</span>
        <span class="nb">super</span>  <span class="c1"># Just using the name, not even calling it.</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">f1</span><span class="p">()</span>
<span class="n">x</span><span class="o">.</span><span class="n">f2</span><span class="p">()</span>
</pre></div>
</div>
<p>Output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>{&#39;self&#39;: &lt;__main__.X object at 0x7f1773762390&gt;&#39;&#39;} {&#39;self&#39;:
&lt;__main__.X object at 0x7f1773762390&gt;, &#39;__class__&#39;: &lt;class
&#39;__main__.X&#39;&gt;}
</pre></div>
</div>
</li>
<li><p>This value of <code class="docutils literal notranslate"><span class="pre">__class__</span></code> is also available in the child functions.</p></li>
<li><p>The parser marks up code objects usage of “super”. It doesn’t have to
be a call, it can also be a local variable. If the <code class="docutils literal notranslate"><span class="pre">super</span></code> built-in
is assigned to another name and that is used without arguments, it
won’t work unless <code class="docutils literal notranslate"><span class="pre">__class__</span></code> is taken as a closure variable.</p></li>
<li><p>As can be seen in the CPython3 code, the closure value is added after
the class creation is performed.</p></li>
<li><p>It appears, that only functions locally defined to the class are
affected and take the closure.</p></li>
</ul>
<p>This left Nuitka with the strange problem, of how to emulate that.</p>
<p>The solution is this:</p>
<ul>
<li><p>Under Python3, usage of <code class="docutils literal notranslate"><span class="pre">__class__</span></code> as a reference in a child
function body is mandatory. It remains that way until all variable
names have been resolved.</p></li>
<li><dl class="simple">
<dt>When recognizing calls to <code class="docutils literal notranslate"><span class="pre">super</span></code> without arguments, make the arguments</dt><dd><p>into variable reference to <code class="docutils literal notranslate"><span class="pre">__class__</span></code> and potentially <code class="docutils literal notranslate"><span class="pre">self</span></code>
(actually first argument name).</p>
</dd>
</dl>
</li>
<li><p>After all variables have been known, and no suspicious unresolved
calls to anything named <code class="docutils literal notranslate"><span class="pre">super</span></code> are down, then unused references
are optimized away by the normal unused closure variable.</p></li>
<li><p>Class dictionary definitions are added.</p>
<p>These are special direct function calls, ready to propagate also
“bases” and “metaclass” values, which need to be calculated outside.</p>
<p>The function bodies used for classes will automatically store
<code class="docutils literal notranslate"><span class="pre">__class__</span></code> as a shared local variable, if anything uses it. And if
it’s not assigned by user code, it doesn’t show up in the “locals()”
used for dictionary creation.</p>
<p>Existing <code class="docutils literal notranslate"><span class="pre">__class__</span></code> local variable values are in fact provided as
closure, and overridden with the built class , but they should be
used for the closure giving, before the class is finished.</p>
<p>So <code class="docutils literal notranslate"><span class="pre">__class__</span></code> will be local variable of the class body, until the
class is built, then it will be the <code class="docutils literal notranslate"><span class="pre">__class__</span></code> itself.</p>
</li>
</ul>
</section>
<section id="frame-stack">
<h3>Frame Stack<a class="headerlink" href="#frame-stack" title="Permalink to this headline"></a></h3>
<p>In Python, every function, class, and module has a frame. It creates
created when the scope is entered, and there is a stack of these at run
time, which becomes visible in tracebacks in case of exceptions.</p>
<p>The choice of Nuitka is to make this an explicit element of the node
tree, that are as such subject to optimization. In cases, where they are
not needed, they may be removed.</p>
<p>Consider the following code.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">someNotRaisingCall</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">somePotentiallyRaisingCall</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>In this example, the frame is not needed for all the code, because the
condition checked wouldn’t possibly raise at all. The idea is the make
the frame guard explicit and then to reduce its scope whenever possible.</p>
<p>So we start out with code like this one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">frame_guard</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">someNotRaisingCall</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">somePotentiallyRaisingCall</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This is to be optimized into:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">someNotRaisingCall</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">frame_guard</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">somePotentiallyRaisingCall</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Notice how the frame guard taking is limited and may be avoided, or in
best cases, it might be removed completely. Also this will play a role
when in-lining function. The frame stack entry will then be
automatically preserved without extra care.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the actual code, <code class="docutils literal notranslate"><span class="pre">nuitka.nodes.FrameNodes.StatementsFrame</span></code> is
represents this as a set of statements to be guarded by a frame
presence.</p>
</div>
</section>
<section id="parameter-parsing">
<h3>Parameter Parsing<a class="headerlink" href="#parameter-parsing" title="Permalink to this headline"></a></h3>
<p>The parsing of parameters is very convoluted in Python, and doing it in
a compatible way is not that easy. This is a description of the required
process, for an easier overview.</p>
<section id="input">
<h4>Input<a class="headerlink" href="#input" title="Permalink to this headline"></a></h4>
<p>The input is an argument <code class="docutils literal notranslate"><span class="pre">tuple</span></code> (the type is fixed), which contains
the positional arguments, and potentially an argument <code class="docutils literal notranslate"><span class="pre">dict</span></code> (type is
fixed as well, but could also be <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, indicating that there are no
keyword arguments.</p>
</section>
<section id="keyword-dictionary">
<h4>Keyword dictionary<a class="headerlink" href="#keyword-dictionary" title="Permalink to this headline"></a></h4>
<p>The keyword argument dictionary is checked first. Anything in there,
that cannot be associated, either raise an error, or is added to a
potentially given star dict argument. So there are two major cases.</p>
<ul>
<li><p>No star dict argument: Iterate over dictionary, and assign or raise
errors.</p>
<p>This check covers extra arguments given.</p>
</li>
<li><p>With star dict argument: Iterate over dictionary, and assign or raise
errors.</p>
<p>Interesting case for optimization are no positional arguments, then
no check is needed, and the keyword argument dictionary could be used
as the star argument. Should it change, a copy is needed though.</p>
</li>
</ul>
<p>What’s noteworthy here, is that in comparison to the keywords, we can
hope that they are the same value as we use. The interning of strings
increases chances for non-compiled code to do that, esp. for short
names.</p>
<p>We then can do a simple <code class="docutils literal notranslate"><span class="pre">is</span></code> comparison and only fall back to real
string <code class="docutils literal notranslate"><span class="pre">==</span></code> comparisons, after all of these failed. That means more
code, but also a lot faster code in the positive case.</p>
</section>
<section id="argument-tuple">
<h4>Argument tuple<a class="headerlink" href="#argument-tuple" title="Permalink to this headline"></a></h4>
<p>After this completed, the argument tuple is up for processing. The first
thing it needs to do is to check if it’s too many of them, and then to
complain.</p>
<p>For arguments in Python2, there is the possibility of them being nested,
in which case they cannot be provided in the keyword dictionary, and
merely should get picked from the argument tuple.</p>
<p>Otherwise, the length of the argument tuple should be checked against
its position and if possible, values should be taken from there. If it’s
already set (from the keyword dictionary), raise an error instead.</p>
</section>
</section>
<section id="ssa-form-for-nuitka">
<h3>SSA form for Nuitka<a class="headerlink" href="#ssa-form-for-nuitka" title="Permalink to this headline"></a></h3>
<p>The SSA form is critical to how optimization works. The so called trace
collections builds up traces. These are facts about how this works:</p>
<ul>
<li><p>Assignments draw from a counter unique for the variable, which
becomes the variable version. This happens during tree building
phase.</p></li>
<li><p>References are associated with the version of the variable active.</p>
<p>This can be a merge of branches. Trace collection does do that and
provides nodes with the currently active trace for a variable.</p>
</li>
</ul>
<p>The data structures used for trace collection need to be relatively
compact as the trace information can become easily much more data than
the program itself.</p>
<p>Every trace collection has these:</p>
<ul>
<li><p>variable_actives</p>
<p>Dictionary, where per “variable” the currently used version is. Used
to track situations changes in branches. This is the main input for
merge process.</p>
</li>
<li><p>variable_traces</p>
<p>Dictionary, where “variable” and “version” form the key. The values
are objects with or without an assignment, and a list of usages,
which starts out empty.</p>
<p>These objects have usages appended to them. In “onVariableSet”, a new
version is allocated, which gives a new object for the dictionary,
with an empty usages list, because each write starts a new version.
In “onVariableUsage” the version is detected from the current
version. It may be not set yet, which means, it’s a read of an
undefined value (local variable, not a parameter name), or unknown in
case of global variable.</p>
<p>These objects may be told that their value has escaped. This should
influence the value friend they attached to the initial assignment.
Each usage may have a current value friend state that is different.</p>
</li>
</ul>
<p>When merging branches of conditional statements, the merge shall apply
as follows:</p>
<ul>
<li><p>Branches have their own collection</p>
<p>Thee have potentially deviating sets of <code class="docutils literal notranslate"><span class="pre">variable_actives</span></code>. These
are children of an outer collections.</p>
</li>
<li><p>Case a) One branch only.</p>
<p>For that branch a collection is performed. As usual new assignments
generate a new version making it “active”, references then related to
these “active” versions.</p>
<p>Then, when the branch is merged, for all “active” variables, it is
considered, if that is a change related to before the branch. If it’s
not the same, a merge trace with the branch condition is created with
the one active in the collection before that statement.</p>
</li>
<li><p>Case b) Two branches.</p>
<p>When there are two branches, they both as are treated as above,
except for the merge.</p>
<p>When merging, a difference in active variables between the two
branches creates the merge trace.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For conditional expressions, there are always only two branches. Even
if you think you have more than one branch, you do not. It’s always
nested branches, already when it comes out of the <code class="docutils literal notranslate"><span class="pre">ast</span></code> parser.</p>
</div>
<p>Trace structure, there are different kinds of traces.</p>
<ul>
<li><p>Initial write of the version</p>
<p>There may be an initial write for each version. It can only occur at
the start of the scope, but not later, and there is only one. This
might be known to be “initialized” (parameter variables of functions
are like that) or “uninitialized”, or “unknown”.</p>
</li>
<li><p>Merge of other one or two other versions</p>
<p>This combines two or more previous versions. In cases of loop exits
or entries, there are multiple branches to combine potentially. These
branches can have vastly different properties.</p>
</li>
<li><p>Becoming unknown.</p>
<p>When control flow escapes, e.g. for a module variable, any write can
occur to it, and it’s value cannot be trusted to be unchanged. These
are then traced as unknown.</p>
</li>
</ul>
<p>All traces have a base class <code class="docutils literal notranslate"><span class="pre">ValueTraceBase</span></code> which provides the
interface to query facts about the state of a variable in that trace.
It’s e.g. of some interest, if a variable must have a value or must not.
This allows to e.g. omit checks, know what exceptions might raise.</p>
</section>
<section id="loop-ssa">
<h3>Loop SSA<a class="headerlink" href="#loop-ssa" title="Permalink to this headline"></a></h3>
<p>For loops we have the addition difficulty that we need would need to
look ahead what types a variable has at loop exit, but that is a cyclic
dependency.</p>
<p>Our solution is to consider the variable types at loop entry. When these
change, we drop all gained information from inside the loop. We may e.g.
think that a variable is a <code class="docutils literal notranslate"><span class="pre">int</span></code> or <code class="docutils literal notranslate"><span class="pre">float</span></code>, but later recognize
that it can only be a float. Derivations from <code class="docutils literal notranslate"><span class="pre">int</span></code> must be discarded,
and the loop analysis restarted.</p>
<p>Then during the loop, we assign an incomplete loop trace shape to the
variable, which e.g. says it was an <code class="docutils literal notranslate"><span class="pre">int</span></code> initially and additional
type shapes, e.g. <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">or</span> <span class="pre">long</span></code> are then derived. If at the end of the
loop, a type produced no new types, we know we are finished and mark the
trace as a complete loop trace.</p>
<p>If it is not, and next time, we have the same initial types, we add the
ones derived from this to the starting values, and see if this gives
more types.</p>
</section>
<section id="python-slots-in-optimization">
<h3>Python Slots in Optimization<a class="headerlink" href="#python-slots-in-optimization" title="Permalink to this headline"></a></h3>
<section id="basic-slot-idea">
<h4>Basic Slot Idea<a class="headerlink" href="#basic-slot-idea" title="Permalink to this headline"></a></h4>
<p>For almost all the operations in Python, a form of overloading is
available. That is what makes it so powerful.</p>
<p>So when you write an expression like this one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">something</span>
</pre></div>
</div>
<p>This something will not just blindly work when it’s a float, but go
through a slot mechanism, which then can be overloaded.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SomeStrangeFloat</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">3.14</span>


<span class="n">something</span> <span class="o">=</span> <span class="n">SomeStrangeFloat</span><span class="p">()</span>
<span class="c1"># ...</span>
<span class="mf">1.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">something</span><span class="p">)</span> <span class="o">//</span> <span class="mf">4.140000000000001</span>
</pre></div>
</div>
<p>Here it is the case, that this is used by user code, but more often this
is used internally. Not all types have all slots, e.g. <code class="docutils literal notranslate"><span class="pre">list</span></code> does not
have <code class="docutils literal notranslate"><span class="pre">__float__</span></code> and therefore will refuse an addition to a <code class="docutils literal notranslate"><span class="pre">float</span></code>
value, based on that.</p>
<p>Another slot is working here, that we didn’t mention yet, and that is
<code class="docutils literal notranslate"><span class="pre">__add__</span></code> which for some times will be these kinds of conversions or
it will not do that kind of thing, e.g. something do hard checks, which
is why this fails to work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[]</span> <span class="o">+</span> <span class="p">()</span>
</pre></div>
</div>
<p>As a deliberate choice, there is no <code class="docutils literal notranslate"><span class="pre">__list__</span></code> slot used. The Python
designers are aiming at solving many things with slots, but they also
accept limitations.</p>
<p>There are many slots that are frequently used, most often behind your
back (<code class="docutils literal notranslate"><span class="pre">__iter__</span></code>, <code class="docutils literal notranslate"><span class="pre">__next__</span></code>, <code class="docutils literal notranslate"><span class="pre">__lt__</span></code>, etc.). The list is large,
and tends to grow with Python releases, but it is not endless.</p>
</section>
<section id="representation-in-nuitka">
<h4>Representation in Nuitka<a class="headerlink" href="#representation-in-nuitka" title="Permalink to this headline"></a></h4>
<p>So a slot in Nuitka typically has an owning node. We use <code class="docutils literal notranslate"><span class="pre">__len__</span></code> as
an example here. In the <code class="docutils literal notranslate"><span class="pre">computeExpression</span></code> the <code class="docutils literal notranslate"><span class="pre">len</span></code> node named
<code class="docutils literal notranslate"><span class="pre">ExpressionBuiltinLen</span></code> has to defer the decision what it computes to
its argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">computeExpression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace_collection</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">subnode_value</span><span class="o">.</span><span class="n">computeExpressionLen</span><span class="p">(</span>
        <span class="n">len_node</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace_collection</span><span class="o">=</span><span class="n">trace_collection</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>That decision then, in the absence of any type knowledge, must be done
absolutely carefully and conservative, as could see anything executing
here.</p>
<p>That examples this code in <code class="docutils literal notranslate"><span class="pre">ExpressionBase</span></code> which every expression by
default uses:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">computeExpressionLen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">len_node</span><span class="p">,</span> <span class="n">trace_collection</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getValueShape</span><span class="p">()</span>

    <span class="n">has_len</span> <span class="o">=</span> <span class="n">shape</span><span class="o">.</span><span class="n">hasShapeSlotLen</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">has_len</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">makeRaiseTypeErrorExceptionReplacementFromTemplateAndValue</span><span class="p">(</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;object of type &#39;</span><span class="si">%s</span><span class="s2">&#39; has no len()&quot;</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;len&quot;</span><span class="p">,</span>
            <span class="n">original_node</span><span class="o">=</span><span class="n">len_node</span><span class="p">,</span>
            <span class="n">value_node</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">has_len</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">iter_length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIterationLength</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">iter_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">.ConstantRefNodes</span> <span class="kn">import</span> <span class="n">makeConstantRefNode</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">makeConstantRefNode</span><span class="p">(</span>
                <span class="n">constant</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">iter_length</span><span class="p">),</span>  <span class="c1"># make sure to downcast long</span>
                <span class="n">source_ref</span><span class="o">=</span><span class="n">len_node</span><span class="o">.</span><span class="n">getSourceReference</span><span class="p">(),</span>
            <span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">wrapExpressionWithNodeSideEffects</span><span class="p">(</span><span class="n">new_node</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">old_node</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span>
                <span class="n">result</span><span class="p">,</span>
                <span class="s2">&quot;new_constant&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Predicted &#39;len&#39; result from value shape.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">onContentEscapes</span><span class="p">(</span><span class="n">trace_collection</span><span class="p">)</span>

    <span class="c1"># Any code could be run, note that.</span>
    <span class="n">trace_collection</span><span class="o">.</span><span class="n">onControlFlowEscape</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># Any exception may be raised.</span>
    <span class="n">trace_collection</span><span class="o">.</span><span class="n">onExceptionRaiseExit</span><span class="p">(</span><span class="ne">BaseException</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">len_node</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Notice how by default, known <code class="docutils literal notranslate"><span class="pre">__len__</span></code> but unpredictable or even
unknown if a <code class="docutils literal notranslate"><span class="pre">__len__</span></code> slot is there, the code indicates that its
contents and the control flow escapes (could change things behind out
back) and any exception could happen.</p>
<p>Other expressions can know better, e.g. for compile time constants we
can be a whole lot more certain:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">computeExpressionLen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">len_node</span><span class="p">,</span> <span class="n">trace_collection</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">trace_collection</span><span class="o">.</span><span class="n">getCompileTimeComputationResult</span><span class="p">(</span>
        <span class="n">node</span><span class="o">=</span><span class="n">len_node</span><span class="p">,</span>
        <span class="n">computation</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getCompileTimeConstant</span><span class="p">()),</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Compile time constant len value pre-computed.&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>In this case, we are using a function that will produce a concrete value
or the exception that the <code class="docutils literal notranslate"><span class="pre">computation</span></code> function raised. In this case,
we can let the Python interpreter that runs Nuitka do all the hard work.
This lives in <code class="docutils literal notranslate"><span class="pre">CompileTimeConstantExpressionBase</span></code> and is the base for
all kinds of constant values, or even built-in references like the name
<code class="docutils literal notranslate"><span class="pre">len</span></code> itself and would be used in case of doing <code class="docutils literal notranslate"><span class="pre">len(len)</span></code> which
obviously gives an exception.</p>
<p>Other overloads do not currently exist in Nuitka, but through the
iteration length, most cases could be addressed, e.g. <code class="docutils literal notranslate"><span class="pre">list</span></code> nodes
typical know their element counts.</p>
</section>
</section>
<section id="the-c-side">
<h3>The C side<a class="headerlink" href="#the-c-side" title="Permalink to this headline"></a></h3>
<p>When a slot is not optimized away at compile time however, we need to
generate actual code for it. We figure out what this could be by looking
at the original CPython implementation.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="nf">builtin_len</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyObject_Size</span><span class="p">(</span><span class="n">v</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">PyErr_Occurred</span><span class="p">())</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyInt_FromSsize_t</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>We find a pointer to <code class="docutils literal notranslate"><span class="pre">PyObject_Size</span></code> which is a generic Python C/API
function used in the <code class="docutils literal notranslate"><span class="pre">builtin_len</span></code> implementation:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="nf">PyObject_Size</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PySequenceMethods</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">null_error</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_as_sequence</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sq_length</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sq_length</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyMapping_Size</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>On the C level, every Python object (the <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>) as a type named
<code class="docutils literal notranslate"><span class="pre">ob_type</span></code> and most of its elements are slots. Sometimes they form a
group, here <code class="docutils literal notranslate"><span class="pre">tp_as_sequence</span></code> and then it may or may not contain a
function. This one is tried in preference. Then, if that fails, next up
the mapping size is tried.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="nf">PyMapping_Size</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyMappingMethods</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">null_error</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_as_mapping</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mp_length</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mp_length</span><span class="p">(</span><span class="n">o</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">type_error</span><span class="p">(</span><span class="s">&quot;object of type &#39;%.200s&#39; has no len()&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>This is the same principle, except with <code class="docutils literal notranslate"><span class="pre">tp_as_mapping</span></code> and
<code class="docutils literal notranslate"><span class="pre">mp_length</span></code> used.</p>
<p>So from this, we can tell how <code class="docutils literal notranslate"><span class="pre">len</span></code> gets at what could be a Python
class <code class="docutils literal notranslate"><span class="pre">__len__</span></code> or other built-in types.</p>
<p>In principle, every slot needs to be dealt with in Nuitka, and it is
assumed that currently all slots are supported on at least a very
defensive level, to avoid unnoticed escapes of control flow.</p>
</section>
<section id="built-in-call-optimization">
<h3>Built-in call optimization<a class="headerlink" href="#built-in-call-optimization" title="Permalink to this headline"></a></h3>
<p>For calls to built-in names, there is typically a function in Python
that delegates to the type constructor (e.g. when we talk about <code class="docutils literal notranslate"><span class="pre">int</span></code>
that just creates an object passing the arguments of the call) or its
own special implementation as we saw with the <code class="docutils literal notranslate"><span class="pre">len</span></code>.</p>
<p>For each built-in called, we have a specialized node, that presents to
optimization the actions of the built-in. What are the impact, what are
the results. We have seen the resulting example for <code class="docutils literal notranslate"><span class="pre">len</span></code> above, but
how do we get there.</p>
<p>In Python, built-in names are used only if there is no module level
variable of the name, and of course no local variable of that name.</p>
<p>Therefore, optimization of a built-in name is only done if it turns out
the actually assigned in other code, and then when the call comes,
arguments are checked and a relatively static node is created.</p>
</section>
<section id="code-generation-towards-c">
<h3>Code Generation towards C<a class="headerlink" href="#code-generation-towards-c" title="Permalink to this headline"></a></h3>
<p>Currently, Nuitka uses Pure C and no C++ patterns at all. The use of C11
requires on some platforms to compile the C11 using a C++ compiler,
which works relatively well, but also limits the amount of C11 that can
be used.</p>
<section id="exceptions">
<h4>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline"></a></h4>
<p>To handle and work with exceptions, every construct that can raise has
either a <code class="docutils literal notranslate"><span class="pre">bool</span></code> or <code class="docutils literal notranslate"><span class="pre">int</span></code> return code or <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code> with <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
return value. This is very much in line with that the Python C-API does.</p>
<p>Every helper function that contains code that might raise needs these
variables. After a failed call, our variant of <code class="docutils literal notranslate"><span class="pre">PyErr_Fetch</span></code> called
<code class="docutils literal notranslate"><span class="pre">FETCH_ERROR_OCCURRED</span></code> must be used to catch the defined error, unless
some quick exception cases apply. The quick exception means, <code class="docutils literal notranslate"><span class="pre">NULL</span></code>
return from C-API without a set exception means e.g. <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>.</p>
<p>As an optimization, functions that raise exceptions, but are known not
to do so, for whatever reason, could only be asserted to not do so.</p>
</section>
<section id="statement-temporary-variables">
<h4>Statement Temporary Variables<a class="headerlink" href="#statement-temporary-variables" title="Permalink to this headline"></a></h4>
<p>For statements and larger constructs the context object track temporary
values, that represent references. For some, these should be released at
the end of the statement, or they represent a leak.</p>
<p>The larger scope temporary variables, are tracked in the function or
module context, where they are supposed to have explicit <code class="docutils literal notranslate"><span class="pre">del</span></code> to
release their references.</p>
</section>
<section id="local-variables-storage">
<h4>Local Variables Storage<a class="headerlink" href="#local-variables-storage" title="Permalink to this headline"></a></h4>
<p>Closure variables taken are to be released when the function object is
later destroyed. For in-lined calls, variables are just passed, and it
does not become an issue to release anything.</p>
<p>For function exit, owned variables, local or shared to other functions,
must be released. This cannot be a <code class="docutils literal notranslate"><span class="pre">del</span></code> operation, as it also
involves setting a value, which would be wrong for shared variables (and
wasteful to local variables, as that would be its last usage). Therefore
we need a special operation that simply releases the reference to the
cell or object variable.</p>
</section>
<section id="exit-targets">
<h4>Exit Targets<a class="headerlink" href="#exit-targets" title="Permalink to this headline"></a></h4>
<p>Each error or other exit releases statement temporary values and then
executes a <code class="docutils literal notranslate"><span class="pre">goto</span></code> to the exit target. These targets need to be setup.
The <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> will e.g. catch error exits.</p>
<p>Other exits are <code class="docutils literal notranslate"><span class="pre">continue</span></code>, <code class="docutils literal notranslate"><span class="pre">break</span></code>, and <code class="docutils literal notranslate"><span class="pre">return</span></code> exits. They all
work alike.</p>
<p>Generally, the exits stack of with constructs that need to register
themselves for some exit types. A loop e.g. registers the <code class="docutils literal notranslate"><span class="pre">continue</span></code>
exit, and a contained <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">finally</span></code> too, so it can execute the
final code should it be needed.</p>
</section>
<section id="frames">
<h4>Frames<a class="headerlink" href="#frames" title="Permalink to this headline"></a></h4>
<p>Frames are containers for variable declarations and cleanups. As such,
frames provide error exits and success exits, which remove the frame
from the frame stack, and then proceed to the parent exit.</p>
<p>With the use of non <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">**</span></code> C types, but frame exception exits,
the need to convert those types becomes apparent. Exceptions should
still resolve the C version. When using different C types at frame
exception exits, there is a need to trace the active type, so it can be
used in the correct form.</p>
</section>
<section id="abortive-statements">
<h4>Abortive Statements<a class="headerlink" href="#abortive-statements" title="Permalink to this headline"></a></h4>
<p>The way <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">finally</span></code> is handled, copies of the <code class="docutils literal notranslate"><span class="pre">finally</span></code> block
are made, and optimized independently for each abort method. The ones
there are of course, <code class="docutils literal notranslate"><span class="pre">return</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, and <code class="docutils literal notranslate"><span class="pre">break</span></code>, but also
implicit and explicit <code class="docutils literal notranslate"><span class="pre">raise</span></code> of an exception.</p>
<p>Code trailing an abortive statement can be discarded, and the control
flow will follow these “exits”.</p>
</section>
</section>
<section id="constant-preparation">
<h3>Constant Preparation<a class="headerlink" href="#constant-preparation" title="Permalink to this headline"></a></h3>
<p>Early versions of Nuitka, created all constants for the whole program
for ready access to generated code, before the program launches. It did
so in a single file, but that approach didn’t scale well.</p>
<p>Problems were</p>
<ul class="simple">
<li><p>Even unused code contributed to start-up time, this can become a lot
for large programs, especially in standalone mode.</p></li>
<li><p>The massive amount of constant creation codes gave backend C
compilers a much harder time than necessary to analyse it all at
once.</p></li>
</ul>
<p>The current approach is as follows. Code generation detects constants
used in only one module, and declared <code class="docutils literal notranslate"><span class="pre">static</span></code> there, if the module is
the only user, or <code class="docutils literal notranslate"><span class="pre">extern</span></code> if it is not. Some values are forced to be
global, as they are used pre-main or in helpers.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">extern</span></code> values are globally created before anything is used.
The <code class="docutils literal notranslate"><span class="pre">static</span></code> values are created when the module is loaded, i.e.
something did import it.</p>
<p>We trace used constants per module, and for nested ones, we also
associate them. The global constants code is special in that it can only
use <code class="docutils literal notranslate"><span class="pre">static</span></code> for nested values it exclusively uses, and has to export
values that others use.</p>
</section>
<section id="language-conversions-to-make-things-simpler">
<h3>Language Conversions to make things simpler<a class="headerlink" href="#language-conversions-to-make-things-simpler" title="Permalink to this headline"></a></h3>
<p>There are some cases, where the Python language has things that can in
fact be expressed in a simpler or more general way, and where we choose
to do that at either tree building or optimization time.</p>
<section id="the-assert-statement">
<h4>The <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement<a class="headerlink" href="#the-assert-statement" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement is a special statement in Python, allowed by
the syntax. It has two forms, with and without a second argument. The
later is probably less known, as is the fact that raise statements can
have multiple arguments too.</p>
<p>The handling in Nuitka is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">value</span>
<span class="c1"># Absolutely the same as:</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">value</span><span class="p">,</span> <span class="n">raise_arg</span>
<span class="c1"># Absolutely the same as:</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">raise_arg</span><span class="p">)</span>
</pre></div>
</div>
<p>This makes assertions absolutely the same as a raise exception in a
conditional statement.</p>
<p>This transformation is performed at tree building already, so Nuitka
never knows about <code class="docutils literal notranslate"><span class="pre">assert</span></code> as an element and standard optimizations
apply. If e.g. the truth value of the assertion can be predicted, the
conditional statement will have the branch statically executed or
removed.</p>
</section>
<section id="the-comparison-chain-expressions">
<h4>The “comparison chain” expressions<a class="headerlink" href="#the-comparison-chain-expressions" title="Permalink to this headline"></a></h4>
<p>In Nuitka we have the concept of an outline, and therefore we can make
the following re-formulation instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">d</span>


<span class="k">def</span> <span class="nf">_comparison_chain</span><span class="p">():</span>  <span class="c1"># So called &quot;outline&quot; function</span>
    <span class="n">tmp_a</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">tmp_b</span> <span class="o">=</span> <span class="n">b</span><span class="p">()</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp_a</span> <span class="o">&lt;</span> <span class="n">tmp_b</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">del</span> <span class="n">tmp_a</span>
    <span class="n">tmp_c</span> <span class="o">=</span> <span class="n">c</span>

    <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp_b</span> <span class="o">&gt;</span> <span class="n">tmp_c</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="k">del</span> <span class="n">tmp_b</span>

    <span class="k">return</span> <span class="n">tmp_c</span> <span class="o">&lt;</span> <span class="n">d</span>


<span class="n">_comparison_chain</span><span class="p">()</span>
</pre></div>
</div>
<p>This transformation is performed at tree building already. The temporary
variables keep the value for the use of the same expression. Only the
last expression needs no temporary variable to keep it.</p>
<p>What we got from this, is making the checks of the comparison chain
explicit and comparisons in Nuitka to be internally always about two
operands only.</p>
</section>
<section id="the-execfile-built-in">
<h4>The <code class="docutils literal notranslate"><span class="pre">execfile</span></code> built-in<a class="headerlink" href="#the-execfile-built-in" title="Permalink to this headline"></a></h4>
<p>Handling is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">execfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="c1"># Basically the same as:</span>
<span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()),</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This allows optimizations to discover the file opening nature easily
and apply file embedding or whatever we will have there one day.</p>
</div>
<p>This transformation is performed when the <code class="docutils literal notranslate"><span class="pre">execfile</span></code> built-in is
detected as such during optimization.</p>
</section>
<section id="generator-expressions-with-yield">
<h4>Generator expressions with <code class="docutils literal notranslate"><span class="pre">yield</span></code><a class="headerlink" href="#generator-expressions-with-yield" title="Permalink to this headline"></a></h4>
<p>These are converted at tree building time into a generator function body
that yields from the iterator given, which is the put into a for loop to
iterate, created a lambda function of and then called with the first
iterator.</p>
<p>That eliminates the generator expression for this case. It’s a bizarre
construct and with this trick needs no special code generation.</p>
<p>This is a complex example, demonstrating multiple cases of yield in
unexpected cases:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">((</span><span class="k">yield</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="k">yield</span><span class="p">))</span>
<span class="c1"># Basically the same as:</span>
<span class="k">def</span> <span class="nf">x</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="k">yield</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">(</span><span class="k">yield</span> <span class="n">i</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="function-decorators">
<h4>Function Decorators<a class="headerlink" href="#function-decorators" title="Permalink to this headline"></a></h4>
<p>When one learns about decorators, you see that:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="c1"># Is basically the same as:</span>
<span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="n">function</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</pre></div>
</div>
<p>The only difference is the assignment to function. In the <code class="docutils literal notranslate"><span class="pre">&#64;decorator</span></code>
case, if the decorator fails with an exception, the name <code class="docutils literal notranslate"><span class="pre">function</span></code> is
not assigned yet, but kept in a temporary variable.</p>
<p>Therefore in Nuitka this assignment is more similar to that of a lambda
expression, where the assignment to the name is only at the end, which
also has the extra benefit of not treating real function and lambda
functions any different.</p>
<p>This removes the need for optimization and code generation to support
decorators at all. And it should make the two variants optimize equally
well.</p>
</section>
<section id="functions-nested-arguments">
<h4>Functions nested arguments<a class="headerlink" href="#functions-nested-arguments" title="Permalink to this headline"></a></h4>
<p>Nested arguments are a Python2 only feature supported by Nuitka.
Consider this example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>
</pre></div>
</div>
<p>We solve this, by kind of wrapping the function with another function
that does the unpacking and gives the errors that come from this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">_1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_tmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">_1</span>
    <span class="k">return</span> <span class="n">_tmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.1</span></code> is the variable name used by CPython internally, and actually
works if you use keyword arguments via star dictionary. So this is very
compatible and actually the right kind of re-formulation, but it removes
the need from the code that does parameter parsing to deal with these.</p>
<p>Obviously, there is no frame for <code class="docutils literal notranslate"><span class="pre">_tmp</span></code>, just one for <code class="docutils literal notranslate"><span class="pre">function</span></code> and
we do not use local variables, but temporary functions.</p>
</section>
<section id="in-place-assignments">
<h4>In-place Assignments<a class="headerlink" href="#in-place-assignments" title="Permalink to this headline"></a></h4>
<p>In-place assignments are re-formulated to an expression using temporary
variables.</p>
<p>These are not as much a reformulation of <code class="docutils literal notranslate"><span class="pre">+=</span></code> to <code class="docutils literal notranslate"><span class="pre">+</span></code>, but instead
one which makes it explicit that the assign target may change its value.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">+=</span> <span class="n">b</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_tmp</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="fm">__iadd__</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

<span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_tmp</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">_tmp</span>
</pre></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">__iadd__</span></code> here to express that for the <code class="docutils literal notranslate"><span class="pre">+</span></code>, the in-place
variant <code class="docutils literal notranslate"><span class="pre">iadd</span></code> is used instead. The <code class="docutils literal notranslate"><span class="pre">is</span></code> check may be optimized away
depending on type and value knowledge later on.</p>
</section>
<section id="complex-assignments">
<h4>Complex Assignments<a class="headerlink" href="#complex-assignments" title="Permalink to this headline"></a></h4>
<p>Complex assignments are defined as those with multiple targets to assign
from a single source and are re-formulated to such using a temporary
variable and multiple simple assignments instead.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_tmp</span> <span class="o">=</span> <span class="n">c</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">_tmp</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">_tmp</span>
<span class="k">del</span> <span class="n">_tmp</span>
</pre></div>
</div>
<p>This is possible, because in Python, if one assignment fails, it can
just be interrupted, so in fact, they are sequential, and all that is
required is to not calculate <code class="docutils literal notranslate"><span class="pre">c</span></code> twice, which the temporary variable
takes care of. Were <code class="docutils literal notranslate"><span class="pre">b</span></code> a more complex expression, e.g.
<code class="docutils literal notranslate"><span class="pre">b.some_attribute</span></code> that might raise an exception, <code class="docutils literal notranslate"><span class="pre">a</span></code> would still be
assigned.</p>
</section>
<section id="unpacking-assignments">
<h4>Unpacking Assignments<a class="headerlink" href="#unpacking-assignments" title="Permalink to this headline"></a></h4>
<p>Unpacking assignments are re-formulated to use temporary variables as
well.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span> <span class="o">=</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span> <span class="o">=</span> <span class="n">h</span><span class="p">()</span>
</pre></div>
</div>
<p>Becomes this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_tmp</span> <span class="o">=</span> <span class="n">h</span><span class="p">()</span>

<span class="n">_iter1</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
<span class="n">_tmp1</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">_tmp2</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">_tmp3</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">unpack_check</span><span class="p">(</span><span class="n">_iter1</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">_tmp1</span>
<span class="n">b</span><span class="o">.</span><span class="n">attr</span> <span class="o">=</span> <span class="n">_tmp2</span>
<span class="n">c</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">_tmp3</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">_tmp</span>
<span class="n">_iter2</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">_tmp</span><span class="p">)</span>
<span class="n">_tmp4</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">_tmp5</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">_tmp6</span> <span class="o">=</span> <span class="n">unpack</span><span class="p">(</span><span class="n">_iter2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">unpack_check</span><span class="p">(</span><span class="n">_iter1</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">_tmp4</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">_tmp5</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">_tmp6</span>
</pre></div>
</div>
<p>That way, the unpacking is decomposed into multiple simple statements.
It will be the job of optimizations to try and remove unnecessary
unpacking, in case e.g. the source is a known tuple or list creation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unpack</span></code> is a special node which is a form of <code class="docutils literal notranslate"><span class="pre">next</span></code> that
will raise a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> when it cannot get the next value, rather
than a <code class="docutils literal notranslate"><span class="pre">StopIteration</span></code>. The message text contains the number of
values to unpack, therefore the integer argument.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">unpack_check</span></code> is a special node that raises a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>
exception if the iterator is not finished, i.e. there are more values
to unpack. Again the number of values to unpack is provided to
construct the error message.</p>
</div>
</section>
<section id="with-statements">
<h4>With Statements<a class="headerlink" href="#with-statements" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">with</span></code> statements are re-formulated to use temporary variables as
well. The taking and calling of <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> with
arguments, is presented with standard operations instead. The promise to
call <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> is fulfilled by <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> clause instead.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">some_context</span> <span class="k">as</span> <span class="n">x</span><span class="p">:</span>
    <span class="n">something</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_source</span> <span class="o">=</span> <span class="n">some_context</span>

<span class="c1"># Actually it needs to be &quot;special look-up&quot; for Python2.7, so attribute</span>
<span class="c1"># look-up won&#39;t be exactly what is there.</span>
<span class="n">tmp_exit</span> <span class="o">=</span> <span class="n">tmp_source</span><span class="o">.</span><span class="fm">__exit__</span>

<span class="c1"># This one must be held for the whole with statement, it may be assigned</span>
<span class="c1"># or not, in our example it is. If an exception occurs when calling</span>
<span class="c1"># ``__enter__``, the ``__exit__`` should not be called.</span>
<span class="n">tmp_enter_result</span> <span class="o">=</span> <span class="n">tmp_source</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

<span class="c1"># Indicator variable to know if &quot;tmp_exit&quot; has been called.</span>
<span class="n">tmp_indicator</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Now the assignment is to be done, if there is any name for the</span>
    <span class="c1"># manager given, this may become multiple assignment statements and</span>
    <span class="c1"># even unpacking ones.</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">tmp_enter_result</span>

    <span class="c1"># Then the code of the &quot;with&quot; block.</span>
    <span class="n">something</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c1"># Note: This part of the code must not set line numbers, which we</span>
    <span class="c1"># indicate with special source code references, which we call &quot;internal&quot;.</span>
    <span class="c1"># Otherwise the line of the frame would get corrupted.</span>

    <span class="n">tmp_indicator</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp_exit</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()):</span>
        <span class="k">raise</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp_indicator</span><span class="p">:</span>
        <span class="c1"># Call the exit if no exception occurred with all arguments</span>
        <span class="c1"># as &quot;None&quot;.</span>
        <span class="n">tmp_exit</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We don’t refer really to <code class="docutils literal notranslate"><span class="pre">sys.exc_info()</span></code> at all, instead, we have
fast references to the current exception type, value and trace, taken
directly from the caught exception object on the C level.</p>
<p>If we had the ability to optimize <code class="docutils literal notranslate"><span class="pre">sys.exc_info()</span></code> to do that, we
could use the same transformation, but right now we don’t have it.</p>
</div>
</section>
<section id="for-loops">
<h4>For Loops<a class="headerlink" href="#for-loops" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">for</span></code> loops use normal assignments and handle the iterator that is
implicit in the code explicitly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">something</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">break</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">otherwise</span><span class="p">()</span>
</pre></div>
</div>
<p>This is roughly equivalent to the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>
<span class="n">_no_break_indicator</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_tmp_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">_iter</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="c1"># Set the indicator that the else branch may be executed.</span>
        <span class="n">_no_break_indicator</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Optimization should be able to tell that the else branch is run</span>
        <span class="c1"># only once.</span>
        <span class="k">break</span>

    <span class="c1"># Normal assignment re-formulation applies to this assignment of course.</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_tmp_value</span>
    <span class="k">del</span> <span class="n">_tmp_value</span>

    <span class="k">if</span> <span class="n">something</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">break</span>

<span class="k">if</span> <span class="n">_no_break_indicator</span><span class="p">:</span>
    <span class="n">otherwise</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">_iter</span></code> temporary variable is of course also in a
<code class="docutils literal notranslate"><span class="pre">try/finally</span></code> construct, to make sure it releases after its used.
The <code class="docutils literal notranslate"><span class="pre">x,</span> <span class="pre">y</span></code> assignment is of course subject to unpacking
re-formulation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> is detected to allow to use a variant of
<code class="docutils literal notranslate"><span class="pre">next</span></code> that does not raise an exception, but to be fast check about
the <code class="docutils literal notranslate"><span class="pre">NULL</span></code> return from <code class="docutils literal notranslate"><span class="pre">next</span></code> built-in. So no actual exception
handling is happening in this case.</p>
</div>
</section>
<section id="while-loops">
<h4>While Loops<a class="headerlink" href="#while-loops" title="Permalink to this headline"></a></h4>
<p>Quoting the <code class="docutils literal notranslate"><span class="pre">nuitka.tree.ReformulationWhileLoopStatements</span></code>
documentation:</p>
<p>Reformulation of while loop statements.</p>
<p>Loops in Nuitka have no condition attached anymore, so while loops are
re-formulated like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="n">condition</span><span class="p">:</span>
    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span>
        <span class="k">break</span>

    <span class="n">something</span><span class="p">()</span>
</pre></div>
</div>
<p>This is to totally remove the specialization of loops, with the
condition moved to the loop body in an initial conditional statement,
which contains a <code class="docutils literal notranslate"><span class="pre">break</span></code> statement.</p>
<p>That achieves, that only <code class="docutils literal notranslate"><span class="pre">break</span></code> statements exit the loop, and allow
for optimization to remove always true loop conditions, without
concerning code generation about it, and to detect such a situation,
consider e.g. endless loops.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Loop analysis (not yet done) can then work on a reduced problem
(which <code class="docutils literal notranslate"><span class="pre">break</span></code> statements are executed under what conditions) and
is then automatically very general.</p>
<p>The fact that the loop body may not be entered at all, is still
optimized, but also in the general sense. Explicit breaks at the loop
start and loop conditions are the same.</p>
</div>
<p>End quoting the <code class="docutils literal notranslate"><span class="pre">nuitka.tree.ReformulationWhileLoopStatements</span></code>
documentation:</p>
</section>
<section id="exception-handlers">
<h4>Exception Handlers<a class="headerlink" href="#exception-handlers" title="Permalink to this headline"></a></h4>
<p>Exception handlers in Python may assign the caught exception value to a
variable in the handler definition. And the different handlers are
represented as conditional checks on the result of comparison
operations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">block</span><span class="p">()</span>
<span class="k">except</span> <span class="n">A</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">handlerA</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">except</span> <span class="n">B</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">handlerB</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">handlerElse</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">block</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># These are special nodes that access the exception, and don&#39;t really</span>
    <span class="c1"># use the &quot;sys&quot; module.</span>
    <span class="n">tmp_exc_type</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmp_exc_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># exception_matches is a comparison operation, also a special node.</span>
    <span class="k">if</span> <span class="n">exception_matches</span><span class="p">(</span><span class="n">tmp_exc_type</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,)):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">tmp_exc_value</span>
        <span class="n">handlerA</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">exception_matches</span><span class="p">(</span><span class="n">tmp_exc_type</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span><span class="p">,)):</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">tmp_exc_value</span>
        <span class="n">handlerB</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">handlerElse</span><span class="p">()</span>
</pre></div>
</div>
<p>For Python3, the assigned <code class="docutils literal notranslate"><span class="pre">e</span></code> variables get deleted at the end of the
handler block. Should that value be already deleted, that <code class="docutils literal notranslate"><span class="pre">del</span></code> does
not raise, therefore it’s tolerant. This has to be done in any case, so
for Python3 it is even more complex.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">block</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># These are special nodes that access the exception, and don&#39;t really</span>
    <span class="c1"># use the &quot;sys&quot; module.</span>
    <span class="n">tmp_exc_type</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tmp_exc_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># exception_matches is a comparison operation, also a special node.</span>
    <span class="k">if</span> <span class="n">exception_matches</span><span class="p">(</span><span class="n">tmp_exc_type</span><span class="p">,</span> <span class="p">(</span><span class="n">A</span><span class="p">,)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">tmp_exc_value</span>
            <span class="n">handlerA</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">e</span>
    <span class="k">elif</span> <span class="n">exception_matches</span><span class="p">(</span><span class="n">tmp_exc_type</span><span class="p">,</span> <span class="p">(</span><span class="n">B</span><span class="p">,)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">tmp_exc_value</span>
            <span class="n">handlerB</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">handlerElse</span><span class="p">()</span>
</pre></div>
</div>
<p>Should there be no <code class="docutils literal notranslate"><span class="pre">else:</span></code> branch, a default re-raise statement is
used instead.</p>
<p>And of course, the values of the current exception type and value, both
use special references, that access the C++ and don’t go via
<code class="docutils literal notranslate"><span class="pre">sys.exc_info</span></code> at all, nodes called <code class="docutils literal notranslate"><span class="pre">CaughtExceptionTypeRef</span></code> and
<code class="docutils literal notranslate"><span class="pre">CaughtExceptionValueRef</span></code>.</p>
<p>This means, that the different handlers and their catching run time
behavior are all explicit and reduced the branches.</p>
</section>
<section id="statement-try-except-with-else">
<h4>Statement <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> with <code class="docutils literal notranslate"><span class="pre">else</span></code><a class="headerlink" href="#statement-try-except-with-else" title="Permalink to this headline"></a></h4>
<p>Much like <code class="docutils literal notranslate"><span class="pre">else</span></code> branches of loops, an indicator variable is used to
indicate the entry into any of the exception handlers.</p>
<p>Therefore, the <code class="docutils literal notranslate"><span class="pre">else</span></code> becomes a real conditional statement in the node
tree, checking the indicator variable and guarding the execution of the
<code class="docutils literal notranslate"><span class="pre">else</span></code> branch.</p>
</section>
<section id="class-creation-python2">
<h4>Class Creation (Python2)<a class="headerlink" href="#class-creation-python2" title="Permalink to this headline"></a></h4>
<p>Classes in Python2 have a body that only serves to build the class
dictionary and is a normal function otherwise. This is expressed with
the following re-formulation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in module &quot;SomeModule&quot;</span>
<span class="c1"># ...</span>


<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">SomeBase</span><span class="p">,</span> <span class="n">AnotherBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is the class documentation. &quot;&quot;&quot;</span>

    <span class="n">some_member</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_makeSomeClass</span><span class="p">():</span>
    <span class="c1"># The module name becomes a normal local variable too.</span>
    <span class="vm">__module__</span> <span class="o">=</span> <span class="s2">&quot;SomeModule&quot;</span>

    <span class="c1"># The doc string becomes a normal local variable.</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; This is the class documentation. &quot;&quot;&quot;</span>

    <span class="n">some_member</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>

    <span class="c1"># force locals to be a writable dictionary, will be optimized away, but</span>
    <span class="c1"># that property will stick. This is only to express, that locals(), where</span>
    <span class="c1"># used will be writable to.</span>
    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="n">SomeClass</span> <span class="o">=</span> <span class="n">make_class</span><span class="p">(</span><span class="s2">&quot;SomeClass&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">SomeBase</span><span class="p">,</span> <span class="n">AnotherBase</span><span class="p">),</span> <span class="n">_makeSomeClass</span><span class="p">())</span>
</pre></div>
</div>
<p>That is roughly the same, except that <code class="docutils literal notranslate"><span class="pre">_makeSomeClass</span></code> is <em>not</em>
visible to its child functions when it comes to closure taking, which we
cannot express in Python language at all.</p>
<p>Therefore, class bodies are just special function bodies that create a
dictionary for use in class creation. They don’t really appear after the
tree building stage anymore. The type inference will of course have to
become able to understand <code class="docutils literal notranslate"><span class="pre">make_class</span></code> quite well, so it can recognize
the created class again.</p>
</section>
<section id="class-creation-python3">
<h4>Class Creation (Python3)<a class="headerlink" href="#class-creation-python3" title="Permalink to this headline"></a></h4>
<p>In Python3, classes are a complicated way to write a function call, that
can interact with its body. The body starts with a dictionary provided
by the metaclass, so that is different, because it can <code class="docutils literal notranslate"><span class="pre">__prepare__</span></code> a
non-empty locals for it, which is hidden away in “prepare_class_dict”
below.</p>
<p>What’s noteworthy, is that this dictionary, could e.g. be an
<code class="docutils literal notranslate"><span class="pre">OrderDict</span></code>. I am not sure, what <code class="docutils literal notranslate"><span class="pre">__prepare__</span></code> is allowed to return.</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># in module &quot;SomeModule&quot;</span>
<span class="c1"># ...</span>

<span class="k">class</span> <span class="nc">SomeClass</span><span class="p">(</span><span class="n">SomeBase</span><span class="p">,</span> <span class="n">AnotherBase</span><span class="p">,</span> <span class="n">metaclass</span> <span class="o">=</span> <span class="n">SomeMetaClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This is the class documentation. &quot;&quot;&quot;</span>

    <span class="n">some_member</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Non-keyword arguments, need to be evaluated first.</span>
<span class="n">tmp_bases</span> <span class="o">=</span> <span class="p">(</span><span class="n">SomeBase</span><span class="p">,</span> <span class="n">AnotherBase</span><span class="p">)</span>

<span class="c1"># Keyword arguments go next, __metaclass__ is just one of them. In principle</span>
<span class="c1"># we need to forward the others as well, but this is ignored for the sake of</span>
<span class="c1"># brevity.</span>
<span class="n">tmp_metaclass</span> <span class="o">=</span> <span class="n">select_metaclass</span><span class="p">(</span><span class="n">tmp_bases</span><span class="p">,</span> <span class="n">SomeMetaClass</span><span class="p">)</span>

<span class="n">tmp_prepared</span> <span class="o">=</span> <span class="n">tmp_metaclass</span><span class="o">.</span><span class="fm">__prepare__</span><span class="p">(</span><span class="s2">&quot;SomeClass&quot;</span><span class="p">,</span> <span class="n">tmp_bases</span><span class="p">)</span>

<span class="c1"># The function that creates the class dictionary. Receives temporary variables</span>
<span class="c1"># to work with.</span>
<span class="k">def</span> <span class="nf">_makeSomeClass</span><span class="p">():</span>
    <span class="c1"># This has effect, currently I don&#39;t know how to express that in Python3</span>
    <span class="c1"># syntax, but we will have a node that does that.</span>
    <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tmp_prepared</span><span class="p">)</span>

    <span class="c1"># The module name becomes a normal local variable too.</span>
    <span class="vm">__module__</span> <span class="o">=</span> <span class="s2">&quot;SomeModule&quot;</span>

    <span class="c1"># The doc string becomes a normal local variable.</span>
    <span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot; This is the class documentation. &quot;&quot;&quot;</span>

    <span class="n">some_member</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># Create the class, share the potential closure variable &quot;__class__&quot;</span>
    <span class="c1"># with others.</span>
    <span class="vm">__class__</span> <span class="o">=</span> <span class="n">tmp_metaclass</span><span class="p">(</span><span class="s2">&quot;SomeClass&quot;</span><span class="p">,</span> <span class="n">tmp_bases</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>

    <span class="k">return</span> <span class="vm">__class__</span>


<span class="c1"># Build and assign the class.</span>
<span class="n">SomeClass</span> <span class="o">=</span> <span class="n">_makeSomeClass</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="generator-expressions">
<h4>Generator Expressions<a class="headerlink" href="#generator-expressions" title="Permalink to this headline"></a></h4>
<p>There are re-formulated as functions.</p>
<p>Generally they are turned into calls of function bodies with
(potentially nested) for loops:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">cond</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_gen_helper</span><span class="p">(</span><span class="n">__iterator</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>


<span class="n">gen</span> <span class="o">=</span> <span class="n">_gen_helper</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="list-contractions">
<h4>List Contractions<a class="headerlink" href="#list-contractions" title="Permalink to this headline"></a></h4>
<p>The list contractions of Python2 are different from those of Python3, in
that they don’t actually do any closure variable taking, and that no
function object ever exists.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">list_value</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">cond</span><span class="p">()]</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_listcontr_helper</span><span class="p">(</span><span class="n">__iterator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="n">list_value</span> <span class="o">=</span> <span class="n">_listcontr_helper</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<p>The difference is that with Python3, the function “_listcontr_helper” is
really there and named <code class="docutils literal notranslate"><span class="pre">&lt;listcontraction&gt;</span></code> (or <code class="docutils literal notranslate"><span class="pre">&lt;listcomp&gt;</span></code> as of
Python3.7 or higher), whereas with Python2 the function is only an
outline, so it can readily access the containing name space.</p>
</section>
<section id="set-contractions">
<h4>Set Contractions<a class="headerlink" href="#set-contractions" title="Permalink to this headline"></a></h4>
<p>The set contractions of Python2.7 are like list contractions in Python3,
in that they produce an actual helper function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">set_value</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">cond</span><span class="p">()}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_setcontr_helper</span><span class="p">(</span><span class="n">__iterator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="n">set_value</span> <span class="o">=</span> <span class="n">_setcontr_helper</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="dictionary-contractions">
<h4>Dictionary Contractions<a class="headerlink" href="#dictionary-contractions" title="Permalink to this headline"></a></h4>
<p>The dictionary contractions of are like list contractions in Python3, in
that they produce an actual helper function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dict_value</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">if</span> <span class="n">cond</span><span class="p">()}</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_dictcontr_helper</span><span class="p">(</span><span class="n">__iterator</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__iterator</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
            <span class="n">result</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="n">set_value</span> <span class="o">=</span> <span class="n">_dictcontr_helper</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="boolean-expressions-and-and-or">
<h4>Boolean expressions <code class="docutils literal notranslate"><span class="pre">and</span></code> and <code class="docutils literal notranslate"><span class="pre">or</span></code><a class="headerlink" href="#boolean-expressions-and-and-or" title="Permalink to this headline"></a></h4>
<p>The short circuit operators <code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">and</span></code> tend to be only less
general that the <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">else</span></code> expressions, but have dedicated nodes.
We used to have a re-formulation towards those, but we now do these via
dedicated nodes too.</p>
<p>These new nodes, present the evaluation of the left value, checking for
its truth value, and depending on it, to pick it, or use the right
value.</p>
</section>
<section id="simple-calls">
<h4>Simple Calls<a class="headerlink" href="#simple-calls" title="Permalink to this headline"></a></h4>
<p>As seen below, even complex calls are simple calls. In simple calls of
Python there is still some hidden semantic going on, that we expose.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">func</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">named1</span><span class="o">=</span><span class="n">arg3</span><span class="p">,</span> <span class="n">named2</span><span class="o">=</span><span class="n">arg4</span><span class="p">)</span>
</pre></div>
</div>
<p>On the C-API level there is a tuple and dictionary built. This one is
exposed:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">),</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;named1&quot;</span><span class="p">:</span> <span class="n">arg3</span><span class="p">,</span> <span class="s2">&quot;named2&quot;</span><span class="p">:</span> <span class="n">arg4</span><span class="p">})</span>
</pre></div>
</div>
<p>A called function will access this tuple and the dictionary to parse the
arguments, once that is also re-formulated (argument parsing), it can
then lead to simple in-lining. This way calls only have 2 arguments with
constant semantics, that fits perfectly with the C-API where it is the
same, so it is actually easier for code generation.</p>
<p>Although the above looks like a complex call, it actually is not. No
checks are needed for the types of the star arguments and it’s directly
translated to <code class="docutils literal notranslate"><span class="pre">PyObject_Call</span></code>.</p>
</section>
<section id="complex-calls">
<h4>Complex Calls<a class="headerlink" href="#complex-calls" title="Permalink to this headline"></a></h4>
<p>The call operator in Python allows to provide arguments in 4 forms.</p>
<ul class="simple">
<li><p>Positional (or normal) arguments</p></li>
<li><p>Named (or keyword) arguments</p></li>
<li><p>Star list arguments</p></li>
<li><p>Star dictionary arguments</p></li>
</ul>
<p>The evaluation order is precisely that. An example would be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">something</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">name1</span><span class="o">=</span><span class="n">named1</span><span class="p">,</span> <span class="n">name2</span><span class="o">=</span><span class="n">named2</span><span class="p">,</span> <span class="o">*</span><span class="n">star_list</span><span class="p">,</span> <span class="o">**</span><span class="n">star_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>The task here is that first all the arguments are evaluated, left to
right, and then they are merged into only two, that is positional and
named arguments only. for this, the star list argument and the star
dictionary arguments, are merged with the positional and named
arguments.</p>
<p>What’s peculiar, is that if both the star list and dictionary arguments
are present, the merging is first done for star dictionary, and only
after that for the star list argument. This makes a difference, because
in case of an error, the star argument raises first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">something</span><span class="p">(</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>This raises “TypeError: something() argument after ** must be a mapping,
not int” as opposed to a possibly more expected “TypeError: something()
argument after * must be a sequence, not int.”</p>
<p>That doesn’t matter much though, because the value is to be evaluated
first anyway, and the check is only performed afterwards. If the star
list argument calculation gives an error, this one is raised before
checking the star dictionary argument.</p>
<p>So, what we do, is we convert complex calls by the way of special
functions, which handle the dirty work for us. The optimization is then
tasked to do the difficult stuff. Our example becomes this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_complex_call</span><span class="p">(</span><span class="n">called</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">star_list_arg</span><span class="p">,</span> <span class="n">star_dict_arg</span><span class="p">):</span>
    <span class="c1"># Raises errors in case of duplicate arguments or tmp_star_dict not</span>
    <span class="c1"># being a mapping.</span>
    <span class="n">tmp_merged_dict</span> <span class="o">=</span> <span class="n">merge_star_dict_arguments</span><span class="p">(</span>
        <span class="n">called</span><span class="p">,</span> <span class="n">tmp_named</span><span class="p">,</span> <span class="n">mapping_check</span><span class="p">(</span><span class="n">called</span><span class="p">,</span> <span class="n">tmp_star_dict</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Raises an error if tmp_star_list is not a sequence.</span>
    <span class="n">tmp_pos_merged</span> <span class="o">=</span> <span class="n">merge_pos_arguments</span><span class="p">(</span><span class="n">called</span><span class="p">,</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="n">tmp_star_list</span><span class="p">)</span>

    <span class="c1"># On the C-API level, this is what it looks like.</span>
    <span class="k">return</span> <span class="n">called</span><span class="p">(</span><span class="o">*</span><span class="n">tmp_pos_merged</span><span class="p">,</span> <span class="o">**</span><span class="n">tmp_merged_dict</span><span class="p">)</span>


<span class="n">returned</span> <span class="o">=</span> <span class="n">_complex_call</span><span class="p">(</span>
    <span class="n">called</span><span class="o">=</span><span class="n">something</span><span class="p">,</span>
    <span class="n">pos</span><span class="o">=</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">),</span>
    <span class="n">named</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;name1&quot;</span><span class="p">:</span> <span class="n">named1</span><span class="p">,</span> <span class="s2">&quot;name2&quot;</span><span class="p">:</span> <span class="n">named2</span><span class="p">},</span>
    <span class="n">star_list_arg</span><span class="o">=</span><span class="n">star_list</span><span class="p">,</span>
    <span class="n">star_dict_arg</span><span class="o">=</span><span class="n">star_dict</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The call to <code class="docutils literal notranslate"><span class="pre">_complex_call</span></code> is be a direct function call with no
parameter parsing overhead. And the call in its end, is a special call
operation, which relates to the <code class="docutils literal notranslate"><span class="pre">PyObject_Call</span></code> C-API.</p>
</section>
<section id="match-statements">
<h4>Match Statements<a class="headerlink" href="#match-statements" title="Permalink to this headline"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">match</span> <span class="n">something</span><span class="p">():</span>
    <span class="k">case</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">case</span> <span class="k">_</span> <span class="k">as</span> <span class="n">y</span> <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">y</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>This is the same as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_match_subject</span> <span class="o">=</span> <span class="n">something</span><span class="p">()</span>

<span class="c1"># Indicator variable, once true, all matching stops.</span>
<span class="n">tmp_handled</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># First branch</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">tmp_match_subject</span>

<span class="k">if</span> <span class="n">sequence_check</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
      <span class="n">z</span> <span class="o">=</span> <span class="mi">2</span>
      <span class="n">tmp_handled</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">tmp_handled</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
   <span class="n">y</span> <span class="o">=</span> <span class="n">tmp_match_subject</span>

   <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">y</span><span class="p">:</span>
      <span class="n">z</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="n">tmp_handled</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">if</span> <span class="n">tmp_handled</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
   <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="print-statements">
<h4>Print Statements<a class="headerlink" href="#print-statements" title="Permalink to this headline"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">print</span></code> statement exists only in Python2. It implicitly converts
its arguments to strings before printing them. In order to make this
accessible and compile time optimized, this is made visible in the node
tree.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="n">arg1</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="mi">1</span>
</pre></div>
</div>
<p>This is in Nuitka converted so that the code generation for <code class="docutils literal notranslate"><span class="pre">print</span></code>
doesn’t do any conversions itself anymore and relies on the string
nature of its input.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Only string objects are spared from the <code class="docutils literal notranslate"><span class="pre">str</span></code> built-in wrapper,
because that would only cause noise in optimization stage. Later
optimization can then find it unnecessary for certain arguments.</p>
<p>Additionally, each <code class="docutils literal notranslate"><span class="pre">print</span></code> may have a target, and multiple arguments,
which we break down as well for dumber code generation. The target is
evaluated first and should be a file, kept referenced throughout the
whole print statement.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span> <span class="o">&gt;&gt;</span> <span class="n">target_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>This is being reformulated to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
   <span class="n">tmp_target</span> <span class="o">=</span> <span class="n">target_file</span>

   <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">tmp_target</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span> <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">tmp_target</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="nb">print</span>
   <span class="o">&gt;&gt;</span><span class="n">tmp_target</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">print</span> <span class="o">&gt;&gt;</span><span class="n">tmp_target</span>

<span class="k">finally</span><span class="p">:</span>
   <span class="k">del</span> <span class="n">tmp_target</span>
</pre></div>
</div>
<p>This allows code generation to not deal with arbitrary amount of
arguments to <code class="docutils literal notranslate"><span class="pre">print</span></code>. It also separates the newline indicator from the
rest of things, which makes sense too, having it as a special node, as
it’s behavior with regards to soft-space is different of course.</p>
<p>And finally, for <code class="docutils literal notranslate"><span class="pre">print</span></code> without a target, we still assume that a
target was given, which would be <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> in a rather hard-coded
way (no variable look-ups involved).</p>
</section>
</section>
<section id="reformulations-during-optimization">
<h3>Reformulations during Optimization<a class="headerlink" href="#reformulations-during-optimization" title="Permalink to this headline"></a></h3>
<section id="builtin-zip-for-python2">
<h4>Builtin <code class="docutils literal notranslate"><span class="pre">zip</span></code> for Python2<a class="headerlink" href="#builtin-zip-for-python2" title="Permalink to this headline"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>  <span class="c1"># Potentially more arguments.</span>
   <span class="c1"># First assign, to preserve the order of execution, the arguments might be</span>
   <span class="c1"># complex expressions with side effects.</span>
   <span class="n">tmp_arg1</span> <span class="o">=</span> <span class="n">a</span>
   <span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">b</span>
   <span class="n">tmp_arg3</span> <span class="o">=</span> <span class="n">c</span>
   <span class="c1"># could be more</span>
   <span class="o">...</span>

   <span class="c1"># Creation of iterators goes first.</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="n">tmp_iter_1</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">tmp_arg1</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;zip argument #1 must support iteration&quot;</span><span class="p">)</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="n">tmp_iter_2</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">tmp_arg2</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;zip argument #2 must support iteration&quot;</span><span class="p">)</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="n">tmp_iter_3</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">tmp_arg3</span><span class="p">)</span>
   <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;zip argument #3 must support iteration&quot;</span><span class="p">)</span>

   <span class="c1"># could be more</span>
   <span class="o">...</span>

   <span class="n">tmp_result</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">try</span><span class="p">:</span>
      <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
         <span class="n">tmp_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
               <span class="p">(</span>
                  <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_1</span><span class="p">),</span>
                  <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_2</span><span class="p">),</span>
                  <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_3</span><span class="p">),</span>
                  <span class="c1"># more arguments here ...</span>
               <span class="p">)</span>
         <span class="p">)</span>
   <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
      <span class="k">pass</span>

   <span class="k">return</span> <span class="n">tmp_result</span>
</pre></div>
</div>
<section id="builtin-zip-for-python3">
<h5>Builtin <code class="docutils literal notranslate"><span class="pre">zip</span></code> for Python3<a class="headerlink" href="#builtin-zip-for-python3" title="Permalink to this headline"></a></h5>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_zip_gen_object</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c1"># See Python2</span>
    <span class="o">...</span>

   <span class="c1"># could be more</span>
   <span class="o">...</span>
   <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_1</span><span class="p">),</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_2</span><span class="p">),</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">tmp_iter_3</span><span class="p">),</span>
            <span class="o">...</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
        <span class="k">break</span>

<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">_zip_gen_object</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
</section>
<section id="builtin-map-for-python2">
<h4>Builtin <code class="docutils literal notranslate"><span class="pre">map</span></code> for Python2<a class="headerlink" href="#builtin-map-for-python2" title="Permalink to this headline"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_map</span><span class="p">():</span>
    <span class="c1"># TODO: Not done yet.</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="builtin-min">
<h4>Builtin <code class="docutils literal notranslate"><span class="pre">min</span></code><a class="headerlink" href="#builtin-min" title="Permalink to this headline"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO: keyfunc (Python2/3), defaults (Python3)</span>
<span class="k">def</span> <span class="nf">_min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>  <span class="c1"># Potentially more arguments.</span>
    <span class="n">tmp_arg1</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">b</span>
    <span class="n">tmp_arg3</span> <span class="o">=</span> <span class="n">c</span>
    <span class="c1"># more arguments here ...</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_arg1</span>
    <span class="k">if</span> <span class="n">keyfunc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># can be decided during re-formulation</span>
        <span class="n">tmp_key_result</span> <span class="o">=</span> <span class="n">keyfunc</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">tmp_key_candidate</span> <span class="o">=</span> <span class="n">keyfunc</span><span class="p">(</span><span class="n">tmp_arg2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp_key_candidate</span> <span class="o">&lt;</span> <span class="n">tmp_key_result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_arg2</span>
            <span class="n">tmp_key_result</span> <span class="o">=</span> <span class="n">tmp_key_candidate</span>
        <span class="n">tmp_key_candidate</span> <span class="o">=</span> <span class="n">keyfunc</span><span class="p">(</span><span class="n">tmp_arg3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tmp_key_candidate</span> <span class="o">&lt;</span> <span class="n">tmp_key_result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_arg3</span>
            <span class="n">tmp_key_result</span> <span class="o">=</span> <span class="n">tmp_key_candidate</span>
        <span class="c1"># more arguments here ...</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tmp_arg2</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_arg2</span>
        <span class="k">if</span> <span class="n">tmp_arg3</span> <span class="o">&lt;</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_arg3</span>
        <span class="c1"># more arguments here ...</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</section>
<section id="builtin-max">
<h4>Builtin <code class="docutils literal notranslate"><span class="pre">max</span></code><a class="headerlink" href="#builtin-max" title="Permalink to this headline"></a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">min</span></code> just with <code class="docutils literal notranslate"><span class="pre">&gt;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>.</p>
</section>
<section id="call-to-dir-without-arguments">
<h4>Call to <code class="docutils literal notranslate"><span class="pre">dir</span></code> without arguments<a class="headerlink" href="#call-to-dir-without-arguments" title="Permalink to this headline"></a></h4>
<p>This expression is reformulated to <code class="docutils literal notranslate"><span class="pre">locals().keys()</span></code> for Python2, and
<code class="docutils literal notranslate"><span class="pre">list(locals.keys())</span></code> for Python3.</p>
</section>
<section id="calls-to-functions-with-known-signatures">
<h4>Calls to functions with known signatures<a class="headerlink" href="#calls-to-functions-with-known-signatures" title="Permalink to this headline"></a></h4>
<p>As a necessary step for inlining function calls, we need to change calls
to variable references to function references.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">some_op</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>


<span class="c1"># ... other code</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>In the optimization it is turned into</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... other code</span>

<span class="n">x</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">:</span> <span class="n">some_op</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">lambda</span></code> stands here for a reference to the function, rather
than a variable reference, this is the normal forward propagation of
values, and does not imply duplicating or moving any code at all.</p>
</div>
<p>At this point, we still have not resolved the actual call arguments to
the variable names, still a Python level function is created, and
called, and arguments are parsed to a tuple, and from a tuple. For
simplicity sake, we have left out keyword arguments out of the equation
for now, but they are even more costly.</p>
<p>So now, what we want to do, is to re-formulate the call into what we
call an outline body, which is a inline function, and that does the
parameter parsing already and contains the function code too. In this
inlining, there still is a function, but it’s technically not a Python
function anymore, just something that is an expression whose value is
determined by control flow and the function call.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... other code</span>


<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="n">tmp_arg1</span> <span class="o">=</span> <span class="n">arg1</span>
    <span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">tmp_arg1</span> <span class="o">+</span> <span class="n">tmp_arg2</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">_f</span><span class="p">()</span>
</pre></div>
</div>
<p>With this, a function is considered inlined, because it becomes part of
the abstract execution, and the actual code is duplicated.</p>
<p>The point is, that matching the signature of the function to the actual
arguments given, is pretty straight forward in many cases, but there are
two forms of complications that can happen. One is default values,
because they need to assigned or not, and the other is keyword
arguments, because they allow to reorder arguments.</p>
<p>Lets consider an example with default values first.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="o">=</span><span class="n">some_default</span><span class="p">()):</span>
    <span class="k">return</span> <span class="n">some_op</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>


<span class="c1"># ... other code</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>Since the point, at which defaults are taken, we must execute them at
that point and make them available.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">tmp_defaults</span> <span class="o">=</span> <span class="p">(</span><span class="n">some_default</span><span class="p">,)</span>  <span class="c1"># that was f.__defaults__</span>

<span class="c1"># ... other code</span>


<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="n">tmp_arg1</span> <span class="o">=</span> <span class="n">arg1</span>
    <span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">tmp_defaults</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">tmp_arg1</span> <span class="o">+</span> <span class="n">tmp_arg2</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">_f</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, one where keyword arguments are ordered the other way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">some_op</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>


<span class="c1"># ... other code</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">arg2</span><span class="o">=</span><span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="n">arg1</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>  <span class="c1"># &quot;b+c&quot; is evaluated before &quot;a&quot;</span>
</pre></div>
</div>
<p>The solution is an extra level of temporary variables. We remember the
argument order by names and then assign parameters from it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># ... other code</span>


<span class="k">def</span> <span class="nf">_f</span><span class="p">():</span>
    <span class="n">tmp_given_value1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span>
    <span class="n">tmp_given_value2</span> <span class="o">=</span> <span class="n">a</span>
    <span class="n">tmp_arg1</span> <span class="o">=</span> <span class="n">tmp_given_value2</span>
    <span class="n">tmp_arg2</span> <span class="o">=</span> <span class="n">tmp_given_value1</span>
    <span class="k">return</span> <span class="n">tmp_arg1</span> <span class="o">+</span> <span class="n">tmp_arg2</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">_f</span><span class="p">()</span>
</pre></div>
</div>
<p>Obviously, optimization of Nuitka can decide, that e.g. should <code class="docutils literal notranslate"><span class="pre">a</span></code> or
<code class="docutils literal notranslate"><span class="pre">b+c</span></code> not have side effects, to optimize these with standard variable
tracing away.</p>
</section>
</section>
<section id="nodes-that-serve-special-purposes">
<h3>Nodes that serve special purposes<a class="headerlink" href="#nodes-that-serve-special-purposes" title="Permalink to this headline"></a></h3>
<section id="try-statements">
<h4>Try statements<a class="headerlink" href="#try-statements" title="Permalink to this headline"></a></h4>
<p>In Python, there is <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">except</span></code> and <code class="docutils literal notranslate"><span class="pre">try</span></code>/<code class="docutils literal notranslate"><span class="pre">finally</span></code>. In
Nuitka there is only a <code class="docutils literal notranslate"><span class="pre">try</span></code>, which then has blocks to handle
exceptions, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, or <code class="docutils literal notranslate"><span class="pre">break</span></code>, or <code class="docutils literal notranslate"><span class="pre">return</span></code>. There is no
<code class="docutils literal notranslate"><span class="pre">else</span></code> to this node type.</p>
<p>This is more low level and universal. Code for the different handlers
can be different. User provided <code class="docutils literal notranslate"><span class="pre">finally</span></code> blocks become copied into
the different handlers.</p>
</section>
<section id="releases">
<h4>Releases<a class="headerlink" href="#releases" title="Permalink to this headline"></a></h4>
<p>When a function exits, the local variables are to be released. The same
applies to temporary variables used in re-formulations. These releases
cause a reference to the object to the released, but no value change.
They are typically the last use of the object in the function.</p>
<p>The are similar to <code class="docutils literal notranslate"><span class="pre">del</span></code>, but make no value change. For shared
variables this effect is most visible.</p>
</section>
<section id="side-effects">
<h4>Side Effects<a class="headerlink" href="#side-effects" title="Permalink to this headline"></a></h4>
<p>When an exception is bound to occur, and this can be determined at
compile time, Nuitka will not generate the code the leads to the
exception, but directly just raise it. But not in all cases, this is the
full thing.</p>
<p>Consider this code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">(),</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The second argument will create a <code class="docutils literal notranslate"><span class="pre">ZeroDivisionError</span></code> exception, but
before that <code class="docutils literal notranslate"><span class="pre">a()</span></code> must be executed, but the call to <code class="docutils literal notranslate"><span class="pre">f</span></code> will never
happen and no code is needed for that, but the name look-up must still
succeed. This then leads to code that is internally like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">(),</span> <span class="n">raise_ZeroDivisionError</span><span class="p">())</span>
</pre></div>
</div>
<p>which is then modeled as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">side_effect</span><span class="p">(</span><span class="n">a</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">raise_ZeroDivisionError</span><span class="p">())</span>
</pre></div>
</div>
<p>where we can consider <code class="docutils literal notranslate"><span class="pre">side_effect</span></code> to be a function that returns the
last expression. Of course, if this is not part of another expression,
but close to statement level, side effects, can be converted to multiple
statements simply.</p>
<p>Another use case, is that the value of an expression can be predicted,
but that the language still requires things to happen, consider this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">len</span><span class="p">((</span><span class="n">f</span><span class="p">(),</span> <span class="n">g</span><span class="p">()))</span>
</pre></div>
</div>
<p>We can tell that <code class="docutils literal notranslate"><span class="pre">a</span></code> will be 2, but the call to <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">g</span></code> must
still be performed, so it becomes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">side_effects</span><span class="p">(</span><span class="n">f</span><span class="p">(),</span> <span class="n">g</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Modelling side effects explicitly has the advantage of recognizing them
easily and allowing to drop the call to the tuple building and checking
its length, only to release it.</p>
</section>
<section id="caught-exception-type-value-references">
<h4>Caught Exception Type/Value References<a class="headerlink" href="#caught-exception-type-value-references" title="Permalink to this headline"></a></h4>
<p>When catching an exception, these are not directly put to
<code class="docutils literal notranslate"><span class="pre">sys.exc_info()</span></code>, but remain as mere C variables. From there, they can
be accessed with these nodes, or if published then from the thread
state.</p>
</section>
<section id="hard-module-imports">
<h4>Hard Module Imports<a class="headerlink" href="#hard-module-imports" title="Permalink to this headline"></a></h4>
<p>These are module look-ups that don’t depend on any local variable for
the module to be looked up, but with hard-coded names. These may be the
result of optimization gaining such level of certainty.</p>
<p>Currently they are used to represent <code class="docutils literal notranslate"><span class="pre">sys.stdout</span></code> usage for <code class="docutils literal notranslate"><span class="pre">print</span></code>
statements, but other usages will follow.</p>
</section>
<section id="locals-dict-update-statement">
<h4>Locals Dict Update Statement<a class="headerlink" href="#locals-dict-update-statement" title="Permalink to this headline"></a></h4>
<p>For the <code class="docutils literal notranslate"><span class="pre">exec</span></code> re-formulation, we apply an explicit sync back to
locals as an explicit node. It helps us to tell the affected local
variable traces that they might be affected. It represents the bit of
<code class="docutils literal notranslate"><span class="pre">exec</span></code> in Python2, that treats <code class="docutils literal notranslate"><span class="pre">None</span></code> as the locals argument as an
indication to copy back.</p>
</section>
</section>
<section id="optimizing-attribute-lookups-into-method-calls-for-built-ins-types">
<h3>Optimizing Attribute Lookups into Method Calls for Built-ins types<a class="headerlink" href="#optimizing-attribute-lookups-into-method-calls-for-built-ins-types" title="Permalink to this headline"></a></h3>
<p>The attribute lookup node <code class="docutils literal notranslate"><span class="pre">ExpressionAttributeLookup</span></code> represents
looking up an attribute name, that is known to be a string. That’s
already a bit more special, than say what <code class="docutils literal notranslate"><span class="pre">ExpressionBuiltinGetattr</span></code>
does for <code class="docutils literal notranslate"><span class="pre">getattr</span></code>, where it could be any object being looked up. From
the Python syntax however, these are what gets created, as it’s not
allowed in any other way. So, this is where this starts.</p>
<p>Then, when we are creating an attribute node with a <em>fixed</em> name, we
dispatch it to generated node classes, e.g.
<code class="docutils literal notranslate"><span class="pre">ExpressionAttributeLookupFixedAppend</span></code>. This will be the same, except
that the attribute name is hardcoded.</p>
<p>There are generated, such that they can have code that is special for
<code class="docutils literal notranslate"><span class="pre">.append</span></code> lookups. In their case, it makes sense to ask the source, if
they are a <code class="docutils literal notranslate"><span class="pre">list</span></code> object exactly. It doesn’t make sense to do this
check for names that the <code class="docutils literal notranslate"><span class="pre">list</span></code> does not contain. So at that stage, we
are saving both a bit of memory and time.</p>
<p>Should this question succeed, i.e. the expression the attribute values
is looked up upon, is known to be a <code class="docutils literal notranslate"><span class="pre">list</span></code> exactly, we persist this
knowledge in the also generated nodes that represent <code class="docutils literal notranslate"><span class="pre">list.append</span></code> and
just that. It is called <code class="docutils literal notranslate"><span class="pre">ExpressionAttributeLookupListAppend</span></code> and only
represents the knowledge gained so far.</p>
<p>We do not consider if <code class="docutils literal notranslate"><span class="pre">ExpressionAttributeLookupFixedAppend</span></code> is
called, or not, passed as an argument, assigned somewhere, it doesn’t
matter yet, but for <code class="docutils literal notranslate"><span class="pre">ExpressionAttributeLookupListAppend</span></code> we know a
hell of a lot more. We know its type, we know attributes for it, say
<code class="docutils literal notranslate"><span class="pre">__name__</span></code>, as it is a compile time constant, therefore much
optimization can follow for them, and code generation can specialize
them too (not yet done).</p>
<p>Should these nodes then, and say this happens later after some inlining
happens be seen as called, we can then turn them into method call nodes,
checking the arguments and such, this is then
<code class="docutils literal notranslate"><span class="pre">ExpressionListOperationAppend</span></code> and at this point, will raising errors
with wrong argument counts.</p>
<p>And then we have this <code class="docutils literal notranslate"><span class="pre">ExpressionListOperationAppend</span></code> which will
influence the tracing of <code class="docutils literal notranslate"><span class="pre">list</span></code> contents, i.e. it will be able to tell
the <code class="docutils literal notranslate"><span class="pre">list</span></code> in question is no more empty after this <code class="docutils literal notranslate"><span class="pre">append</span></code>, and it
will be able to at least predict the last element value, truth value of
the list, etc.</p>
</section>
</section>
<section id="plan-to-add-ctypes-support">
<h2>Plan to add “ctypes” support<a class="headerlink" href="#plan-to-add-ctypes-support" title="Permalink to this headline"></a></h2>
<p>Add interfacing to C code, so Nuitka can turn a <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> binding into
an efficient binding as if it were written manually with Python C-API or
better.</p>
<section id="goals-allowances-to-the-task">
<h3>Goals/Allowances to the task<a class="headerlink" href="#goals-allowances-to-the-task" title="Permalink to this headline"></a></h3>
<ol class="arabic">
<li><p>Goal: Must not directly use any pre-existing C/C++ language file
headers, only generate declarations in generated C code ourselves. We
would rather write or use tools that turn an existing a C header to
some <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> declarations if it needs to be, but not mix and use
declarations from existing header code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The “cffi” interface maybe won’t have the issue, but it’s not
something we need to write or test the code for.</p>
</div>
</li>
<li><p>Allowance: May use <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> module at compile time to ask things
about <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> and its types.</p></li>
<li><p>Goal: Should make use of <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>, to e.g. not hard code in Nuitka
what <code class="docutils literal notranslate"><span class="pre">ctypes.c_int()</span></code> gives on the current platform, unless there
is a specific benefit.</p></li>
<li><p>Allowance: Not all <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> usages must be supported immediately.</p></li>
<li><p>Goal: Try and be as general as possible.</p>
<p>For the compiler, <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> support should be hidden behind a
generic interface of some sort. Supporting <code class="docutils literal notranslate"><span class="pre">math</span></code> module should be
the same thing.</p>
</li>
</ol>
</section>
<section id="type-inference-the-discussion">
<h3>Type Inference - The Discussion<a class="headerlink" href="#type-inference-the-discussion" title="Permalink to this headline"></a></h3>
<p>Main initial goal is to forward value knowledge. When you have <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span>
<span class="pre">b</span></code>, that means that a and b now “alias”. And if you know the value of
<code class="docutils literal notranslate"><span class="pre">b</span></code> you can assume to know the value of <code class="docutils literal notranslate"><span class="pre">a</span></code>. This is called
“aliasing”.</p>
<p>When assigning <code class="docutils literal notranslate"><span class="pre">a</span></code> to something new, that won’t change <code class="docutils literal notranslate"><span class="pre">b</span></code> at all.
But when an attribute is set, a method called of it, that might impact
the actual value, referenced by both. We need to understand mutable vs.
immutable though, as some things are not affected by aliasing in any
way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">b</span> <span class="o">+=</span> <span class="mi">4</span>  <span class="c1"># a is not changed</span>

<span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>

<span class="n">b</span> <span class="o">+=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># a is changed indeed</span>
</pre></div>
</div>
<p>If we cannot tell, we must assume that <code class="docutils literal notranslate"><span class="pre">a</span></code> might be changed. It’s
either <code class="docutils literal notranslate"><span class="pre">b</span></code> or what <code class="docutils literal notranslate"><span class="pre">a</span></code> was before. If the type is not mutable, we
can assume the aliasing to be broken up, and if it is, we can assume
both to be the same value still.</p>
<p>When that value is a compile time constant, we will want to push it
forward, and we do that with “(Constant) Value Propagation”, which is
implemented already. We avoid too large constants, and we properly trace
value assignments, but not yet aliases.</p>
<p>In order to fully benefit from type knowledge, the new type system must
be able to be fully friends with existing built-in types, but for
classes to also work with it, it should not be tied to them. The
behavior of a type <code class="docutils literal notranslate"><span class="pre">long</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code>, etc. ought to be implemented as
far as possible with the built-in <code class="docutils literal notranslate"><span class="pre">long</span></code>, <code class="docutils literal notranslate"><span class="pre">str</span></code> at compiled time as
well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This “use the real thing” concept extends beyond builtin types, e.g.
<code class="docutils literal notranslate"><span class="pre">ctypes.c_int()</span></code> should also be used, but we must be aware of
platform dependencies. The maximum size of <code class="docutils literal notranslate"><span class="pre">ctypes.c_int</span></code> values
would be an example of that. Of course that may not be possible for
everything.</p>
<p>This approach has well proven itself with built-in functions already,
where we use real built-ins where possible to make computations. We
have the problem though that built-ins may have problems to execute
everything with reasonable compile time cost.</p>
</div>
<p>Another example, consider the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">1000000000000</span><span class="p">)</span>
</pre></div>
</div>
<p>To predict this code, calculating it at compile time using constant
operations, while feasible, puts an unacceptable burden on the
compilation.</p>
<p>Esp. we wouldn’t want to produce such a huge constant and stream it, the
C++ code would become too huge. So, we need to stop the <code class="docutils literal notranslate"><span class="pre">*</span></code> operator
from being used at compile time and cope with reduced knowledge, already
here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">10000000000000</span>
</pre></div>
</div>
<p>Instead, we would probably say that for this expression:</p>
<ul class="simple">
<li><p>The result is a <code class="docutils literal notranslate"><span class="pre">str</span></code> or a C level <code class="docutils literal notranslate"><span class="pre">PyStringObject</span> <span class="pre">*</span></code>.</p></li>
<li><p>We know its length exactly, it’s <code class="docutils literal notranslate"><span class="pre">10000000000000</span></code>.</p></li>
<li><p>Can predict every of its elements when sub-scripted, sliced, etc., if
need be, with a function we may create.</p></li>
</ul>
<p>Similar is true for this horrible (in Python2) thing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">range</span><span class="p">(</span><span class="mi">10000000000000</span><span class="p">)</span>
</pre></div>
</div>
<p>So it’s a rather general problem, this time we know:</p>
<ul class="simple">
<li><p>The result is a <code class="docutils literal notranslate"><span class="pre">list</span></code> or C level <code class="docutils literal notranslate"><span class="pre">PyListObject</span> <span class="pre">*</span></code>.</p></li>
<li><p>We know its length exactly, <code class="docutils literal notranslate"><span class="pre">10000000000000</span></code>.</p></li>
<li><p>Can predict every of its elements when index, sliced, etc., if need
be, with a function.</p></li>
</ul>
<p>Again, we wouldn’t want to create the list. Therefore Nuitka avoids
executing these calculation, when they result in constants larger than a
threshold of e.g. 256 elements. This concept has to be also applied to
large integers and more CPU and memory traps.</p>
<p>Now lets look at a more complete use case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000000000000</span><span class="p">):</span>
    <span class="n">doSomething</span><span class="p">()</span>
</pre></div>
</div>
<p>Looking at this example, one traditional way to look at it, would be to
turn <code class="docutils literal notranslate"><span class="pre">range</span></code> into <code class="docutils literal notranslate"><span class="pre">xrange</span></code>, and to note that <code class="docutils literal notranslate"><span class="pre">x</span></code> is unused. That
would already perform better. But really better is to notice that
<code class="docutils literal notranslate"><span class="pre">range()</span></code> generated values are not used at all, but only the length of
the expression matters.</p>
<p>And even if <code class="docutils literal notranslate"><span class="pre">x</span></code> were used, only the ability to predict the value from
a function would be interesting, so we would use that computation
function instead of having an iteration source. Being able to predict
from a function could mean to have Python code to do it, as well as C
code to do it. Then code for the loop can be generated without any
CPython library usage at all.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Of course, it would only make sense where such calculations are
“O(1)” complexity, i.e. do not require recursion like “n!” does.</p>
</div>
<p>The other thing is that CPython appears to at - run time - take length
hints from objects for some operations, and there it would help too, to
track length of objects, and provide it, to outside code.</p>
<p>Back to the original example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">1000000000000</span><span class="p">)</span>
</pre></div>
</div>
<p>The theme here, is that when we can’t compute all intermediate
expressions, and we sure can’t do it in the general case. But we can
still, predict some of properties of an expression result, more or less.</p>
<p>Here we have <code class="docutils literal notranslate"><span class="pre">len</span></code> to look at an argument that we know the size of.
Great. We need to ask if there are any side effects, and if there are,
we need to maintain them of course. This is already done by existing
optimization if an operation generates an exception.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The optimization of <code class="docutils literal notranslate"><span class="pre">len</span></code> has been implemented and works for all
kinds of container creation and ranges.</p>
</div>
</section>
<section id="applying-this-to-ctypes">
<h3>Applying this to “ctypes”<a class="headerlink" href="#applying-this-to-ctypes" title="Permalink to this headline"></a></h3>
<p>The <em>not so specific</em> problem to be solved to understand <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>
declarations is maybe as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ctypes</span>
</pre></div>
</div>
<p>This leads to Nuitka in its tree to have an assignment from a
<code class="docutils literal notranslate"><span class="pre">__import__</span></code> expression to the variable <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>. It can be
predicted by default to be a module object, and even better, it can be
known as <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> from standard library with more or less certainty.
See the section about “Importing”.</p>
<p>So that part is “easy”, and it’s what will happen. During optimization,
when the module <code class="docutils literal notranslate"><span class="pre">__import__</span></code> expression is examined, it should say:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ctypes</span></code> is a module</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ctypes</span></code> is from standard library (if it is, might not be true)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ctypes</span></code> then has code behind it, called <code class="docutils literal notranslate"><span class="pre">ModuleFriend</span></code> that
knows things about it attributes, that should be asked.</p></li>
</ul>
<p>The later is the generic interface, and the optimization should connect
the two, of course via package and module full names. It will need a
<code class="docutils literal notranslate"><span class="pre">ModuleFriendRegistry</span></code>, from which it can be pulled. It would be nice
if we can avoid <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> to be loaded into Nuitka unless necessary, so
these need to be more like a plug-in, loaded only if necessary, i.e. the
user code actually uses <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>.</p>
<p>Coming back to the original expression, it also contains an assignment
expression, because it re-formulated to be more like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ctypes</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;ctypes&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The assigned to object, simply gets the type inferred propagated as part
of an SSA form. Ideally, we could be sure that nothing in the program
changes the variable, and therefore have only one version of that
variable.</p>
<p>For module variables, when the execution leaves the module to unknown
code, or unclear code, it might change the variable. Therefore, likely
we will often only assume that it could still be <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>, but also
something else.</p>
<p>Depending on how well we control module variable assignment, we can
decide this more of less quickly. With “compiled modules” types, the
expectation is that it’s merely a quick C <code class="docutils literal notranslate"><span class="pre">==</span></code> comparison check. The
module friend should offer code to allow a check if it applies, for
uncertain cases.</p>
<p>Then when we come to uses of it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">()</span>
</pre></div>
</div>
<p>At this point, using SSA, we are more of less sure, that <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> is
at that point the module, and that we know what it’s <code class="docutils literal notranslate"><span class="pre">c_int</span></code> attribute
is, at compile time, and what it’s call result is. We will use the
module friend to help with that. It will attach knowledge about the
result of that expression during the SSA collection process.</p>
<p>This is more like a value forward propagation than anything else. In
fact, constant propagation should only be the special case of it, and
one design goal of Nuitka was always to cover these two cases with the
same code.</p>
</section>
<section id="excursion-to-functions">
<h3>Excursion to Functions<a class="headerlink" href="#excursion-to-functions" title="Permalink to this headline"></a></h3>
<p>In order to decide what this means to functions and their call
boundaries, if we propagate forward, how to handle this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span>
</pre></div>
</div>
<p>We annotate that <code class="docutils literal notranslate"><span class="pre">a</span></code> is first a “unknown but defined parameter
object”, then later on something that definitely has an <code class="docutils literal notranslate"><span class="pre">append</span></code>
attribute, when returned, as otherwise an exception occurs.</p>
<p>The type of <code class="docutils literal notranslate"><span class="pre">a</span></code> changes to that after <code class="docutils literal notranslate"><span class="pre">a.append</span></code> look-up succeeds.
It might be many kinds of an object, but e.g. it could have a higher
probability of being a <code class="docutils literal notranslate"><span class="pre">PyListObject</span></code>. And we would know it cannot be
a <code class="docutils literal notranslate"><span class="pre">PyStringObject</span></code>, as that one has no <code class="docutils literal notranslate"><span class="pre">append</span></code> method, and would
have raised an exception therefore.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If classes, i.e. other types in the program, have an <code class="docutils literal notranslate"><span class="pre">append</span></code>
attribute, it should play a role too, there needs to be a way to
plug-in to this decisions.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>On the other hand, types without <code class="docutils literal notranslate"><span class="pre">append</span></code> attribute can be
eliminated.</p>
</div>
<p>Therefore, functions through SSA provide an automatic analysis on their
return state, or return value types, or a quick way to predict return
value properties, based on input value knowledge.</p>
<p>So this could work:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">my_append</span><span class="p">([],</span> <span class="mi">3</span><span class="p">)</span>

<span class="k">assert</span> <span class="n">b</span> <span class="o">==</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># Could be decided now</span>
</pre></div>
</div>
<p>Goal: The structure we use makes it easy to tell what <code class="docutils literal notranslate"><span class="pre">my_append</span></code> may
be. So, there should be a means to ask it about call results with given
type/value information. We need to be able to tell, if evaluating
<code class="docutils literal notranslate"><span class="pre">my_append</span></code> makes sense with given parameters or not, if it does
impact the return value.</p>
<p>We should e.g. be able to make <code class="docutils literal notranslate"><span class="pre">my_append</span></code> tell, one or more of these:</p>
<ul class="simple">
<li><p>Returns the first parameter value as return value (unless it raises
an exception).</p></li>
<li><p>The return value has the same type as <code class="docutils literal notranslate"><span class="pre">a</span></code> (unless it raises an
exception).</p></li>
<li><p>The return value has an <code class="docutils literal notranslate"><span class="pre">append</span></code> attribute.</p></li>
<li><p>The return value might be a <code class="docutils literal notranslate"><span class="pre">list</span></code> object.</p></li>
<li><p>The return value may not be a <code class="docutils literal notranslate"><span class="pre">str</span></code> object.</p></li>
<li><p>The function will raise if first argument has no <code class="docutils literal notranslate"><span class="pre">append</span></code>
attribute.</p></li>
</ul>
<p>The exactness of statements may vary. But some things may be more
interesting. If e.g. the aliasing of a parameter value to the return
value is known exactly, then information about it need to all be given
up, but some can survive.</p>
<p>It would be nice, if <code class="docutils literal notranslate"><span class="pre">my_append</span></code> had sufficient information, so we
could specialize with <code class="docutils literal notranslate"><span class="pre">list</span></code> and <code class="docutils literal notranslate"><span class="pre">int</span></code> from the parameters, and then
e.g. know at least some things that it does in that case. Such
specialization would have to be decided if it makes sense. In the
alternative, it could be done for each variant anyway, as there won’t be
that many of them.</p>
<p>Doing this “forward” analysis appears to be best suited for functions
and therefore long term. We will try it that way.</p>
</section>
<section id="excursion-to-loops">
<h3>Excursion to Loops<a class="headerlink" href="#excursion-to-loops" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># think loop: here</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>

    <span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
        <span class="k">break</span>

<span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>The handling of loops (both <code class="docutils literal notranslate"><span class="pre">for</span></code> and <code class="docutils literal notranslate"><span class="pre">while</span></code> are re-formulated to
this kind of loops with <code class="docutils literal notranslate"><span class="pre">break</span></code> statements) has its own problem. The
loop start and may have an assumption from before it started, that <code class="docutils literal notranslate"><span class="pre">a</span></code>
is constant, but that is only true for the first iteration. So, we can’t
pass knowledge from outside loop forward directly into the for loop
body.</p>
<p>So the collection for loops needs to be two pass for loops. First, to
collect assignments, and merge these into the start state, before
entering the loop body. The need to make two passes is special to loops.</p>
<p>For a start, it is done like this. At loop entry, all pre-existing, but
written traces, are turned into loop merges. Knowledge is not completely
removed about everything assigned or changed in the loop, but then it’s
not trusted anymore.</p>
<p>From that basis, the <code class="docutils literal notranslate"><span class="pre">break</span></code> exits are analysed, and merged, building
up the post loop state, and <code class="docutils literal notranslate"><span class="pre">continue</span></code> exits of the loop replacing the
unknown part of the loop entry state. The loop end is considered a
<code class="docutils literal notranslate"><span class="pre">continue</span></code> for this purpose.</p>
</section>
<section id="excursion-to-conditions">
<h3>Excursion to Conditions<a class="headerlink" href="#excursion-to-conditions" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The above code contains a condition, and these have the problem, that
when exiting the conditional block, a merge must be done, of the <code class="docutils literal notranslate"><span class="pre">x</span></code>
versions. It could be either one. The merge may trace the condition
under which a choice is taken. That way, we could decide pairs of traces
under the same condition.</p>
<p>These merges of SSA variable “versions”, represent alternative values.
They pose difficulties, and might have to be reduced to commonality. In
the above example, the <code class="docutils literal notranslate"><span class="pre">&lt;</span></code> operator will have to check for each
version, and then to decide that both indeed give the same result.</p>
<p>The trace collection tracks variable changes in conditional branches,
and then merges the existing state at conditional statement exits.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A branch is considered “exiting” if it is not abortive. Should it end
in a <code class="docutils literal notranslate"><span class="pre">raise</span></code>, <code class="docutils literal notranslate"><span class="pre">break</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, or <code class="docutils literal notranslate"><span class="pre">return</span></code>, there is no
need to merge that branch, as execution of that branch is terminated.</p>
<p>Should both branches be abortive, that makes things really simple, as
there is no need to even continue.</p>
<p>Should only one branch exist, but be abortive, then no merge is
needed, and the collection can assume after the conditional
statement, that the branch was not taken, and continue.</p>
</div>
<p>When exiting both the branches, these branches must both be merged, with
their new information.</p>
<p>In the above case:</p>
<ul class="simple">
<li><p>The “yes” branch knows variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is an <code class="docutils literal notranslate"><span class="pre">int</span></code> of constant value
<code class="docutils literal notranslate"><span class="pre">1</span></code></p></li>
<li><p>The “no” branch knows variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is an <code class="docutils literal notranslate"><span class="pre">int</span></code> of constant value
<code class="docutils literal notranslate"><span class="pre">2</span></code></p></li>
</ul>
<p>That might be collapsed to:</p>
<ul class="simple">
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">x</span></code> is an integer of value in <code class="docutils literal notranslate"><span class="pre">(1,2)</span></code></p></li>
</ul>
<p>Given this, we then should be able to pre-compute the value of this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The comparison operator can therefore decide and tell:</p>
<ul class="simple">
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">b</span></code> is a boolean of constant value <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ul>
<p>Were it unable to decide, it would still be able to say:</p>
<ul class="simple">
<li><p>The variable <code class="docutils literal notranslate"><span class="pre">b</span></code> is a boolean.</p></li>
</ul>
<p>For conditional statements optimization, it’s also noteworthy, that the
condition is known to pass or not pass the truth check, inside branches,
and in the case of non-exiting single branches, after the statement it’s
not true.</p>
<p>We may want to take advantage of it. Consider e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>
</pre></div>
</div>
<p>In this case, the knowledge that <code class="docutils literal notranslate"><span class="pre">a</span></code> is a list, could be used to
generate better code and with the definite knowledge that <code class="docutils literal notranslate"><span class="pre">a</span></code> is of
type list. With that knowledge the <code class="docutils literal notranslate"><span class="pre">append</span></code> attribute call will become
the <code class="docutils literal notranslate"><span class="pre">list</span></code> built-in type operation.</p>
</section>
<section id="excursion-to-return-statements">
<h3>Excursion to <code class="docutils literal notranslate"><span class="pre">return</span></code> statements<a class="headerlink" href="#excursion-to-return-statements" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">return</span></code> statement (like <code class="docutils literal notranslate"><span class="pre">break</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, <code class="docutils literal notranslate"><span class="pre">raise</span></code>) is
“aborting” to control flow. It is always the last statement of inspected
block. When there statements to follow it, optimization will remove it
as “dead code”.</p>
<p>If all branches of a conditional statement are “aborting”, the statement
is decided “aborting” too. If a loop doesn’t abort with a break, it
should be considered “aborting” too.</p>
</section>
<section id="excursion-to-yield-expressions">
<h3>Excursion to <code class="docutils literal notranslate"><span class="pre">yield</span></code> expressions<a class="headerlink" href="#excursion-to-yield-expressions" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">yield</span></code> expression can be treated like a normal function call, and
as such invalidates some known constraints just as much as they do. It
executes outside code for an unknown amount of time, and then returns,
with little about the outside world known anymore, if it’s accessible
from there.</p>
</section>
<section id="mixed-types">
<h3>Mixed Types<a class="headerlink" href="#mixed-types" title="Permalink to this headline"></a></h3>
<p>Consider the following inside a function or module:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">something</span><span class="p">()</span> <span class="k">if</span> <span class="n">cond</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">()</span>
</pre></div>
</div>
<p>A programmer will often not make a difference between <code class="docutils literal notranslate"><span class="pre">list</span></code> and
<code class="docutils literal notranslate"><span class="pre">tuple</span></code>. In fact, using a <code class="docutils literal notranslate"><span class="pre">tuple</span></code> is a good way to express that
something won’t be changed later, as these are mutable.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Better programming style, would be to use this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cond</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">something</span><span class="p">()</span> <span class="k">if</span> <span class="n">cond</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">()</span>
</pre></div>
</div>
<p>People don’t do it, because they dislike the performance hit
encountered by the generator expression being used to initialize the
tuple. But it would be more consistent, and so Nuitka is using it,
and of course one day Nuitka ought to be able to make no difference
in performance for it.</p>
</div>
<p>To Nuitka though this means, that if <code class="docutils literal notranslate"><span class="pre">cond</span></code> is not predictable, after
the conditional statement we may either have a <code class="docutils literal notranslate"><span class="pre">tuple</span></code> or a <code class="docutils literal notranslate"><span class="pre">list</span></code>
type object in <code class="docutils literal notranslate"><span class="pre">a</span></code>. In order to represent that without resorting to “I
know nothing about it”, we need a kind of <code class="docutils literal notranslate"><span class="pre">min</span></code>/<code class="docutils literal notranslate"><span class="pre">max</span></code> operating
mechanism that is capable of say what is common with multiple
alternative values.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this time, we don’t really have that mechanism to find the
commonality between values.</p>
</div>
</section>
<section id="back-to-ctypes">
<h3>Back to “ctypes”<a class="headerlink" href="#back-to-ctypes" title="Permalink to this headline"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">()</span>
</pre></div>
</div>
<p>Coming back to this example, we needed to propagate <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>, then we
can propagate “something” from <code class="docutils literal notranslate"><span class="pre">ctypes.int</span></code> and then known what this
gives with a call and no arguments, so the walk of the nodes, and
diverse operations should be addressed by a module friend.</p>
<p>In case a module friend doesn’t know what to do, it needs to say so by
default. This should be enforced by a base class and give a warning or
note.</p>
</section>
<section id="now-to-the-interface">
<h3>Now to the interface<a class="headerlink" href="#now-to-the-interface" title="Permalink to this headline"></a></h3>
<p>The following is the intended interface:</p>
<ul>
<li><p>Iteration with node methods <code class="docutils literal notranslate"><span class="pre">computeStatement</span></code> and
<code class="docutils literal notranslate"><span class="pre">computeExpression</span></code>.</p>
<p>These traverse modules and functions (i.e. scopes) and visit
everything in the order that Python executes it. The visiting object
is <code class="docutils literal notranslate"><span class="pre">TraceCollection</span></code> and pass forward. Some node types, e.g.
<code class="docutils literal notranslate"><span class="pre">StatementConditional</span></code> new create branch trace collections and
handle the SSA merging at exit.</p>
</li>
<li><p>Replacing nodes during the visit.</p>
<p>Both <code class="docutils literal notranslate"><span class="pre">computeStatement</span></code> and <code class="docutils literal notranslate"><span class="pre">computeExpression</span></code> are tasked to
return potential replacements of themselves, together with “tags”
(meaningless now), and a “message”, used for verbose tracing.</p>
<p>The replacement node of <code class="docutils literal notranslate"><span class="pre">+</span></code> operator, may e.g. be the pre-computed
constant result, wrapped in side effects of the node, or the
expression raised, again wrapped in side effects.</p>
</li>
<li><p>Assignments and references affect SSA.</p>
<p>The SSA tree is initialized every time a scope is visited. Then
during traversal, traces are built up. Every assignment and merge
starts a new trace for that matter. References to a given variable
version are traced that way.</p>
</li>
<li><p>Value escapes are traced too.</p>
<p>When an operation hands over a value to outside code, it indicates so
to the trace collection. This is for it to know, when e.g. a constant
value, might be mutated meanwhile.</p>
</li>
<li><p>Nodes can be queried about their properties.</p>
<p>There is a type shape and a value shape that each node can be asked
about. The type shape offers methods that allow to check if certain
operations are at all supported or not. These can always return
<code class="docutils literal notranslate"><span class="pre">True</span></code> (yes), <code class="docutils literal notranslate"><span class="pre">False</span></code> (no), and <code class="docutils literal notranslate"><span class="pre">None</span></code> (cannot decide). In the
case of the later, optimizations may not be able do much about it.
Lets call these values “tri-state”.</p>
<p>There is also the value shape of a node. This can go deeper, and be
more specific to a given node.</p>
<p>The default implementation will be very pessimistic. Specific node
types and shapes may then declare, that they e.g. have no side
effects, will not raise for certain operations, have a known truth
value, have a known iteration length, can predict their iteration
values, etc.</p>
</li>
<li><p>Nodes are linked to certain states.</p>
<p>During the collect, a variable reference, is linked to a certain
trace state, and that can be used by parent operations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span>
</pre></div>
</div>
<p>In this example, the references to <code class="docutils literal notranslate"><span class="pre">a</span></code>, can look-up the <code class="docutils literal notranslate"><span class="pre">1</span></code> in
the trace, and base value shape response to <code class="docutils literal notranslate"><span class="pre">+</span></code> on it. For compile
time evaluation, it may also ask <code class="docutils literal notranslate"><span class="pre">isCompileTimeConstant()</span></code> and if
both nodes will respond <code class="docutils literal notranslate"><span class="pre">True</span></code>, then “getCompileTimeConstant()”
will return <code class="docutils literal notranslate"><span class="pre">1</span></code>, which will be be used in computation.</p>
<p>Then <code class="docutils literal notranslate"><span class="pre">extractSideEffects()</span></code> for the <code class="docutils literal notranslate"><span class="pre">a</span></code> reference will return
<code class="docutils literal notranslate"><span class="pre">()</span></code> and therefore, the result <code class="docutils literal notranslate"><span class="pre">2</span></code> will not be wrapped.</p>
<p>An alternative approach would be <code class="docutils literal notranslate"><span class="pre">hasTypeSlotAdd()</span></code> on the both
nodes, and they both do, to see if the selection mechanism used by
CPython can be used to find which types <code class="docutils literal notranslate"><span class="pre">+</span></code> should be used.</p>
</li>
<li><p>Class for module import expression <code class="docutils literal notranslate"><span class="pre">ExpressionImportModule</span></code>.</p>
<p>This one just knows that something is imported, but not how or what
it is assigned to. It will be able in a recursive compile, to provide
the module as an assignment source, or the module variables or
submodules as an attribute source when referenced from a variable
trace or in an expression.</p>
</li>
<li><p>Base class for module friend <code class="docutils literal notranslate"><span class="pre">ModuleFriendBase</span></code>.</p>
<p>This is intended to provide something to overload, which e.g. can
handle <code class="docutils literal notranslate"><span class="pre">math</span></code> in a better way.</p>
</li>
<li><p>Module <code class="docutils literal notranslate"><span class="pre">ModuleFriendRegistry</span></code></p>
<p>Provides a register function with <code class="docutils literal notranslate"><span class="pre">name</span></code> and instances of
<code class="docutils literal notranslate"><span class="pre">ValueFriendModuleBase</span></code> to be registered. Recursed to modules
should integrate with that too. The registry could well be done with
a metaclass approach.</p>
</li>
<li><p>The module friends should each live in a module of their own.</p>
<p>With a naming policy to be determined. These modules should add
themselves via above mechanism to <code class="docutils literal notranslate"><span class="pre">ModuleFriendRegistry</span></code> and all
shall be imported and register. Importing of e.g. <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> should
be delayed to when the friend is actually used. A meta class should
aid this task.</p>
<p>The delay will avoid unnecessary blot of the compiler at run time, if
no such module is used. For “qt” and other complex stuff, this will
be a must.</p>
</li>
<li><p>The walk should initially be single pass, and not maintain history.</p>
<p>Instead optimization that needs to look at multiple things, e.g.
“unused assignment”, will look at the whole SSA collection
afterwards.</p>
</li>
</ul>
</section>
<section id="discussing-with-examples">
<h3>Discussing with examples<a class="headerlink" href="#discussing-with-examples" title="Permalink to this headline"></a></h3>
<p>The following examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assignment, the source decides the type of the assigned expression</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">b</span>

<span class="c1"># Operator &quot;attribute look-up&quot;, the looked up expression &quot;ctypes&quot; decides</span>
<span class="c1"># via its trace.</span>
<span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>

<span class="c1"># Call operator, the called expressions decides with help of arguments,</span>
<span class="c1"># which have been walked, before the call itself.</span>
<span class="n">called_expression_of_any_complexity</span><span class="p">()</span>

<span class="c1"># import gives a module any case, and the &quot;ModuleRegistry&quot; may say more.</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="c1"># From import need not give module, &quot;x&quot; decides what it is.</span>
<span class="kn">from</span> <span class="nn">x</span> <span class="kn">import</span> <span class="n">y</span>

<span class="c1"># Operations are decided by arguments, and CPython operator rules between</span>
<span class="c1"># argument states.</span>
<span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</pre></div>
</div>
<p>The optimization is mostly performed by walking of the tree and
performing trace collection. When it encounters assignments and
references to them, it considers current state of traces and uses it for
<code class="docutils literal notranslate"><span class="pre">computeExpression</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Assignments to attributes, indexes, slices, etc. will also need to
follow the flow of <code class="docutils literal notranslate"><span class="pre">append</span></code>, so it cannot escape attention that a
list may be modified. Usages of <code class="docutils literal notranslate"><span class="pre">append</span></code> that we cannot be sure
about, must be traced to exist, and disallow the list to be
considered known value again.</p>
</div>
</section>
<section id="code-generation-impact">
<h3>Code Generation Impact<a class="headerlink" href="#code-generation-impact" title="Permalink to this headline"></a></h3>
<p>Right now, code generation assumes that everything is a <code class="docutils literal notranslate"><span class="pre">PyObject</span> <span class="pre">*</span></code>,
i.e. a Python object, and does not take knowledge of <code class="docutils literal notranslate"><span class="pre">int</span></code> or other
types into consideration at all, and it should remain like that for some
time to come.</p>
<p>Instead, <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> value friend will be asked give <code class="docutils literal notranslate"><span class="pre">Identifiers</span></code>,
like other codes do too. And these need to be able to convert themselves
to objects to work with the other things.</p>
<p>But Code Generation should no longer require that operations must be
performed on that level. Imagine e.g. the following calls:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">c_call</span><span class="p">(</span><span class="n">other_c_call</span><span class="p">())</span>
</pre></div>
</div>
<p>Value returned by “other_c_call()” of say <code class="docutils literal notranslate"><span class="pre">c_int</span></code> type, should be
possible to be fed directly into another call. That should be easy by
having a <code class="docutils literal notranslate"><span class="pre">asIntC()</span></code> in the identifier classes, which the <code class="docutils literal notranslate"><span class="pre">ctypes</span></code>
Identifiers handle without conversions.</p>
<p>Code Generation should one day also become able to tell that all uses of
a variable have only <code class="docutils literal notranslate"><span class="pre">c_int</span></code> value, and use <code class="docutils literal notranslate"><span class="pre">int</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">PyObjectLocalVariable</span></code> more or less directly. We could consider
<code class="docutils literal notranslate"><span class="pre">PyIntLocalVariable</span></code> of similar complexity as <code class="docutils literal notranslate"><span class="pre">int</span></code> after the C++
compiler performed its in-lining.</p>
<p>Such decisions would be prepared by finalization, which then would track
the history of values throughout a function or part of it.</p>
</section>
<section id="initial-implementation">
<h3>Initial Implementation<a class="headerlink" href="#initial-implementation" title="Permalink to this headline"></a></h3>
<p>The basic interface will be added to <em>all</em> expressions and a node may
override it, potentially using trace collection state, as attached
during <code class="docutils literal notranslate"><span class="pre">computeExpression</span></code>.</p>
<section id="goal-1-reached">
<h4>Goal 1 (Reached)<a class="headerlink" href="#goal-1-reached" title="Permalink to this headline"></a></h4>
<p>Initially most things will only be able to give up on about anything.
And it will be little more than a tool to do simple look-ups in a
general form. It will then be the first goal to turn the following code
into better performing one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">7</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>and then:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>and then:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>This depends on SSA form to be able to tell us the values of <code class="docutils literal notranslate"><span class="pre">a</span></code>,
<code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> to be written to by constants, which can be forward
propagated at no cost.</p>
</section>
<section id="goal-2-reached">
<h4>Goal 2 (Reached)<a class="headerlink" href="#goal-2-reached" title="Permalink to this headline"></a></h4>
<p>The assignments to <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> shall all become prey to
“unused” assignment analysis in the next step. They are all only
assigned to, and the assignment source has no effect, so they can be
simply dropped.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>In the SSA form, these are then assignments without references. These
assignments, can be removed if the assignment source has no side effect.
Or at least they could be made “anonymous”, i.e. use a temporary
variable instead of the named one. That would have to take into account
though, that the old version still needs a release.</p>
<p>The most general form would first merely remove assignments that have no
impact, and leave the value as a side effect, so we arrive at this
first:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">3</span>
<span class="mi">7</span>
<span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>When applying the removal of expression only statements without effect,
this gives us:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>which is the perfect result. Doing it in one step would only be an
optimization at the cost of generalization.</p>
<p>In order to be able to manipulate nodes related to a variable trace, we
need to attach the nodes that did it. Consider this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">cond</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">elif</span> <span class="n">other</span><span class="p">():</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Not using &quot;x&quot;.</span>
<span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>In the above case, the merge of the value traces, should say that <code class="docutils literal notranslate"><span class="pre">x</span></code>
may be undefined, or one of <code class="docutils literal notranslate"><span class="pre">1</span></code> or <code class="docutils literal notranslate"><span class="pre">3</span></code>, but since <code class="docutils literal notranslate"><span class="pre">x</span></code> is not used,
apply the “dead value” trick to each branch.</p>
<p>The removal of the “merge” of the 3 <code class="docutils literal notranslate"><span class="pre">x</span></code> versions, should exhibit that
the other versions are also only assigned to, and can be removed. These
merges of course appear as usages of the <code class="docutils literal notranslate"><span class="pre">x</span></code> versions.</p>
</section>
<section id="goal-3">
<h4>Goal 3<a class="headerlink" href="#goal-3" title="Permalink to this headline"></a></h4>
<p>Then third goal is to understand all of this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are many operations in this, and all of them should be properly
handled, or at least ignored in safe way.</p>
</div>
<p>The first goal code gave us that the <code class="docutils literal notranslate"><span class="pre">list</span></code> has an annotation from the
assignment of <code class="docutils literal notranslate"><span class="pre">[]</span></code> and that it will be copied to <code class="docutils literal notranslate"><span class="pre">a</span></code> until the for
loop in encountered. Then it must be removed, because the <code class="docutils literal notranslate"><span class="pre">for</span></code> loop
somehow says so.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">a</span></code> may change its value, due to the unknown attribute look-up of
it already, not even the call. The for loop must be able to say “may
change value” due to that, of course also due to the call of that
attribute too.</p>
<p>The code should therefore become equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>But no other changes must occur, especially not to the <code class="docutils literal notranslate"><span class="pre">return</span></code>
statement, it must not assume <code class="docutils literal notranslate"><span class="pre">a</span></code> to be constant “[]” but an unknown
<code class="docutils literal notranslate"><span class="pre">a</span></code> instead.</p>
<p>With that, we would handle this code correctly and have some form
constant value propagation in place, handle loops at least correctly,
and while it is not much, it is important demonstration of the concept.</p>
</section>
<section id="goal-4">
<h4>Goal 4<a class="headerlink" href="#goal-4" title="Permalink to this headline"></a></h4>
<p>The fourth goal is to understand the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">cond</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span>
</pre></div>
</div>
<p>In this we have a branch, and we will be required to keep track of both
the branches separately, and then to merge with the original knowledge.
After the conditional statement we will know that “x” is an “int” with
possible values in <code class="docutils literal notranslate"><span class="pre">(1,2)</span></code>, which can be used to predict that the
return value is always <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>The forth goal will therefore be that the “ValueFriendConstantList”
knows that append changes <code class="docutils literal notranslate"><span class="pre">a</span></code> value, but it remains a list, and that
the size increases by one. It should provide an other value friend
“ValueFriendList” for “a” due to that.</p>
<p>In order to do that, such code must be considered:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
<p>It will be good, if <code class="docutils literal notranslate"><span class="pre">len</span></code> still knows that <code class="docutils literal notranslate"><span class="pre">a</span></code> is a list object, but
not the constant list anymore.</p>
<p>From here, work should be done to demonstrate the correctness of it with
the basic tests applied to discover undetected issues.</p>
<p>Fifth and optional goal: Extra bonus points for being able to track and
predict <code class="docutils literal notranslate"><span class="pre">append</span></code> to update the constant list in a known way. Using
<code class="docutils literal notranslate"><span class="pre">list.append</span></code> that should be done and lead to a constant result of
<code class="docutils literal notranslate"><span class="pre">len</span></code> being used.</p>
<p>The sixth and challenging goal will be to make the code generation be
impacted by the value friends types. It should have a knowledge that
<code class="docutils literal notranslate"><span class="pre">PyList_Append</span></code> does the job of append and use <code class="docutils literal notranslate"><span class="pre">PyList_Size</span></code> for
<code class="docutils literal notranslate"><span class="pre">len</span></code>. The “ValueFriends” should aid the code generation too.</p>
<p>Last and right now optional goal will be to make <code class="docutils literal notranslate"><span class="pre">range</span></code> have a value
friend, that can interact with iteration of the for loop, and <code class="docutils literal notranslate"><span class="pre">append</span></code>
of the <code class="docutils literal notranslate"><span class="pre">list</span></code> value friend, so it knows it’s possible to iterate 5000
times, and that “a” has then after the “loop” this size, so <code class="docutils literal notranslate"><span class="pre">len(a)</span></code>
could be predicted. For during the loop, about a the range of its length
should be known to be less than 5000. That would make the code of goal 2
completely analyzed at compile time.</p>
</section>
</section>
<section id="limitations-for-now">
<h3>Limitations for now<a class="headerlink" href="#limitations-for-now" title="Permalink to this headline"></a></h3>
<ul>
<li><p>Aim only for limited examples. For <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> that means to compile
time evaluate:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span>
</pre></div>
</div>
<p>Later then call to “libc” or something else universally available,
e.g. “strlen()” or “strcmp()” from full blown declarations of the
callable.</p>
</li>
<li><p>We won’t have the ability to test that optimization are actually
performed, we will check the generated code by hand.</p>
<p>With time, we will add XML based checks with “xpath” queries,
expressed as hints, but that is some work that will be based on this
work here. The “hints” fits into the “ValueFriends” concept nicely or
so the hope is.</p>
</li>
<li><p>No inter-function optimization functions yet</p>
<p>Of course, once in place, it will make the <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> annotation even
more usable. Using <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> objects inside functions, while
creating them on the module level, is therefore not immediately going
to work.</p>
</li>
<li><p>No loops yet</p>
<p>Loops break value propagation. For the <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> use case, this
won’t be much of a difficulty. Due to the strangeness of the task, it
should be tackled later on at a higher priority.</p>
</li>
<li><p>Not too much.</p>
<p>Try and get simple things to work now. We shall see, what kinds of
constraints really make the most sense. Understanding <code class="docutils literal notranslate"><span class="pre">list</span></code>
subscript/slice values e.g. is not strictly useful for much code and
should not block us.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This design is not likely to be the final one.</p>
</div>
</section>
</section>
<section id="how-to-make-features-experimental">
<h2>How to make Features Experimental<a class="headerlink" href="#how-to-make-features-experimental" title="Permalink to this headline"></a></h2>
<p>Every experimental feature needs a name. We have a rule to pick a name
with lower case and <code class="docutils literal notranslate"><span class="pre">_</span></code> as separators. An example of with would be the
name <code class="docutils literal notranslate"><span class="pre">jinja_generated_add</span></code> that has been used in the past.</p>
<section id="command-line">
<h3>Command Line<a class="headerlink" href="#command-line" title="Permalink to this headline"></a></h3>
<p>Experimental features are enabled with the command line argument</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nuitka --experimental<span class="o">=</span>jinja_generated_add ...
</pre></div>
</div>
</section>
<section id="in-c-code">
<h3>In C code<a class="headerlink" href="#in-c-code" title="Permalink to this headline"></a></h3>
<p>In Scons, all experimental features automatically are converted into C
defines, and can be used like this:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifdef _NUITKA_EXPERIMENTAL_JINJA_GENERATED_ADD</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;HelpersOperationGeneratedBinaryAdd.c&quot;</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;HelpersOperationBinaryAdd.c&quot;</span><span class="cp"></span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>The C pre-processor is the only thing that makes an experimental feature
usable.</p>
</section>
<section id="in-python">
<h3>In Python<a class="headerlink" href="#in-python" title="Permalink to this headline"></a></h3>
<p>You can query experimental features using <code class="docutils literal notranslate"><span class="pre">Options.isExperimental()</span></code>
with e.g. code like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Options</span><span class="o">.</span><span class="n">isExperimental</span><span class="p">(</span><span class="s2">&quot;use_feature&quot;</span><span class="p">):</span>
    <span class="n">experimental_code</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">standard_code</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="when-to-use-it">
<h3>When to use it<a class="headerlink" href="#when-to-use-it" title="Permalink to this headline"></a></h3>
<p>Often we need to keep feature in parallel because they are not finished,
or need to be tested after merge and should not break. Then we can do
code changes that will not make a difference except when the
experimental flag is given on the command line to Nuitka.</p>
<p>The testing of Nuitka is very heavy weight when e.g. all Python code is
compiled, and very often, it is interesting to compare behavior with and
without a change.</p>
</section>
<section id="when-to-remove-it">
<h3>When to remove it<a class="headerlink" href="#when-to-remove-it" title="Permalink to this headline"></a></h3>
<p>When a feature becomes default, we might choose to keep the old variant
around, but normally we do not. Then we remove the <code class="docutils literal notranslate"><span class="pre">if</span></code> and <code class="docutils literal notranslate"><span class="pre">#if</span></code>
checks and drop the old code.</p>
<p>At this time, large scale testing will have demonstrated the viability
of the code.</p>
</section>
</section>
<section id="adding-dependencies-to-nuitka">
<h2>Adding dependencies to Nuitka<a class="headerlink" href="#adding-dependencies-to-nuitka" title="Permalink to this headline"></a></h2>
<p>First of all, there is an important distinction to make, runtime or
development time. The first kind of dependency is used when Nuitka is
executing.</p>
<section id="adding-a-runtime-dependency">
<h3>Adding a Runtime Dependency<a class="headerlink" href="#adding-a-runtime-dependency" title="Permalink to this headline"></a></h3>
<p>This is the kind of dependency that is the most scrutinized. As we want
Nuitka to run on latest greatest Python as well as relatively old ones,
we have to be very careful with these ones.</p>
<p>There is also a distinction of optional dependencies. Right now e.g. the
<code class="docutils literal notranslate"><span class="pre">lxml</span></code> package is relatively optional, and Nuitka can work without it
being installed, because e.g. on some platforms it will not be easy to
do so. That bar has lifted somewhat, but it means e.g. that XML based
optimization tests are not run with all Python versions.</p>
<p>The list of runtime dependencies is in <code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> and it is
for those the case, that they are not really required to be installed by
the user, consider this snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Folders to use for cache files.</span>
<span class="n">appdirs</span>

<span class="c1"># Scons is the backend building tool to turn C files to binaries.</span>
<span class="n">scons</span>
</pre></div>
</div>
<p>For both these dependencies, there is either an inline copy (Scons) that
we handle to use in case, if Scons is not available (in fact we have a
version that works with Python 2.6 and 2.7 still), and also the same for
appdirs and every dependency.</p>
<p>But since inline copies are against the rules on some platforms that
still do not contain the package, we often even have our own wrapper
which provides a minimal fallback or exposes a sane interface for the
subset of functionality that we use.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Therefore, please if you consider adding one of these, get in touch
with <code class="docutils literal notranslate"><span class="pre">&#64;Nuitka-pushers</span></code> first and get a green light.</p>
</div>
</section>
<section id="adding-a-development-dependency">
<h3>Adding a Development Dependency<a class="headerlink" href="#adding-a-development-dependency" title="Permalink to this headline"></a></h3>
<p>A typical example of a development dependency is <code class="docutils literal notranslate"><span class="pre">black</span></code> which is used
by our autoformat tool, and then in turn by the git pre-commit hook. It
is used to format source code, and doesn’t have a role at run time of
the actual compiler code of Nuitka.</p>
<p>Much less strict rules apply to these in comparison to runtime
dependencies. Generally please take care that the tool must be well
maintained an available on newer Pythons. Then we can use it, no problem
normally. But if it’s really big, say all of SciPy, we might want to
justify it a bit better.</p>
<p>The list of development dependencies is in <code class="docutils literal notranslate"><span class="pre">requirements-devel.txt</span></code>
and it is for example like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Autoformat needs this</span>
<span class="n">rstfmt</span> <span class="o">==</span> <span class="mf">0.0.10</span> <span class="p">;</span> <span class="n">python_version</span> <span class="o">&gt;=</span> <span class="s1">&#39;3.7&#39;</span>
</pre></div>
</div>
<p>We always add the version, so that when tests run on as old versions as
Python 2.6, the installation would fail with that version, so we need to
make a version requirement. Sometimes we use older versions for Python2
than for Python3, <code class="docutils literal notranslate"><span class="pre">Jinaj2</span></code> being a notable candidate, but generally we
ought to avoid that. For many tools only being available for currently
3.7 or higher is good enough, esp. if they are run as development tools,
like <code class="docutils literal notranslate"><span class="pre">autoformat-nuitka-source</span></code> is.</p>
</section>
</section>
<section id="idea-bin">
<h2>Idea Bin<a class="headerlink" href="#idea-bin" title="Permalink to this headline"></a></h2>
<p>This an area where to drop random ideas on our minds, to later sort it
out, and out it into action, which could be code changes, plan changes,
issues created, etc.</p>
<ul>
<li><p>Make “SELECT_METACLASS” meta class selection transparent.</p>
<p>Looking at the “SELECT_METACLASS” it should become an anonymous
helper function. In that way, the optimization process can remove
choices at compile time, and e.g. in-line the effect of a meta class,
if it is known.</p>
<p>This of course makes most sense, if we have the optimizations in
place that will allow this to actually happen.</p>
</li>
<li><p>Keeping track of iterations</p>
<p>The trace collection trace should become the place, where variables
or values track their use state. The iterator should keep track of
the “next()” calls made to it, so it can tell which value to given in
that case.</p>
<p>That would solve the “iteration of constants” as a side effect and it
would allow to tell that they can be removed.</p>
<p>That would mean to go back in the tree and modify it long after.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="k">del</span> <span class="n">a</span>
</pre></div>
</div>
<p>It would be sweet if we could recognize that as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">side_effect</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">side_effect</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">del</span> <span class="n">a</span>
</pre></div>
</div>
<p>That trivially becomes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">del</span> <span class="n">a</span>
</pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">a</span></code> is examined at the end of scope, or due to another
assignment to the same variable, ending the trace, we would have to
consider of the <code class="docutils literal notranslate"><span class="pre">next</span></code> uses, and retrofit the information that they
had no effect.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">del</span> <span class="n">a</span>
</pre></div>
</div>
</li>
<li><p>Aliasing</p>
<p>Each time an assignment is made, an alias is created. A value may
have different names.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>If we fail to detect the aliasing nature, we will calculate <code class="docutils literal notranslate"><span class="pre">d</span></code>
wrongly. We may incref and decref values to trace it.</p>
<p>Aliasing is automatically traced already in SSA form. The <code class="docutils literal notranslate"><span class="pre">b</span></code> is
assigned to version of <code class="docutils literal notranslate"><span class="pre">a</span></code>. So, that should allow to replace it
with this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<span class="n">c</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Which then will be properly handled.</p>
</li>
<li><p>Tail recursion optimization.</p>
<p>Functions that return the results of calls, can be optimized. The
Stackless Python does it already.</p>
</li>
<li><p>Integrate with “upx” compression.</p>
<p>Calling “upx” on the created binaries, would be easy.</p>
</li>
<li><p>In-lining constant “exec” and “eval”.</p>
<p>It should be possible to re-formulate at least cases without “locals”
or “globals” given.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">exec</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;a+=b;c=1&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span>
</pre></div>
</div>
<p>Should become this here:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">a</span> <span class="o">+=</span> <span class="n">b</span>  <span class="c1">#</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># MaybeLocalVariables for everything except known local ones.</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span>
</pre></div>
</div>
<p>If this holds up, inlining <code class="docutils literal notranslate"><span class="pre">exec</span></code> should be relatively easy.</p>
</li>
<li><p>Original and overloaded built-ins</p>
<p>This is about making things visible in the node tree. In Nuitka
things that are not visible in the node tree tend to be wrong. We
already pushed around information to the node tree a lot.</p>
<p>Later versions, Nuitka will become able to determine it has to be the
original built-in at compile time, then a condition that checks will
be optimized away, together with the slow path. Or the other path, if
it won’t be. Then it will be optimized away, or if doubt exists, it
will be correct. That is the goal.</p>
<p>Right now, the change would mean to effectively disable all built-in
call optimization, which is why we don’t immediately do it.</p>
<p>Making the compatible version, will also require a full listing of
all built-ins, which is typing work merely, but not needed now. And a
way to stop built-in optimization from optimizing built-in calls that
it used in a wrap. Probably just some flag to indicate it when it
visits it to skip it. That’s for later.</p>
<p>But should we have that both, I figure, we could not raise a
<code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> error, but just do the correct thing, in all cases.
An earlier step may raise <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> error, when built-in
module values are written to, that we don’t support.</p>
</li>
</ul>
</section>
<section id="prongs-of-action">
<h2>Prongs of Action<a class="headerlink" href="#prongs-of-action" title="Permalink to this headline"></a></h2>
<p>In this chapter, we keep track of prongs of action currently ongoing.
This can get detailed and shows things we strive for.</p>
<section id="builtin-optimization">
<h3>Builtin optimization<a class="headerlink" href="#builtin-optimization" title="Permalink to this headline"></a></h3>
<p>Definitely want to get built-in names under full control, so that
variable references to module variables do not have a twofold role.
Currently they reference the module variable and also the potential
built-in as a fallback.</p>
<p>In terms of generated code size and complexity for modules with many
variables and uses of them that is horrible. But <code class="docutils literal notranslate"><span class="pre">some_var</span></code> (normally)
cannot be a built-in and therefore needs no code to check for that each
time.</p>
<p>This is also critical to getting to whole program optimization. Being
certain what is what there on module level, will enable more definitely
knowledge about data flows and module interfaces.</p>
</section>
<section id="class-creation-overhead-reduction">
<h3>Class Creation Overhead Reduction<a class="headerlink" href="#class-creation-overhead-reduction" title="Permalink to this headline"></a></h3>
<p>This is more of a meta goal. Some work for the metaclass has already
been done, but that is Python2 only currently. Being able to to decide
built-ins and to distinguish between global only variables, and
built-ins more clearly will help this a lot.</p>
<p>In the end, empty classes should be able to be statically converted to
calls to <code class="docutils literal notranslate"><span class="pre">type</span></code> with static dictionaries. The inlining of class
creation function is also needed for this, but on Python3 cannot happen
yet.</p>
</section>
<section id="memory-usage-at-compile-time">
<h3>Memory Usage at Compile Time<a class="headerlink" href="#memory-usage-at-compile-time" title="Permalink to this headline"></a></h3>
<p>We will need to store more and more information in the future. Getting
the tree to be tight shaped is therefore an effort, where we will be
spending time too.</p>
<p>The mix-ins prevent slots usage, so lets try and get rid of those. The
“children having” should become more simple and faster code. I am even
thinking of even generating code in the meta class, so it’s both optimal
and doesn’t need that mix-in any more. This is going to be ugly then.</p>
</section>
<section id="coverage-testing">
<h3>Coverage Testing<a class="headerlink" href="#coverage-testing" title="Permalink to this headline"></a></h3>
<p>And then there is coverage, it should be taken and merged from all
Python versions and OSes, but I never managed to merge between Windows
and Linux for unknown reasons.</p>
</section>
<section id="python3-performance">
<h3>Python3 Performance<a class="headerlink" href="#python3-performance" title="Permalink to this headline"></a></h3>
<p>The Python3 lock for thread state is making it slower by a lot. I have
only experimental code that just ignores the lock, but it likely only
works on Linux, and I wonder why there is that lock in the first place.</p>
<p>Ignoring the locks cannot be good. But what updates that thread state
pointer ever without a thread change, and is this what ABI flags are
about in this context, are there some that allow us to ignore the locks.</p>
<p>An important bit would be to use a thread state once acquired for as
much as possible, currently exception helpers do not accept it as an
argument, but that ought to become an option, that way saving and
restoring an exception will be much faster, not to mention checking and
dropping non interesting, or rewriting exceptions.</p>
</section>
<section id="caching-of-python-level-compilation">
<h3>Caching of Python level compilation<a class="headerlink" href="#caching-of-python-level-compilation" title="Permalink to this headline"></a></h3>
<p>While the C compilation result is already cached with ccache and friends
now, we need to also cover our bases and save the resulting node tree of
potential expensive optimization on the module level.</p>
</section>
</section>
<section id="updates-for-this-manual">
<h2>Updates for this Manual<a class="headerlink" href="#updates-for-this-manual" title="Permalink to this headline"></a></h2>
<p>This document is written in REST. That is an ASCII format which is
readable to human, but easily used to generate PDF or HTML documents.</p>
<p>You will find the current source under:
<a class="reference external" href="https://github.com/Nuitka/Nuitka/blob/develop/Developer_Manual.rst">https://github.com/Nuitka/Nuitka/blob/develop/Developer_Manual.rst</a></p>
<p>And the current PDF under: <a class="reference external" href="https://nuitka.net/doc/Developer_Manual.pdf">https://nuitka.net/doc/Developer_Manual.pdf</a></p>
</section>
</section>

<div class="section">
   
</div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Kay Hayen and Nuitka Contributors.</p>
  </div>

  
<div class='share-button-container'>
    <div class="socialbutton-wrapper">
        <a href="https://twitter.com/share?url=https://nuitka.net/doc/developer-manual.html&hashtags=nuitka" target="_blank">
            <div class="socialbutton twitter" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="/_static/icon-twitter.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="https://www.facebook.com/sharer.php?u=https://nuitka.net/doc/developer-manual.html&hashtag=%23nuitka"  target="_blank">
            <div class="socialbutton facebook" data-share-url="https://nuitka.net">
                <p class="icon">
                    <img src="/_static/icon-facebook.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>

        <a href="http://www.reddit.com/submit?url=https://nuitka.net/doc/developer-manual.html" target="_blank">
            <div class="socialbutton reddit">
                <p class="icon">
                    <img src="/_static/icon-reddit.png">
                </p>

                <p class="shares">share...</p>
            </div>
        </a>
    </div>
</div>



</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>